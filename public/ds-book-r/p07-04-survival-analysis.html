<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.353">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Khoa học dữ liệu với R - 49&nbsp; Survival Analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./p07-05-vintage-analysis.html" rel="next">
<link href="./p07-03-collaborative-filtering.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="site_libs/quarto-contrib/bookup_fonts_embed-0.0/fonts-download.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar docked">


<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./p07-03-collaborative-filtering.html">Các phương pháp phân tích khác</a></li><li class="breadcrumb-item"><a href="./p07-04-survival-analysis.html"><span class="chapter-number">49</span>&nbsp; <span class="chapter-title">Survival Analysis</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Khoa học dữ liệu với R</a> 
        <div class="sidebar-tools-main">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Khoa học dữ liệu và nghề phân tích dữ liệu</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Phân tích khám phá dữ liệu</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p02-01-gioi-thieu-co-ban-ve-r.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Giới thiệu cơ bản về R</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p02-70-xay-dung-bao-cao-voi-rmarkdown.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Xây dựng báo cáo với Rmarkdown</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p02-02-bien-doi-du-lieu-dplyr.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Ngữ pháp của biến đổi dữ liệu với DPLYR</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p02-03-phan-ra-va-xoay-chieu-du-lieu.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Làm sạch và biến đổi dữ liệu nâng cao</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p02-04-ngu-phap-bieu-do-ggplot2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Ngữ pháp của biểu đồ với <code>ggplot2</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p02-05-cac-chi-so-thong-ke.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Các chỉ số thống kê mô tả cơ bản</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p02-06-lap-trinh-ham.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Lập trình hàm</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p02-07-lap-trinh-ham-voi-purrr.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Lập trình chức năng hàm với purrr</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p02-08-bien-doi-du-lieu-text.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Biến đổi dữ liệu text</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p02-11-quan-ly-nhieu-mo-hinh.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Quản lý kết quả phân tích từ nhiều mô hình</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p02-16-power-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Power analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p02-20-sampling-methods.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Phương pháp ước lượng tham số thông qua lấy mẫu</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p02-50-datatable.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Biến đổi dữ liệu với <code>data.table</code></span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p02-60-thu-thap-du-lieu-tu-website.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Thu thập dữ liệu từ website</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p02-99-meo-trong-r.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Các mẹo trong R</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
 <span class="menu-text">Supervised Learning</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p03-01-nguyen-ly-du-bao.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Giới thiệu về học máy</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p03-02-mo-hinh-ols.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Mô hình hồi quy tuyến tính</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p03-03-logistic-regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Mô hình hồi quy logistic</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p03-04-decision-tree.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Cây quyết định</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p03-05-bagging-boosting.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Bagging, RandomForest và Boosting</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p03-07-xay-dung-mo-hinh-voi-h2o.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Xây dựng mô hình với H2O</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p03-08-xgboost.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">XGBoost &amp; LightGBM</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p03-10-knn.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">K nearest neighbors</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p03-11-svm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">Support Vector Machine</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p03-15-nonlinear.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">Mô hình phi tuyến tính</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p03-17-regularization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">Lựa chọn biến &amp; regularization</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p03-20-feature-engineering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">Feature Engineering</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p03-70-tidymodels.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">Tidymodels</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p03-40-interpretable-ml.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">30</span>&nbsp; <span class="chapter-title">Giải thích mô hình học máy</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p03-30-credit-scoring.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">31</span>&nbsp; <span class="chapter-title">Credit Scoring</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p03-50-chat-luong-mo-hinh.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">32</span>&nbsp; <span class="chapter-title">Chất lượng mô hình</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p03-75-mlops-vetiver.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">33</span>&nbsp; <span class="chapter-title">MLOPs với <code>vetiver</code></span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
 <span class="menu-text">Unsupervised Learning</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p04-01-unsupervised-learning.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">34</span>&nbsp; <span class="chapter-title">Unsupervised learning</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p04-02-hierarchical-clustering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">35</span>&nbsp; <span class="chapter-title">Hierachical clustering</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p04-03-kmeans.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">36</span>&nbsp; <span class="chapter-title">k-means</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p04-04-basket-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">37</span>&nbsp; <span class="chapter-title">Phân tích giỏ hàng</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p04-05-pca.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">38</span>&nbsp; <span class="chapter-title">Principal component analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p04-06-factor-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">39</span>&nbsp; <span class="chapter-title">Phân tích nhân tố ẩn (factor analysis)</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">Chuỗi thời gian</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p05-01-chuoi-thoi-gian.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">40</span>&nbsp; <span class="chapter-title">Giới thiệu về chuỗi thời gian</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p05-02-arima.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">41</span>&nbsp; <span class="chapter-title">Mô hình ARIMA</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p05-07-du-bao-ts-voi-timetk.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">42</span>&nbsp; <span class="chapter-title">Dự báo chuỗi thời gian với học máy</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p05-08-abnomaly-detection.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">43</span>&nbsp; <span class="chapter-title">Abnomaly detection trong times series</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
 <span class="menu-text">Xử lý ngôn ngữ tự nhiên</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p06-01-nlp-co-ban.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">44</span>&nbsp; <span class="chapter-title">Xử lý ngôn ngữ tự nhiên cơ bản</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p06-04-text-classification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">45</span>&nbsp; <span class="chapter-title">Phân loại text</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p06-07-nlp-api.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">46</span>&nbsp; <span class="chapter-title">Sử dụng API từ các dịch vụ đám mây</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p06-10-ocr-tesseract.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">47</span>&nbsp; <span class="chapter-title">OCR với <code>tesseract</code></span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
 <span class="menu-text">Các phương pháp phân tích khác</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p07-03-collaborative-filtering.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">48</span>&nbsp; <span class="chapter-title">Collaborative Filtering</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p07-04-survival-analysis.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">49</span>&nbsp; <span class="chapter-title">Survival Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p07-05-vintage-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">50</span>&nbsp; <span class="chapter-title">Vintage analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p07-07-spatial-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">51</span>&nbsp; <span class="chapter-title">Spatial data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p07-08-anomaly-detection.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">52</span>&nbsp; <span class="chapter-title">Abnomaly detection</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p07-15-quantile-regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">53</span>&nbsp; <span class="chapter-title">Hồi quy phân vị</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p07-16-retention-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">54</span>&nbsp; <span class="chapter-title">Retention analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p07-20-network-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">55</span>&nbsp; <span class="chapter-title">Network analysis</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true">
 <span class="menu-text">Cloud Computing</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p10-01-cai-dat-rstudio-server-tren-amazon.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">56</span>&nbsp; <span class="chapter-title">Cài đặt server RStudio trên Amazon</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p10-03-web-service-azure.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">57</span>&nbsp; <span class="chapter-title">Xây dựng web service với Azure</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p10-09-apis-voi-plumber.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">58</span>&nbsp; <span class="chapter-title">API với Plumber</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p07-10-shiny.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">59</span>&nbsp; <span class="chapter-title">Shiny apps</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p10-02-deploy-shiny-app-aws.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">60</span>&nbsp; <span class="chapter-title">Deploy Shiny Apps lên AWS</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p07-30-python-voi-r.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">61</span>&nbsp; <span class="chapter-title">Sử dụng Python với R</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" aria-expanded="true">
 <span class="menu-text">Kiến thức bổ trợ</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-8" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p11-01-git.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">62</span>&nbsp; <span class="chapter-title">Sử dụng GIT</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p11-02-cmd.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">63</span>&nbsp; <span class="chapter-title">CMD và Bash</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p11-03-docker.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">64</span>&nbsp; <span class="chapter-title">Sử dụng docker</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p11-04-apis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">65</span>&nbsp; <span class="chapter-title">API</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p11-90-other.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">66</span>&nbsp; <span class="chapter-title">Các tricks khác</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" aria-expanded="true">
 <span class="menu-text">Case studies</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-9" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./p13-01-casestudy-truc-quan-hoa.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">67</span>&nbsp; <span class="chapter-title">Trực quan hóa dữ liệu</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Mục lục</h2>
   
  <ul>
  <li><a href="#giới-thiệu" id="toc-giới-thiệu" class="nav-link active" data-scroll-target="#giới-thiệu"><span class="header-section-number">49.1</span> Giới thiệu</a></li>
  <li><a href="#phương-pháp-phi-tham-số" id="toc-phương-pháp-phi-tham-số" class="nav-link" data-scroll-target="#phương-pháp-phi-tham-số"><span class="header-section-number">49.2</span> Phương pháp phi tham số</a>
  <ul>
  <li><a href="#ứng-dụng" id="toc-ứng-dụng" class="nav-link" data-scroll-target="#ứng-dụng"><span class="header-section-number">49.2.1</span> Ứng dụng</a></li>
  <li><a href="#thực-hành" id="toc-thực-hành" class="nav-link" data-scroll-target="#thực-hành"><span class="header-section-number">49.2.2</span> Thực hành</a>
  <ul class="collapse">
  <li><a href="#survival-function-theo-giới-tính" id="toc-survival-function-theo-giới-tính" class="nav-link" data-scroll-target="#survival-function-theo-giới-tính"><span class="header-section-number">49.2.2.1</span> Survival function theo giới tính</a></li>
  <li><a href="#so-sánh-hàm-sống-sót-của-2-nhóm" id="toc-so-sánh-hàm-sống-sót-của-2-nhóm" class="nav-link" data-scroll-target="#so-sánh-hàm-sống-sót-của-2-nhóm"><span class="header-section-number">49.2.2.2</span> So sánh hàm sống sót của 2 nhóm</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#phương-pháp-tham-số" id="toc-phương-pháp-tham-số" class="nav-link" data-scroll-target="#phương-pháp-tham-số"><span class="header-section-number">49.3</span> Phương pháp tham số</a></li>
  <li><a href="#random-forest-với-phân-tích-sống-còn" id="toc-random-forest-với-phân-tích-sống-còn" class="nav-link" data-scroll-target="#random-forest-với-phân-tích-sống-còn"><span class="header-section-number">49.4</span> Random Forest với phân tích sống còn</a>
  <ul>
  <li><a href="#xây-dựng-mô-hình-đơn-giản" id="toc-xây-dựng-mô-hình-đơn-giản" class="nav-link" data-scroll-target="#xây-dựng-mô-hình-đơn-giản"><span class="header-section-number">49.4.1</span> Xây dựng mô hình đơn giản</a></li>
  <li><a href="#dự-báo-theo-từng-quan-sát" id="toc-dự-báo-theo-từng-quan-sát" class="nav-link" data-scroll-target="#dự-báo-theo-từng-quan-sát"><span class="header-section-number">49.4.2</span> Dự báo theo từng quan sát</a></li>
  </ul></li>
  <li><a href="#tài-liệu-tham-khảo" id="toc-tài-liệu-tham-khảo" class="nav-link" data-scroll-target="#tài-liệu-tham-khảo"><span class="header-section-number">49.5</span> Tài liệu tham khảo</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">49</span>&nbsp; <span class="chapter-title">Survival Analysis</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="giới-thiệu" class="level2" data-number="49.1">
<h2 data-number="49.1" class="anchored" data-anchor-id="giới-thiệu"><span class="header-section-number">49.1</span> Giới thiệu</h2>
<p>Phân tích sống còn (<code>survival analysis</code>) là phương pháp phân tích mỗi quan hệ giữa cá biến đầu vào với thời gian xảy ra một sự kiện xác định trước. Phương pháp này còn được gọi là phân tích về thời gian xảy ra sự kiện (<code>time to event analysis</code>). Phương pháp phân tích sống còn được áp dụng sớm ở trong lĩnh vực y tế khi đánh giá và phân tích thời gian phát bệnh của bệnh nhân - ví dụ thời gian chuyển sang AIDS của bệnh nhân nhiễm HIV. Tuy nhiên, khi mở rộng sang lĩnh vực phân tích khác, phương pháp này cũng có rất nhiều ứng dụng như:</p>
<ul>
<li>Phân tích thời gian khách hàng ngưng sử dụng dịch vụ kể từ khi xảy ra 1 sự kiện</li>
<li>Phân tích thời gian nhân viên nghỉ việc kể từ khi <em>onboard</em></li>
</ul>
<p>Không giống với các phương pháp khác, phân tích sống còn có cá đặc điểm sau.</p>
<ul>
<li>Biến phụ thuộc là biến <strong>thời gian</strong></li>
<li>Dữ liệu có đặc trưng <strong>censor</strong> - là sự kiện (<code>event</code>) xảy ra ngoài khoảng thời gian quan sát.</li>
</ul>
<hr>
<p>Có hai loại <code>censor</code>:</p>
<ul>
<li><strong>Right censoring</strong>: là trường hợp sự kiện diễn ra sau khoảng thời gian phân tích - hay nói cách khác, sự kiện <em>không</em> diễn ra trong khoảng thời gian quan sát.</li>
</ul>
<p>Ví dụ, nghiên cứu 100 bệnh nhân HIV trong khoảng thời gian 1 năm. Trong thời gian đó, có 10 bệnh nhân chuyển qua AIDS, 90 bệnh nhân còn lại chưa qua AIDS trong một năm đó nhưng ta đều biết rằng họ <em>sẽ</em> chuyển thành AIDS. Dữ liệu kiểu vậy được gọi là <em>right censoring</em>. Thời gian bệnh nhân chuyển qua giai đoạn AIDS nằm ngoài khoảng thời gian quan sát.</p>
<p><img src="Images/p07-04-censor-data.jpeg" class="img-fluid"></p>
<ul>
<li><strong>Left censoring</strong>: Thời gian diễn ra sự kiện trước khoảng thời gian diễn ra quan sát. Ví dụ, nghiên cứu 100 bệnh nhân nhập viên do nghi ngờ bị lao, 40% dương tính với lao tại thời điểm nhập viện nhưng không biết chính xác thời gian.</li>
</ul>
<hr>
<p>Đối với các vấn đề như trên, việc dự báo một quan sát (cá nhân) có trải qua một sự kiện hay không là điều thứ yếu. Phân tích sống còn tập trung trả lời 2 câu hỏi chính:</p>
<ul>
<li>Khi nào sự kiện (<code>event</code>) sẽ diễn ra</li>
<li>Yếu tố nào ảnh hưởng đến thời gian xảy ra sự kiện.</li>
</ul>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Lưu ý</strong></p>
<ul>
<li>Đối với survival analysis, ta thường không có đủ dữ liệu về đối tượng. VD: Trong 100 bệnh nhân tham gia, có bệnh nhân vào nghiên cứu từ tháng 6, tức là khi kết thúc nghiên cứu, bệnh nhân đó chỉ có dữ liệu 6 tháng</li>
<li>Nếu ta có đầy đủ dữ liệu vè thời gian khách hàng/bệnh nhân từ khi quan sát đến khi xảy ra sự kiện, ta có thể dùng regression thông thường</li>
</ul>
</div>
</div>
</section>
<section id="phương-pháp-phi-tham-số" class="level2" data-number="49.2">
<h2 data-number="49.2" class="anchored" data-anchor-id="phương-pháp-phi-tham-số"><span class="header-section-number">49.2</span> Phương pháp phi tham số</h2>
<p>Gọi <span class="math inline">\(T\)</span> là thời gian xảy ra sự kiện từ khi quan sát, với <span class="math inline">\(cdf\)</span> <span class="math inline">\(F(.)\)</span> và <span class="math inline">\(pdf f(.)\)</span>, ta có:</p>
<p><span class="math inline">\(F(t) = P(T \leq t) = \int_0^tf(x)dx\)</span> và <span class="math inline">\(f(t) = \frac{dF(t)}{dt}\)</span></p>
<p><span class="math display">\[\begin{align}
f(t)&amp;=\lim_{dt \to 0^+} \frac{F(t + dt) - F(t)}{dt} \\
&amp;=\lim_{dt \to 0^+} \frac{P(t &lt; t \leq t + dt)}{dt}
\end{align}
\tag{1}
\]</span></p>
<p><strong>Hàm sống sót - Survival function S(t)</strong>:</p>
<p><span class="math display">\[S(t) = P(T &gt; t) = 1 - F(t) = \int_t^{\infty}f(x)dx\tag{2}\]</span></p>
<p>Với t = 0, S(t) = 1. Với <span class="math inline">\(t \to \infty\)</span>, <span class="math inline">\(S(t) \to 0\)</span></p>
<p>Mặt khác, ta có: <span class="math inline">\(F(x) = 1 - S(x) \tag{3}\)</span></p>
<p>Đạo hàm hai vế của phương trình trên, ta được:</p>
<p><span class="math display">\[f(t) = -\frac{dS}{dt}\tag{3}\]</span></p>
<p><strong>Hàm nguy cơ</strong> (<span class="math inline">\(h(t)\)</span> hay <span class="math inline">\(\lambda(t)\)</span> (<code>hazard function</code>) cho ta biết xác suất xảy ra sự kiện tại ngay thời điểm t.</p>
<p><span class="math display">\[\begin{align}
h(t) &amp;= \lim_{dt \to 0}\frac{(t &lt; T \leq t + dt | T &gt; t)}{dt} \\
&amp;=\lim_{dt \to 0}\frac{F(t+dt)}{S(t)dt}\\
&amp;=\frac{f(t)}{S(t)} =
\frac{-dS(t)/dt}{S(t)} = -\frac{dlog(S(t))}{dt}
\end{align}
\tag{4}
\]</span></p>
<p>Hàm nguy cơ tích lũy (<code>cumulative hazard function</code>):</p>
<p><span class="math display">\[H(t) = \int_0^th(u)du = -log(S(t)) \tag{5}\]</span></p>
<p>Từ đó ta có:</p>
<p><span class="math display">\[S(t) = e^{-H(t)} = exp(-H(t)) \tag{6}\]</span></p>
<p><strong>Lưu ý</strong>:</p>
<ul>
<li>Hàm survival <span class="math inline">\(S(t)\)</span> cho ta biết xác suất tích lũy sống qua thời điểm xảy ra sự kiện T</li>
<li>Hàm <span class="math inline">\(F(t)\)</span> cho ta biết xác suất tích lũy <strong>chỉ sống đến</strong> thời điểm T</li>
<li>Hàm nguy cơ <span class="math inline">\(h_t\)</span> hay <span class="math inline">\(\lambda_t\)</span> cho ta biết xác suất xảy ra sự kiện <em>ngay</em> tại thời điểm T.</li>
</ul>
<p>VD: Xác suất người chết ở tuối 100 rất thấp vì rất ít người sống đến 100 (F(t)). Tuy nhiên, xác suất người chết ở tuổi 100 với điều kiện người đó ĐÃ bước sang tuổi 100 sẽ cao hơn rất nhiều</p>
<p>Xác suất xảy ra hai sự kiện A1 và A2 đồng thời như sau:</p>
<p><span class="math display">\[P(A_1 \cap A_2) = P(A_2|A_1)*P(A_1)\]</span></p>
<p>Do đó, hàm survival (S) cho ta biết xác suất các đối tượng <strong>sống sót</strong> qua thời gian t. Bản chất của hàm Survival là xác suất có điều kiện như sau:</p>
<p><span class="math display">\[P(\text{sống sót qua t + 1}) = P(\text{sống sót qua t}) \times P(\text{sống sót qua t+1} | \text{sống sót qua t})\]</span></p>
<p><span class="math display">\[\hat{S}_t=\prod_{k=1}^{t}{p_k}\]</span></p>
<p><span class="math display">\[\hat{p_i} = 1 - \hat{q_i} =
1 - \frac{d_i}{n_i} =
\frac{n_i-d_i}{n_i}\]</span></p>
<p>Trong đó:</p>
<ul>
<li><span class="math inline">\(\hat{p_i}\)</span> là xác suất sống sót sau thời điểm i</li>
<li><span class="math inline">\(n_i\)</span> là số lượng quan sát tại khung thời gian i</li>
<li><span class="math inline">\(d_i\)</span> là số lượng trải qua sự kiện tại thời điểm i</li>
<li><span class="math inline">\(\hat{q_i}\)</span> là xác suất các đối tượng trải qua sự kiện tại thời điểm i</li>
</ul>
<hr>
<p><strong>Ví dụ</strong>: Có 11 bệnh nhân trong nghiên cứu, kết quả khảo sát như sau:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>week <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">9</span>, <span class="dv">13</span>, <span class="dv">13</span>, <span class="dv">18</span>, <span class="dv">23</span>, <span class="dv">28</span>, <span class="dv">31</span>, <span class="dv">34</span>, <span class="dv">45</span>, <span class="dv">48</span>, <span class="dv">161</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>status <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>survtime <span class="ot">&lt;-</span> <span class="fu">Surv</span>(week, status <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>survtime</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code> [1]   9   13   13+  18   23   28+  31   34   45+  48  161+</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(week),</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  week, status, <span class="at">survival =</span> survtime</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">type =</span> <span class="fu">case_when</span>(</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    status <span class="sc">==</span> <span class="dv">1</span> <span class="sc">~</span> <span class="st">"event"</span>,</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">"censored"</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  )) </span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span>  knitr<span class="sc">::</span><span class="fu">kable</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: right;">id</th>
<th style="text-align: right;">week</th>
<th style="text-align: right;">status</th>
<th style="text-align: right;">survival</th>
<th style="text-align: left;">type</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">9</td>
<td style="text-align: left;">event</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: right;">13</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">13</td>
<td style="text-align: left;">event</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: right;">13</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">13+</td>
<td style="text-align: left;">censored</td>
</tr>
<tr class="even">
<td style="text-align: right;">4</td>
<td style="text-align: right;">18</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">18</td>
<td style="text-align: left;">event</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">23</td>
<td style="text-align: left;">event</td>
</tr>
<tr class="even">
<td style="text-align: right;">6</td>
<td style="text-align: right;">28</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">28+</td>
<td style="text-align: left;">censored</td>
</tr>
<tr class="odd">
<td style="text-align: right;">7</td>
<td style="text-align: right;">31</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">31</td>
<td style="text-align: left;">event</td>
</tr>
<tr class="even">
<td style="text-align: right;">8</td>
<td style="text-align: right;">34</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">34</td>
<td style="text-align: left;">event</td>
</tr>
<tr class="odd">
<td style="text-align: right;">9</td>
<td style="text-align: right;">45</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">45+</td>
<td style="text-align: left;">censored</td>
</tr>
<tr class="even">
<td style="text-align: right;">10</td>
<td style="text-align: right;">48</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">48</td>
<td style="text-align: left;">event</td>
</tr>
<tr class="odd">
<td style="text-align: right;">11</td>
<td style="text-align: right;">161</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">161+</td>
<td style="text-align: left;">censored</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Với tập dữ liệu trên, ta có thể nhận định như sau:</p>
<ul>
<li>Bệnh nhân số 3, 6, 9 và 11 trải qua sự kiện (<span class="math inline">\(status = 1\)</span>)</li>
<li>Các bệnh nhân còn lại không bị chuyển bệnh - các dữ liệu này được gọi là <code>censored</code>, có đánh dấu <code>+</code> ở biến thời gian</li>
</ul>
<p>Tính toán kết quả hàm sống sót lũy kế tại từng mốc thời gian như sau</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true" aria-current="page">Tính toán thủ công</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">Tính toán tự động</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<p>Tính toán các chỉ số của hàm sống sót lũy kế như sau:</p>
<ul>
<li><span class="math inline">\(\widehat{S}_0 = 1\)</span></li>
<li><span class="math inline">\(\widehat{S}_9 = \widehat{S}_0 \times \frac{11-1}{11} = 0.909\)</span></li>
<li><span class="math inline">\(\widehat{S}_{13} = \widehat{S}_9 \times \frac{10-1}{10} = 0.818\)</span></li>
<li><span class="math inline">\(\widehat{S}_{13+} = \widehat{S}_{13} \times \frac{9-0}{9} = 0.818\)</span></li>
<li><span class="math inline">\(\widehat{S}_{18} = \widehat{S}_{13} \times \frac{8-1}{8} = 0.716\)</span></li>
<li><span class="math inline">\(\widehat{S}_{23} = \widehat{S}_{18} \times \frac{7-1}{7} = 0.614\)</span></li>
<li><span class="math inline">\(\widehat{S}_{28+} = \widehat{S}_{23} \times \frac{6-0}{6} = 0.614\)</span></li>
<li><span class="math inline">\(\widehat{S}_{31} = \widehat{S}_{23} \times \frac{5-1}{5} = 0.491\)</span></li>
<li><span class="math inline">\(\widehat{S}_{34} = \widehat{S}_{31} \times \frac{4-1}{4} = 0.368\)</span></li>
<li><span class="math inline">\(\widehat{S}_{45+} = \widehat{S}_{34} \times \frac{3-0}{3} = 0.368\)</span></li>
<li><span class="math inline">\(\widehat{S}_{48} = \widehat{S}_{34} \times \frac{2-1}{2} = 0.184\)</span></li>
<li><span class="math inline">\(\widehat{S}_{161+} = \widehat{S}_{48} \times \frac{1-0}{1} = 0.184\)</span></li>
</ul>
<p>Sau thời điểm <span class="math inline">\(t = 48\)</span>, không có sự kiện nào xảy ra, ta không thể ước lượng <span class="math inline">\(S(t)\)</span> được nữa, đường <span class="math inline">\(\hat{S}(t)\)</span> sau thời điểm này được gọi là `defective survival</p>
<hr>
<p><strong>Tính toán hàm nguy cơ tại mỗi thời điểm</strong></p>
<ul>
<li><span class="math inline">\(\hat{h}_{23} = \frac{1}{7}\)</span></li>
<li><span class="math inline">\(\hat{h}_{28} = \hat{h}_{30}=\frac{1}{7 * (31-23)} = \frac{1}{56}\)</span></li>
</ul>
<p><strong>Hàm nguy cơ tích lũy</strong>: <span class="math inline">\(\hat{H}(t) = -log(\hat{S}(t))\)</span></p>
<p>Với ví dụ trên, ta có:</p>
<ul>
<li><span class="math inline">\(\hat{H}_{26} = -log(\hat{S}_{26}) = -log(0.614) = 0.488\)</span> <span class="math inline">\((\hat{S}_{26} = \hat{S}_{23})\)</span></li>
<li><span class="math inline">\(\tilde{H}_{26} = \frac{1}{11} + \frac{1}{10} + \frac{1}{8} + \frac{1}{7} = 0.4588\)</span></li>
</ul>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">survfit</span>(<span class="fu">Surv</span>(week, status <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> df) <span class="sc">%&gt;%</span> summary</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Call: survfit(formula = Surv(week, status == 1) ~ 1, data = df)

 time n.risk n.event survival std.err lower 95% CI upper 95% CI
    9     11       1    0.909  0.0867       0.7541        1.000
   13     10       1    0.818  0.1163       0.6192        1.000
   18      8       1    0.716  0.1397       0.4884        1.000
   23      7       1    0.614  0.1526       0.3769        0.999
   31      5       1    0.491  0.1642       0.2549        0.946
   34      4       1    0.368  0.1627       0.1549        0.875
   48      2       1    0.184  0.1535       0.0359        0.944</code></pre>
</div>
</div>
<p>Bảng tổng hợp tính toán kết quả hàm sống sót tích lũy - kết quả tương tự như việc tính toán thủ công. Tuy nhiên, do tại cùng 1 thời điểm, có thể có cả trường hợp dữ liệu censored &amp; uncensored (thời điểm <span class="math inline">\(t=13\)</span>), nên bảng kết quả này có gây khó hiểu. Bảng kết quả trên có thể hiểu như sau:</p>
<ul>
<li>Thời điểm <span class="math inline">\(t=9\)</span>, có 11 quan sát, có 1 người chuyển bệnh (<code>n.event = 1</code>), giá trị hàm sống sót lũy kế là <span class="math inline">\(\frac{11-1}{11} = 0.909\)</span></li>
<li>Thời điểm <span class="math inline">\(t=13\)</span>, có 10 quan sát, có 1 người chuyển bệnh (<code>n.event = 1</code>), giá trị hàm sống sót lũy kế là <span class="math inline">\(\frac{10-1}{10} \times \widehat{S}_9 = 0.818\)</span></li>
<li>Thời điểm <span class="math inline">\(t=18\)</span>, có 8 quan sát, có 1 người chuyển bệnh (<code>n.event = 1</code>), giá trị hàm sống sót lũy kế là <span class="math inline">\(\frac{8-1}{8} \times \widehat{S}_{13} = 0.716\)</span></li>
</ul>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Lưu ý
</div>
</div>
<div class="callout-body-container callout-body">
<p>Thời điểm <span class="math inline">\(t=18\)</span>, <span class="math inline">\(\text{n.risk} = 8\)</span>. Ta rất dễ bị nhầm lẫn <span class="math inline">\(\text{n.risk}_{t=18} = \text{n.risk}_{t=13} - \text{n.event}_{t=13} = 10-1 = 9\)</span></p>
<p>Nguyên nhân là do dữ liệu tại <span class="math inline">\(t=13\)</span> xảy ra đồng thời các quan sát xảy ra và không xảy ra sự kiện.</p>
</div>
</div>
</div>
</div>
</div>
<hr>
<p>Cách ước lượng trên được gọi là ước lượng <em>Kaplan-Meier</em> hay <em>product limit estimate</em>. Đường ước lượng Kaplan-Meier chỉ dốc xuống khi có sự kiện xảy ra function`</p>
<section id="ứng-dụng" class="level3" data-number="49.2.1">
<h3 data-number="49.2.1" class="anchored" data-anchor-id="ứng-dụng"><span class="header-section-number">49.2.1</span> Ứng dụng</h3>
<p>Trong survival analysis, các sự kiện được gọi là death, nhưng có thể có rất nhiều cách tiếp cận khác nhau như:</p>
<ul>
<li>Thời gian mua sản phẩm thứ 2 sau sản phẩm thứ nhất</li>
<li>Thời gian KH rời bỏ doanh nghiệp sau khi phàn nàn về dịch vụ</li>
<li>Thời gian nhân viên nghỉ việc</li>
</ul>
</section>
<section id="thực-hành" class="level3" data-number="49.2.2">
<h3 data-number="49.2.2" class="anchored" data-anchor-id="thực-hành"><span class="header-section-number">49.2.2</span> Thực hành</h3>
<p>Để thực hành, ta sử dụng dữ liệu <code>melanom</code> - có thông tin về bệnh nhân có khối u ác tính.</p>
<ul>
<li><code>no</code>: ID của mỗi người bệnh</li>
<li><code>status</code>: Trạng thái của bệnh nhân - 1 là tử vong</li>
<li><code>days</code>: Số ngày kể từ khi quan sát</li>
<li><code>ulc</code>: Trạng thái của khối u</li>
<li><code>thick</code>: Kích cỡ của khối u (mm)</li>
<li><code>sex</code>: Giới tính - 1 là nữ, 2 là nam</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(survival)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(KMsurv)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggfortify)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ISwR)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_minimal</span>())</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(melanom)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>melanom <span class="sc">%&gt;%</span> head</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   no status days ulc thick sex
1 789      3   10   1   676   2
2  13      3   30   2    65   2
3  97      2   35   2   134   2
4  16      3   99   2   290   1
5  21      1  185   1  1208   2
6 469      1  204   1   484   2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Tạo status == 1 là death</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>msurv <span class="ot">&lt;-</span> <span class="fu">with</span>(melanom, <span class="fu">Surv</span>(days, status <span class="sc">==</span> <span class="dv">1</span>))</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co">#Lưu ý: Các status là 2 và 3 được coi như uncensored</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>melanom <span class="sc">%&gt;%</span> head</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   no status days ulc thick sex
1 789      3   10   1   676   2
2  13      3   30   2    65   2
3  97      2   35   2   134   2
4  16      3   99   2   290   1
5  21      1  185   1  1208   2
6 469      1  204   1   484   2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>msurv <span class="sc">%&gt;%</span> head</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1]  10+  30+  35+  99+ 185  204 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Phân tích dữ liệu</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>mfit <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(days, status <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> melanom)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>mfit <span class="sc">%&gt;%</span> summary</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call: survfit(formula = Surv(days, status == 1) ~ 1, data = melanom)

 time n.risk n.event survival std.err lower 95% CI upper 95% CI
  185    201       1    0.995 0.00496        0.985        1.000
  204    200       1    0.990 0.00700        0.976        1.000
  210    199       1    0.985 0.00855        0.968        1.000
  232    198       1    0.980 0.00985        0.961        1.000
  279    196       1    0.975 0.01100        0.954        0.997
  295    195       1    0.970 0.01202        0.947        0.994
  386    193       1    0.965 0.01297        0.940        0.991
  426    192       1    0.960 0.01384        0.933        0.988
  469    191       1    0.955 0.01465        0.927        0.984
  529    189       1    0.950 0.01542        0.920        0.981
  621    188       1    0.945 0.01615        0.914        0.977
  629    187       1    0.940 0.01683        0.907        0.973
  659    186       1    0.935 0.01748        0.901        0.970
  667    185       1    0.930 0.01811        0.895        0.966
  718    184       1    0.925 0.01870        0.889        0.962
  752    183       1    0.920 0.01927        0.883        0.958
  779    182       1    0.915 0.01981        0.877        0.954
  793    181       1    0.910 0.02034        0.871        0.950
  817    180       1    0.904 0.02084        0.865        0.946
  833    178       1    0.899 0.02134        0.859        0.942
  858    177       1    0.894 0.02181        0.853        0.938
  869    176       1    0.889 0.02227        0.847        0.934
  872    175       1    0.884 0.02272        0.841        0.930
  967    174       1    0.879 0.02315        0.835        0.926
  977    173       1    0.874 0.02357        0.829        0.921
  982    172       1    0.869 0.02397        0.823        0.917
 1041    171       1    0.864 0.02436        0.817        0.913
 1055    170       1    0.859 0.02474        0.812        0.909
 1062    169       1    0.854 0.02511        0.806        0.904
 1075    168       1    0.849 0.02547        0.800        0.900
 1156    167       1    0.844 0.02582        0.794        0.896
 1228    166       1    0.838 0.02616        0.789        0.891
 1252    165       1    0.833 0.02649        0.783        0.887
 1271    164       1    0.828 0.02681        0.777        0.883
 1312    163       1    0.823 0.02713        0.772        0.878
 1435    161       1    0.818 0.02744        0.766        0.874
 1506    159       1    0.813 0.02774        0.760        0.869
 1516    155       1    0.808 0.02805        0.755        0.865
 1548    152       1    0.802 0.02837        0.749        0.860
 1560    150       1    0.797 0.02868        0.743        0.855
 1584    148       1    0.792 0.02899        0.737        0.851
 1621    146       1    0.786 0.02929        0.731        0.846
 1667    137       1    0.780 0.02963        0.725        0.841
 1690    134       1    0.775 0.02998        0.718        0.836
 1726    131       1    0.769 0.03033        0.712        0.831
 1933    110       1    0.762 0.03085        0.704        0.825
 2061     95       1    0.754 0.03155        0.694        0.818
 2062     94       1    0.746 0.03221        0.685        0.812
 2103     90       1    0.737 0.03290        0.676        0.805
 2108     88       1    0.729 0.03358        0.666        0.798
 2256     80       1    0.720 0.03438        0.656        0.791
 2388     75       1    0.710 0.03523        0.645        0.783
 2467     69       1    0.700 0.03619        0.633        0.775
 2565     63       1    0.689 0.03729        0.620        0.766
 2782     57       1    0.677 0.03854        0.605        0.757
 3042     52       1    0.664 0.03994        0.590        0.747
 3338     35       1    0.645 0.04307        0.566        0.735</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>mfit <span class="sc">%&gt;%</span> </span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  autoplot <span class="sc">+</span> </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">6000</span>, <span class="dv">1000</span>)) <span class="sc">+</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Survival function"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="p07-04-survival-analysis_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<section id="survival-function-theo-giới-tính" class="level4" data-number="49.2.2.1">
<h4 data-number="49.2.2.1" class="anchored" data-anchor-id="survival-function-theo-giới-tính"><span class="header-section-number">49.2.2.1</span> Survival function theo giới tính</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>mfit.bysex <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(days, status <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">~</span> sex, </span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>                      <span class="at">data =</span> melanom)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>mfit.bysex</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call: survfit(formula = Surv(days, status == 1) ~ sex, data = melanom)

        n events median 0.95LCL 0.95UCL
sex=1 126     28     NA      NA      NA
sex=2  79     29     NA    2388      NA</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>mfit.bysex <span class="sc">%&gt;%</span> </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>() <span class="sc">+</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_brewer</span>(<span class="at">palette =</span> <span class="st">"Set1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="p07-04-survival-analysis_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>mfit.bysex <span class="sc">%&gt;%</span> </span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">autoplot</span>(<span class="at">fun =</span> <span class="st">"cloglog"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="p07-04-survival-analysis_files/figure-html/unnamed-chunk-5-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p><strong>Lưu ý</strong>: Các điểm * trên đồ thị là các sự kiện xảy ra thực tế</p>
</section>
<section id="so-sánh-hàm-sống-sót-của-2-nhóm" class="level4" data-number="49.2.2.2">
<h4 data-number="49.2.2.2" class="anchored" data-anchor-id="so-sánh-hàm-sống-sót-của-2-nhóm"><span class="header-section-number">49.2.2.2</span> So sánh hàm sống sót của 2 nhóm</h4>
<ul>
<li><span class="math inline">\(H_0\)</span>: <span class="math inline">\(S_1(.) = S_2(.)\)</span></li>
<li><span class="math inline">\(H_1\)</span>: <span class="math inline">\(S_1(.) \neq S_2(.)\)</span></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">survdiff</span>(<span class="fu">Surv</span>(time,status) <span class="sc">~</span> x, <span class="at">data=</span>aml)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
survdiff(formula = Surv(time, status) ~ x, data = aml)

                 N Observed Expected (O-E)^2/E (O-E)^2/V
x=Maintained    11        7    10.69      1.27       3.4
x=Nonmaintained 12       11     7.31      1.86       3.4

 Chisq= 3.4  on 1 degrees of freedom, p= 0.07 </code></pre>
</div>
</div>
<p>Với p &lt; 0.05, ta giữ lại <span class="math inline">\(H_0\)</span></p>
</section>
</section>
</section>
<section id="phương-pháp-tham-số" class="level2" data-number="49.3">
<h2 data-number="49.3" class="anchored" data-anchor-id="phương-pháp-tham-số"><span class="header-section-number">49.3</span> Phương pháp tham số</h2>
<p>Với phương pháp phi tham số của Kaplan Meier, ta không thể đưa các yếu tố khác để đánh giá và ước lượng ảnh hưởng đến thời gian xảy ra sự kiện. Ta có thể sử dụng mô hình Cox như sau:</p>
<p><span class="math display">\[h(t) = \lambda(t)e^{\beta_1x_1 + ... + \beta_nx_n}\]</span></p>
<p>Trong đó:</p>
<ul>
<li><span class="math inline">\(\lambda(t)\)</span> là hàm nguy cơ nếu không tính đến các ảnh hưởng của x (còn được gọi là baseline hazard function)</li>
<li><span class="math inline">\(x\)</span> là các biến đánh giá ảnh hưởng của mô hình</li>
<li><span class="math inline">\(\beta\)</span> là hệ số cần ước lượng</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>melanom <span class="sc">%&gt;%</span> head</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   no status days ulc thick sex
1 789      3   10   1   676   2
2  13      3   30   2    65   2
3  97      2   35   2   134   2
4  16      3   99   2   290   1
5  21      1  185   1  1208   2
6 469      1  204   1   484   2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>cox.model <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(days, status <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">~</span> sex <span class="sc">+</span> ulc, </span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> melanom)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>cox.model <span class="sc">%&gt;%</span> summary</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Call:
coxph(formula = Surv(days, status == 1) ~ sex + ulc, data = melanom)

  n= 205, number of events= 57 

       coef exp(coef) se(coef)      z Pr(&gt;|z|)    
sex  0.5165    1.6761   0.2667  1.937   0.0528 .  
ulc -1.4180    0.2422   0.2969 -4.775 1.79e-06 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

    exp(coef) exp(-coef) lower .95 upper .95
sex    1.6761     0.5966    0.9938    2.8268
ulc    0.2422     4.1289    0.1353    0.4334

Concordance= 0.719  (se = 0.033 )
Likelihood ratio test= 32.16  on 2 df,   p=1e-07
Wald test            = 28.59  on 2 df,   p=6e-07
Score (logrank) test = 33.51  on 2 df,   p=5e-08</code></pre>
</div>
</div>
<p><strong>Giải thích</strong>:</p>
<ul>
<li>Khi sex tăng thêm 1 đơn vị (chuyển sang nhóm 1 sang 2 hay nói cách khác, nam so với nữ ) thì nguy cơ trải qua sự kiện tăng thêm 1.6761 lần - hay nói cách khác, cao hơn trung bình 67.6%</li>
</ul>
</section>
<section id="random-forest-với-phân-tích-sống-còn" class="level2" data-number="49.4">
<h2 data-number="49.4" class="anchored" data-anchor-id="random-forest-với-phân-tích-sống-còn"><span class="header-section-number">49.4</span> Random Forest với phân tích sống còn</h2>
<section id="xây-dựng-mô-hình-đơn-giản" class="level3" data-number="49.4.1">
<h3 data-number="49.4.1" class="anchored" data-anchor-id="xây-dựng-mô-hình-đơn-giản"><span class="header-section-number">49.4.1</span> Xây dựng mô hình đơn giản</h3>
<p>Mô hình Cox &amp; Kaplan Meier chủ yếu tập trung vào yếu tố giải thích về ảnh hưởng các biến lên thời gian xảy ra sự kiện. Để gia tăng chất lượng dự báo, ta có thể áp dụng các thuật toán khác - như <code>randomforest</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(ranger, tidymodels)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"melanom"</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Phân chia train &amp; test</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(melanom)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>train_df <span class="ot">&lt;-</span> <span class="fu">training</span>(split)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>test_df <span class="ot">&lt;-</span> <span class="fu">testing</span>(split)</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Xây dựng mô hình</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>rf_model <span class="ot">&lt;-</span> <span class="fu">ranger</span>(<span class="fu">Surv</span>(days, status <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">~</span> ulc <span class="sc">+</span> thick <span class="sc">+</span> sex,</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>                   <span class="at">data =</span> train_df,</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>                   <span class="at">mtry =</span> <span class="dv">2</span>,</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>                   <span class="at">importance =</span> <span class="st">"permutation"</span>,</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>                   <span class="at">splitrule =</span> <span class="st">"extratrees"</span>,</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>                   <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>rf_model</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Ranger result

Call:
 ranger(Surv(days, status == 1) ~ ulc + thick + sex, data = train_df,      mtry = 2, importance = "permutation", splitrule = "extratrees",      verbose = TRUE) 

Type:                             Survival 
Number of trees:                  500 
Sample size:                      153 
Number of independent variables:  3 
Mtry:                             2 
Target node size:                 3 
Variable importance mode:         permutation 
Splitrule:                        extratrees 
Number of unique death times:     42 
Number of random splits:          1 
OOB prediction error (1-C):       0.3174472 </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Độ quan trọng của các biến</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>rf_model<span class="sc">$</span>variable.importance</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         ulc        thick          sex 
 0.131669997  0.029128921 -0.007814033 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Dự báo</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>predict_result <span class="ot">&lt;-</span> <span class="fu">predict</span>(rf_model, test_df <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>status, <span class="sc">-</span>days))</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>predict_result</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Ranger prediction

Type:                             Survival 
Sample size:                      52 
Number of independent variables:  3 
Number of unique death times:     42 </code></pre>
</div>
</div>
<p>Kết quả mô hình dự báo 42 bệnh nhân sẽ tử vong tại 42 điểm thời gian khác nhau. Với kết quả survival, có 2 object cần lưu ý:</p>
<ul>
<li><code>unique.death.times</code>: Các điểm thời gian xảy ra biến cố</li>
<li><code>survival</code>: Ước lượng xác suất sống sót theo từng bệnh nhân (quan sát)</li>
</ul>
<p><strong>Đồ thị survival cho 1 bệnh nhân</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>predict_result<span class="sc">$</span>survival[<span class="dv">1</span>,]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 0.9998933 0.9998933 0.9998933 0.9998100 0.9998100 0.9996961 0.9995452
 [8] 0.9992985 0.9992985 0.9990819 0.9990060 0.9988812 0.9988011 0.9975250
[15] 0.9975250 0.9963259 0.9947772 0.9940324 0.9940324 0.9813552 0.9811409
[22] 0.9811409 0.9809249 0.9809249 0.9809249 0.9809249 0.9555169 0.9554117
[29] 0.9539936 0.9139327 0.9139327 0.9139327 0.9124620 0.8683072 0.8657849
[36] 0.8109239 0.8109239 0.8109239 0.8109239 0.8103232 0.7375616 0.7375616</code></pre>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the survival models for each patient</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> predict_result<span class="sc">$</span>unique.death.times, </span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>                <span class="at">y =</span> predict_result<span class="sc">$</span>survival[<span class="dv">1</span>,])) <span class="sc">+</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Days"</span>,</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Survival"</span>,</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Survival curve for a patient"</span>) <span class="sc">+</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="p07-04-survival-analysis_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="dự-báo-theo-từng-quan-sát" class="level3" data-number="49.4.2">
<h3 data-number="49.4.2" class="anchored" data-anchor-id="dự-báo-theo-từng-quan-sát"><span class="header-section-number">49.4.2</span> Dự báo theo từng quan sát</h3>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Lưu ý
</div>
</div>
<div class="callout-body-container callout-body">
<p>Với cách dự báo về thời điểm như trên, ta sẽ không thể có chính xác thời gian xảy ra biến cố theo từng bệnh nhân (id) do mô hình chỉ quan tâm các quan sát trải qua biến cố (sự kiện). Để xử lý, ta có thể dự báo cho từng quan sát và tổng hợp lại kết quả.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># xây dựng mô hình</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>get_survival_predict <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">i =</span> <span class="dv">1</span>) {</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  survival_result <span class="ot">&lt;-</span> <span class="fu">predict</span>(rf_model,</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>                             test_df <span class="sc">%&gt;%</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>                               <span class="fu">select</span>(<span class="sc">-</span>status,<span class="sc">-</span>days) <span class="sc">%&gt;%</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>                               <span class="fu">slice</span>(i))</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>  score_result <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">id =</span> test_df <span class="sc">%&gt;%</span> <span class="fu">slice</span>(i) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(no),</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">survival_prob =</span> survival_result<span class="sc">$</span>survival,</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">days =</span> survival_result<span class="sc">$</span>unique.death.times</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(score_result)</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Tổng hợp kết quả theo khách hàng</span></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>survival_test <span class="ot">&lt;-</span> <span class="fu">map_df</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(test_df), get_survival_predict)</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Tất cả khách hàng đã được score</span></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>survival_test<span class="sc">$</span>id <span class="sc">%&gt;%</span> unique <span class="sc">%&gt;%</span> length</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 52</code></pre>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>survival_test <span class="sc">%&gt;%</span> head</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  id survival_prob days
1 97     0.9998933  210
2 97     0.9998933  279
3 97     0.9998933  386
4 97     0.9998100  426
5 97     0.9998100  469
6 97     0.9996961  529</code></pre>
</div>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Tính trung bình</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>survival_summary <span class="ot">&lt;-</span> survival_test <span class="sc">%&gt;%</span> </span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(days) <span class="sc">%&gt;%</span> </span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">survival_prob =</span> <span class="fu">mean</span>(survival_prob))</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Vẽ đồ thị 52 khách hàng</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>survival_test <span class="sc">%&gt;%</span> </span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(days, survival_prob)) <span class="sc">+</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">group =</span> id), <span class="at">col =</span> <span class="st">"grey"</span>, <span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> survival_summary, <span class="fu">aes</span>(<span class="at">x =</span> days, <span class="at">y =</span> survival_prob),</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>            <span class="at">size =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="st">"darkblue"</span>) <span class="sc">+</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Days"</span>,</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Survival prob"</span>,</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Survival curve for each patient"</span>,</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"(average for each patient is the thick line)"</span>) <span class="sc">+</span></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="p07-04-survival-analysis_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="tài-liệu-tham-khảo" class="level2" data-number="49.5">
<h2 data-number="49.5" class="anchored" data-anchor-id="tài-liệu-tham-khảo"><span class="header-section-number">49.5</span> Tài liệu tham khảo</h2>
<ul>
<li>Chương 13, phân tích với R - Nguyễn Văn Tuấn</li>
<li>R for Everyone</li>
<li><a href="">https://www.emilyzabor.com/tutorials/survival_analysis_in_r_tutorial.html</a></li>
<li><a href="">https://rviews.rstudio.com/2017/09/25/survival-analysis-with-r/</a></li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./p07-03-collaborative-filtering.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">48</span>&nbsp; <span class="chapter-title">Collaborative Filtering</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./p07-05-vintage-analysis.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">50</span>&nbsp; <span class="chapter-title">Vintage analysis</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>