

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="vi" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="vi" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>1. Trực quan hóa dữ liệu &mdash; Tài liệu Phân tích dữ liệu với R 2019</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'./',
              VERSION:'2019',
              LANGUAGE:'vi',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
        <script type="text/javascript" src="_static/copybutton.js"></script>
        <script type="text/javascript" src="_static/translations.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/custom.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Tìm Kiếm" href="search.html" />
    <link rel="prev" title="6. Các tricks khác" href="p11-09-other.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Phân tích dữ liệu với R
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Giới thiệu</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="p01-01-gioi-thieu.html">Khoa học dữ liệu và nghề phân tích dữ liệu</a></li>
</ul>
<p class="caption"><span class="caption-text">Phân tích khám phá dữ liệu</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="p02-03-bien-doi-du-lieu-dplyr.html">1. Ngữ pháp của biến đổi dữ liệu với DPLYR</a></li>
<li class="toctree-l1"><a class="reference internal" href="p02-04-phan-ra-va-xoay-chieu-du-lieu.html">2. Phân rã và xoay chiều dữ liệu</a></li>
<li class="toctree-l1"><a class="reference internal" href="p02-05-cac-chi-so-thong-ke.html">3. Các chỉ số thống kê mô tả cơ bản</a></li>
<li class="toctree-l1"><a class="reference internal" href="p02-06-lap-trinh-ham.html">4. Lập trình hàm</a></li>
<li class="toctree-l1"><a class="reference internal" href="p02-07-lap-trinh-ham-voi-purrr.html">5. Lập trình chức năng hàm với purrr</a></li>
<li class="toctree-l1"><a class="reference internal" href="p02-08-bien-doi-du-lieu-text.html">6. Biến đổi dữ liệu text</a></li>
<li class="toctree-l1"><a class="reference internal" href="p02-11-quan-ly-nhieu-mo-hinh.html">7. Quản lý kết quả phân tích từ nhiều mô hình</a></li>
<li class="toctree-l1"><a class="reference internal" href="p02-15-thong-ke-co-ban.html">8. Xác suất và phân phối thống kê cơ bản</a></li>
<li class="toctree-l1"><a class="reference internal" href="p02-16-power-analysis.html">9. Power analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="p02-20-sampling-methods.html">10. Phương pháp ước lượng lấy mẫu</a></li>
<li class="toctree-l1"><a class="reference internal" href="p02-50-datatable.html">11. Biến đổi dữ liệu với <code class="docutils literal notranslate"><span class="pre">data.table</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="p02-60-thu-thap-du-lieu-tu-website.html">12. Thu thập dữ liệu từ website</a></li>
<li class="toctree-l1"><a class="reference internal" href="p02-99-meo-trong-r.html">13. Các mẹo trong R</a></li>
</ul>
<p class="caption"><span class="caption-text">Supervised learning</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="p03-01-nguyen-ly-du-bao.html">1. Các nguyên lý dự báo</a></li>
<li class="toctree-l1"><a class="reference internal" href="p03-02-mo-hinh-ols.html">2. Mô hình OLS</a></li>
<li class="toctree-l1"><a class="reference internal" href="p03-03-logistic-regression.html">3. Mô hình hồi quy logistic</a></li>
<li class="toctree-l1"><a class="reference internal" href="p03-04-decision-tree.html">4. Cây quyết định</a></li>
<li class="toctree-l1"><a class="reference internal" href="p03-05-bagging-boosting.html">5. Bagging, RandomForest và Boosting</a></li>
<li class="toctree-l1"><a class="reference internal" href="p03-07-xay-dung-mo-hinh-voi-h2o.html">6. Xây dựng mô hình với H2O</a></li>
<li class="toctree-l1"><a class="reference internal" href="p03-08-svm.html">7. Support Vector Machine</a></li>
<li class="toctree-l1"><a class="reference internal" href="p03-09-feature-engineering.html">8. Feature Engineering</a></li>
<li class="toctree-l1"><a class="reference internal" href="p03-15-regularization.html">9. Regularization</a></li>
<li class="toctree-l1"><a class="reference internal" href="p03-17-nonlinear.html">10. Mô hình phi tuyến tính</a></li>
<li class="toctree-l1"><a class="reference internal" href="p03-30-credit-scoring.html">11. Credit Scoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="p03-35-caret.html">12. Xây dựng mô hình dự báo với caret</a></li>
<li class="toctree-l1"><a class="reference internal" href="p03-65-chat-luong-mo-hinh.html">13. Chất lượng mô hình</a></li>
<li class="toctree-l1"><a class="reference internal" href="p03-70-tidymodels.html">14. Tidymodels</a></li>
</ul>
<p class="caption"><span class="caption-text">Unsupervised learning</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="p04-01-unsupervised-learning.html">1. Unsupervised learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="p04-02-kmeans.html">2. k-means</a></li>
<li class="toctree-l1"><a class="reference internal" href="p04-03-hierarchical-clustering.html">3. Hierachical clustering</a></li>
<li class="toctree-l1"><a class="reference internal" href="p04-04-basket-analysis.html">4. Phân tích giỏ hàng</a></li>
<li class="toctree-l1"><a class="reference internal" href="p04-05-pca.html">5. Principal component analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="p04-06-factor-analysis.html">6. Phân tích nhân tố ẩn (factor analysis)</a></li>
</ul>
<p class="caption"><span class="caption-text">Chuỗi thời gian</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="p05-01-chuoi-thoi-gian.html">1. Giới thiệu về chuỗi thời gian</a></li>
<li class="toctree-l1"><a class="reference internal" href="p05-02-arima.html">2. Mô hình ARIMA</a></li>
<li class="toctree-l1"><a class="reference internal" href="p05-03-phan-tich-chuoi-thoi-gian-voi-tidyquant.html">3. Phân tích chuỗi thời gian với tidyquant và timetk</a></li>
<li class="toctree-l1"><a class="reference internal" href="p05-06-du-bao-ts-voi-prophet.html">4. Dự báo chuỗi thời gian với prophet</a></li>
<li class="toctree-l1"><a class="reference internal" href="p05-07-du-bao-ts-voi-timetk.html">5. Dự báo chuỗi thời gian với timetk</a></li>
<li class="toctree-l1"><a class="reference internal" href="p05-08-abnomaly-detection.html">6. Abnomaly detection trong times series</a></li>
</ul>
<p class="caption"><span class="caption-text">Ngôn ngữ tự nghiên</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="p06-01-nlp-co-ban.html">1. Xử lý ngôn ngữ tự nhiên cơ bản</a></li>
<li class="toctree-l1"><a class="reference internal" href="p06-04-text-classification.html">2. Phân loại text</a></li>
<li class="toctree-l1"><a class="reference internal" href="p06-07-nlp-api.html">3. Sử dụng API từ các dịch vụ đám mây</a></li>
<li class="toctree-l1"><a class="reference internal" href="p06-10-ocr-tesseract.html">4. OCR với <code class="docutils literal notranslate"><span class="pre">tesseract</span></code></a></li>
</ul>
<p class="caption"><span class="caption-text">Các phương pháp khác</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="p07-01-survival-analysis.html">1. Survival analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="p07-02-causal-impact.html">2. Causal Impact</a></li>
<li class="toctree-l1"><a class="reference internal" href="p07-03-collaborative-filtering.html">3. Collaborative Filtering</a></li>
<li class="toctree-l1"><a class="reference internal" href="p07-07-spatial-data.html">4. Spatial data</a></li>
<li class="toctree-l1"><a class="reference internal" href="p07-10-shiny.html">5. Shiny apps</a></li>
</ul>
<p class="caption"><span class="caption-text">Deep Learning</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="p09-01-gioi-thieu-deep-learning.html">1. Giới thiệu cơ bản về Deep Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="p09-02-co-ban-kien-thuc-toan.html">2. Kiến thức cơ bản toán học cho deep learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="p09-03-mo-hinh-deep-learning-co-ban.html">3. Mô hình deep learning cơ bản</a></li>
<li class="toctree-l1"><a class="reference internal" href="p09-04-convolution-neural-network.html">4. Convolution neural networks</a></li>
</ul>
<p class="caption"><span class="caption-text">Cloud Computing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="p10-01-cai-dat-rstudio-server-tren-amazon.html">1. Cài đặt server RStudio trên Amazon</a></li>
<li class="toctree-l1"><a class="reference internal" href="p10-03-web-service-azure.html">2. Xây dựng web service với Azure</a></li>
<li class="toctree-l1"><a class="reference internal" href="p10-09-apis-voi-plumber.html">3. API với Plumber</a></li>
</ul>
<p class="caption"><span class="caption-text">Kiến thức bổ trợ</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="p11-01-git.html">1. Sử dụng GIT</a></li>
<li class="toctree-l1"><a class="reference internal" href="p11-02-cmd.html">2. CMD và Bash</a></li>
<li class="toctree-l1"><a class="reference internal" href="p11-03-docker.html">3. Sử dụng docker</a></li>
<li class="toctree-l1"><a class="reference internal" href="p11-04-apis.html">4. API</a></li>
<li class="toctree-l1"><a class="reference internal" href="p11-05-html-css.html">5. Cơ bản về HTML và CSS</a></li>
<li class="toctree-l1"><a class="reference internal" href="p11-09-other.html">6. Các tricks khác</a></li>
</ul>
<p class="caption"><span class="caption-text">Case studies</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">1. Trực quan hóa dữ liệu</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#xay-dung-pheu-ban-hang-theo-tung-nhom">1.1. Xây dựng phễu bán hàng theo từng nhóm</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ve-bieu-do-warterfall-cho-acive-inactive-users">1.2. Vẽ biểu đồ warterfall cho acive/inactive users</a></li>
<li class="toctree-l2"><a class="reference internal" href="#xay-dung-bieu-do-lollipop-chart">1.3. Xây dựng biểu đồ lollipop chart</a></li>
<li class="toctree-l2"><a class="reference internal" href="#truc-quan-hoa-cac-phan-trung-lap-nhau">1.4. Trực quan hóa các phần trùng lặp nhau</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Phân tích dữ liệu với R</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>1. Trực quan hóa dữ liệu</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/p13-01-casestudy-truc-quan-hoa.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="truc-quan-hoa-du-lieu">
<h1>1. Trực quan hóa dữ liệu<a class="headerlink" href="#truc-quan-hoa-du-lieu" title="Permalink to this headline">¶</a></h1>
<div class="section" id="xay-dung-pheu-ban-hang-theo-tung-nhom">
<h2>1.1. Xây dựng phễu bán hàng theo từng nhóm<a class="headerlink" href="#xay-dung-pheu-ban-hang-theo-tung-nhom" title="Permalink to this headline">¶</a></h2>
<p>Trong quá trình phân tích bán hàng, phếu bán hàng (sale funnel) là một
kỹ thuật rất hữu dụng để trực quan hóa kết quả kinh doanh theo từng
nhóm. Tuy nhiên, hiện ít có biểu đồ nào thể hiện được phễu bán hàng một
cách hiệu quả trên R.</p>
<p>Trong mục này, tác giả sẽ hướng dẫn một ví dụ thực tiễn trực quan hóa
phễu bán hàng một cách hiệu quả.</p>
<p>Xem ví dụ điển hình về phễu bán hàng dưới đây</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span>data <span class="o">&lt;-</span> read.table<span class="p">(</span><span class="kp">textConnection</span><span class="p">(</span>
          <span class="kt">c</span><span class="p">(</span><span class="s">&quot;step;segment1;segment2;segment3;total</span>
<span class="s">          1_visit;1806;11663;12641;26110</span>
<span class="s">          2_register;1143;6476;5372;12991</span>
<span class="s">          3_login;1806;11663;2694;16163</span>
<span class="s">          4_subscribe;21;3322;2694;6037</span>
<span class="s">          5_paid;259;422;41;722&quot;</span><span class="p">)),</span>
        header <span class="o">=</span> <span class="bp">T</span><span class="p">,</span> sep <span class="o">=</span> <span class="s">&quot;;&quot;</span><span class="p">)</span>
<span class="c1"># Dữ liệu</span>
data
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">##                    step segment1 segment2 segment3 total</span>
<span class="c1">## 1               1_visit     1806    11663    12641 26110</span>
<span class="c1">## 2            2_register     1143     6476     5372 12991</span>
<span class="c1">## 3               3_login     1806    11663     2694 16163</span>
<span class="c1">## 4           4_subscribe       21     3322     2694  6037</span>
<span class="c1">## 5                5_paid      259      422       41   722</span>
</pre></div>
</div>
<p>Trong tập dữ liệu trên, ta sẽ mô phỏng dữ liệu phếu bán hàng của 3 phân
khúc khách hàng trên một trang thương mại điện tử mà trong đó, khách
hàng sẽ đi qua năm bước khác nhau:</p>
<ul class="simple">
<li>Ghé thăm website (visit)</li>
<li>Đăng ký (register)</li>
<li>Đăng nhập (login)</li>
<li>Đăng ký cập nhật các thông tin sản phẩm (subscribe)</li>
<li>Mua hàng và trả tiền thành công (paid)</li>
</ul>
<p>Để tạo một biểu đồ phễu bán hàng, ta sẽ thực hiện 3 bước lớn sau.</p>
<ul class="simple">
<li>Tạo <code class="docutils literal notranslate"><span class="pre">theme</span></code> cho biểu đồ</li>
<li>Tạo các biểu đồ con cho phễu bán hàng</li>
<li>Kết hợp các biểu đồ để tạo thành phễu bán hàng hoàn chỉnh</li>
</ul>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Gọi library</span>
<span class="kn">library</span><span class="p">(</span>tidyverse<span class="p">)</span>
<span class="kn">library</span><span class="p">(</span>reshape2<span class="p">)</span>
<span class="kn">library</span><span class="p">(</span>forcats<span class="p">)</span>
<span class="kn">library</span><span class="p">(</span>ggthemes<span class="p">)</span>

<span class="c1"># Tạo theme trông cho chart</span>
funnel_theme <span class="o">&lt;-</span> theme<span class="p">(</span>axis.title <span class="o">=</span> element_blank<span class="p">(),</span>
        axis.ticks.x <span class="o">=</span> element_blank<span class="p">(),</span>
        axis.text.x <span class="o">=</span> element_blank<span class="p">(),</span>
        legend.position <span class="o">=</span> <span class="s">&quot;none&quot;</span><span class="p">,</span>
        panel.grid <span class="o">=</span> element_blank<span class="p">()</span>
        <span class="p">)</span>

<span class="c1"># Phân rã dữ liệu</span>
df <span class="o">&lt;-</span> data <span class="o">%&gt;%</span> melt<span class="p">(</span>id.vars <span class="o">=</span> <span class="s">&quot;step&quot;</span><span class="p">)</span>

<span class="c1"># Tạo biểu đồ chính</span>
p1 <span class="o">&lt;-</span> df <span class="o">%&gt;%</span>
  mutate<span class="p">(</span>step <span class="o">=</span> fct_rev<span class="p">(</span>step<span class="p">))</span> <span class="o">%&gt;%</span>
  filter<span class="p">(</span>variable <span class="o">!=</span> <span class="s">&quot;total&quot;</span><span class="p">)</span> <span class="o">%&gt;%</span>
  ggplot<span class="p">(</span>aes<span class="p">(</span>step<span class="p">,</span> value<span class="p">))</span> <span class="o">+</span>
  geom_bar<span class="p">(</span>aes<span class="p">(</span>fill <span class="o">=</span> variable<span class="p">),</span> stat <span class="o">=</span> <span class="s">&quot;identity&quot;</span><span class="p">)</span> <span class="o">+</span>
  facet_grid<span class="p">(</span><span class="o">~</span>variable<span class="p">,</span> scale <span class="o">=</span> <span class="s">&quot;free&quot;</span><span class="p">)</span> <span class="o">+</span>
  coord_flip<span class="p">()</span> <span class="o">+</span>
  geom_text<span class="p">(</span>aes<span class="p">(</span>label <span class="o">=</span> value<span class="p">),</span>
            position <span class="o">=</span> position_stack<span class="p">(</span>vjust <span class="o">=</span> <span class="m">.5</span><span class="p">))</span> <span class="o">+</span>
  scale_fill_tableau<span class="p">()</span> <span class="o">+</span>
  theme_minimal<span class="p">()</span> <span class="o">+</span>
  scale_y_sqrt<span class="p">()</span> <span class="o">+</span>
  funnel_theme <span class="o">+</span>
  theme<span class="p">(</span>plot.margin<span class="o">=</span>grid<span class="o">::</span>unit<span class="p">(</span><span class="kt">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="m">0</span><span class="p">),</span> <span class="s">&quot;mm&quot;</span><span class="p">))</span> <span class="o">+</span>
  theme<span class="p">(</span>
  axis.text.y <span class="o">=</span> element_blank<span class="p">(),</span>
  strip.text <span class="o">=</span> element_text<span class="p">(</span>size <span class="o">=</span> <span class="m">14</span><span class="p">,</span>
                            face <span class="o">=</span> <span class="s">&quot;bold&quot;</span><span class="p">))</span> <span class="o">+</span>
  theme<span class="p">(</span>
    panel.spacing <span class="o">=</span> unit<span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="s">&quot;mm&quot;</span><span class="p">))</span> <span class="o">+</span>
  annotate<span class="p">(</span><span class="s">&quot;rect&quot;</span><span class="p">,</span> xmin <span class="o">=</span> <span class="m">0.5</span><span class="p">,</span> xmax <span class="o">=</span> <span class="m">1.5</span><span class="p">,</span> ymin <span class="o">=</span> <span class="m">0</span><span class="p">,</span> ymax <span class="o">=</span> <span class="kc">Inf</span><span class="p">,</span>
           alpha <span class="o">=</span> <span class="m">.2</span><span class="p">)</span> <span class="o">+</span>
  annotate<span class="p">(</span><span class="s">&quot;rect&quot;</span><span class="p">,</span> xmin <span class="o">=</span> <span class="m">2.5</span><span class="p">,</span> xmax <span class="o">=</span> <span class="m">3.5</span><span class="p">,</span> ymin <span class="o">=</span> <span class="m">0</span><span class="p">,</span> ymax <span class="o">=</span> <span class="kc">Inf</span><span class="p">,</span>
           alpha <span class="o">=</span> <span class="m">.2</span><span class="p">)</span> <span class="o">+</span>
  annotate<span class="p">(</span><span class="s">&quot;rect&quot;</span><span class="p">,</span> xmin <span class="o">=</span> <span class="m">4.5</span><span class="p">,</span> xmax <span class="o">=</span> <span class="m">5.5</span><span class="p">,</span> ymin <span class="o">=</span> <span class="m">0</span><span class="p">,</span> ymax <span class="o">=</span> <span class="kc">Inf</span><span class="p">,</span>
           alpha <span class="o">=</span> <span class="m">.2</span><span class="p">)</span> <span class="o">+</span>
  theme<span class="p">(</span>axis.text.y <span class="o">=</span> element_blank<span class="p">())</span>
p1
</pre></div>
</div>
<p><img alt="image0" src="p13-01-casestudy-truc-quan-hoa_files/figure-html/unnamed-chunk-3-1.png" /></p>
<ul class="simple">
<li>Tạo thêm phần <code class="docutils literal notranslate"><span class="pre">label</span></code> tổng theo từng segment</li>
</ul>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span>df <span class="o">%&gt;%</span>
  mutate<span class="p">(</span>step <span class="o">=</span> fct_rev<span class="p">(</span>step<span class="p">))</span> <span class="o">%&gt;%</span>
  filter<span class="p">(</span>variable <span class="o">==</span> <span class="s">&quot;total&quot;</span><span class="p">)</span> <span class="o">%&gt;%</span>
  ggplot<span class="p">(</span>aes<span class="p">(</span>step<span class="p">,</span> <span class="m">0</span><span class="p">))</span> <span class="o">+</span>
  geom_label<span class="p">(</span>aes<span class="p">(</span>label <span class="o">=</span> value<span class="p">),</span>
             col <span class="o">=</span> <span class="s">&quot;white&quot;</span><span class="p">,</span>
             fill <span class="o">=</span> <span class="s">&quot;darkred&quot;</span><span class="p">,</span>
             size <span class="o">=</span> <span class="m">4</span><span class="p">)</span> <span class="o">+</span>
  coord_flip<span class="p">()</span> <span class="o">+</span>
  facet_wrap<span class="p">(</span><span class="o">~</span>variable<span class="p">)</span> <span class="o">+</span>
  theme_minimal<span class="p">()</span> <span class="o">+</span>
  theme<span class="p">(</span>axis.text <span class="o">=</span> element_blank<span class="p">())</span> <span class="o">+</span>
  funnel_theme <span class="o">+</span>
  theme<span class="p">(</span>
    strip.text.x <span class="o">=</span> element_blank<span class="p">()</span>
  <span class="p">)</span> <span class="o">-&gt;</span> p2
p2
</pre></div>
</div>
<p><img alt="image1" src="p13-01-casestudy-truc-quan-hoa_files/figure-html/unnamed-chunk-4-1.png" /></p>
<ul class="simple">
<li>Tạo thêm thứ tự các bước trong phễu bán hàng để dễ theo dõi hơn</li>
</ul>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span>df2 <span class="o">&lt;-</span> <span class="kt">data.frame</span><span class="p">(</span>step <span class="o">=</span> data<span class="o">$</span>step<span class="p">,</span>
                  value <span class="o">=</span> <span class="m">1</span><span class="o">:</span><span class="m">5</span><span class="p">)</span>
df2 <span class="o">%&gt;%</span>
  mutate<span class="p">(</span>step <span class="o">=</span> fct_rev<span class="p">(</span>step<span class="p">))</span> <span class="o">%&gt;%</span>
  ggplot<span class="p">(</span>aes<span class="p">(</span>step<span class="p">,</span> <span class="m">1</span><span class="p">))</span> <span class="o">+</span>
  geom_hline<span class="p">(</span>yintercept <span class="o">=</span> <span class="m">1</span><span class="p">)</span> <span class="o">+</span>
  geom_point<span class="p">(</span>size <span class="o">=</span> <span class="m">10</span><span class="p">,</span> col <span class="o">=</span> <span class="s">&quot;darkgreen&quot;</span><span class="p">)</span> <span class="o">+</span>
  geom_text<span class="p">(</span>aes<span class="p">(</span>label <span class="o">=</span> value<span class="p">),</span>
            col <span class="o">=</span> <span class="s">&quot;white&quot;</span><span class="p">)</span> <span class="o">+</span>
  coord_flip<span class="p">()</span> <span class="o">+</span>
  theme_minimal<span class="p">()</span> <span class="o">+</span>
  funnel_theme <span class="o">+</span>
  theme<span class="p">(</span>
    axis.text <span class="o">=</span> element_text<span class="p">(</span>size <span class="o">=</span> <span class="m">14</span><span class="p">)</span>
  <span class="p">)</span> <span class="o">-&gt;</span> p3
p3
</pre></div>
</div>
<p><img alt="image2" src="p13-01-casestudy-truc-quan-hoa_files/figure-html/unnamed-chunk-5-1.png" /></p>
<ul class="simple">
<li>Cuối cùng, ta có thể tạo ghép các biểu đồ rời rạc để tạo thành phễu
bán hàng hoàn chỉnh. Việc kết hợp các biểu đồ trên <code class="docutils literal notranslate"><span class="pre">ggplot2</span></code> có thể
hoàn thành một cách đơn giản với <code class="docutils literal notranslate"><span class="pre">ggplot2</span></code></li>
</ul>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1">#devtools::install_github(&quot;thomasp85/patchwork&quot;)</span>
<span class="kn">library</span><span class="p">(</span>patchwork<span class="p">)</span>
p3 <span class="o">+</span>
  labs<span class="p">(</span>title <span class="o">=</span> <span class="s">&quot;Sale funnel for 3 segments&quot;</span><span class="p">)</span> <span class="o">+</span>
  p1 <span class="o">+</span> p2 <span class="o">+</span>
  plot_layout<span class="p">(</span>nrow <span class="o">=</span> <span class="m">1</span><span class="p">,</span> widths <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">8</span><span class="p">,</span> <span class="m">1</span><span class="p">))</span>
</pre></div>
</div>
<p><img alt="image3" src="p13-01-casestudy-truc-quan-hoa_files/figure-html/unnamed-chunk-6-1.png" /></p>
<p>Như vậy, chúng ta đã hoàn thành phễu bán hàng rất chuyên nghiệp với
<code class="docutils literal notranslate"><span class="pre">ggplot2</span></code>. Phễu bán hàng này đặc biệt hiệu quả khi cùng lúc phải so
sánh nhiều phân khúc khách hàng khác nhau trên toàn bộ chuỗi bán hàng.</p>
</div>
<div class="section" id="ve-bieu-do-warterfall-cho-acive-inactive-users">
<h2>1.2. Vẽ biểu đồ warterfall cho acive/inactive users<a class="headerlink" href="#ve-bieu-do-warterfall-cho-acive-inactive-users" title="Permalink to this headline">¶</a></h2>
<p>Trong kỷ nguyên số, chỉ số <code class="docutils literal notranslate"><span class="pre">active</span> <span class="pre">user</span></code> (tạm dịch: người dùng thường
xuyên hoạt động) là chỉ số đặc biệt quan trọng với bất kỳ website/ app
nào. Công thức tính chỉ số người dùng thường xuyên hoạt động tại khoảng
thời gian <em>t</em> được tính như sau:</p>
<div class="math notranslate">
\[active_{t} = active_{t-1} + new_{t} - churn_{t}\]</div>
<p>Ví dụ về waterfall chart được lấy từ ví dụ của Tableau tại đường link:
[<a class="reference external" href="https://public.tableau.com/views/CH24_BBOD_ChurnTurnover/SubscriberChurnAnalysis">https://public.tableau.com/views/CH24_BBOD_ChurnTurnover/SubscriberChurnAnalysis</a>]</p>
<p>Trong case study này, chúng ta sẽ tìm cách xây dựng một biểu đồ
waterfall chart tương tự</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load library</span>
<span class="kn">library</span><span class="p">(</span>tidyverse<span class="p">)</span>
<span class="kn">library</span><span class="p">(</span>ggplot2<span class="p">)</span>
<span class="kn">library</span><span class="p">(</span>reshape2<span class="p">)</span>
<span class="kn">library</span><span class="p">(</span>lubridate<span class="p">)</span>
<span class="kn">library</span><span class="p">(</span>grid<span class="p">)</span>
<span class="kn">library</span><span class="p">(</span>gridExtra<span class="p">)</span>

<span class="c1"># Tạo dữ liệu giả lập</span>
<span class="kp">set.seed</span><span class="p">(</span><span class="m">123</span><span class="p">)</span>
data <span class="o">&lt;-</span> <span class="kt">data.frame</span><span class="p">(</span>date <span class="o">=</span> <span class="kp">seq</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">372</span><span class="p">,</span> by <span class="o">=</span> <span class="m">31</span><span class="p">)</span> <span class="o">%&gt;%</span> as_date<span class="p">)</span>
data <span class="o">&lt;-</span> data <span class="o">%&gt;%</span>
  mutate<span class="p">(</span>new <span class="o">=</span> <span class="kp">abs</span><span class="p">(</span>rnorm<span class="p">(</span><span class="m">12</span><span class="p">,</span> <span class="m">100</span><span class="p">,</span> <span class="m">10</span><span class="p">))</span> <span class="o">%&gt;%</span> <span class="kp">round</span><span class="p">(</span><span class="m">0</span><span class="p">))</span> <span class="o">%&gt;%</span>
  mutate<span class="p">(</span>churn <span class="o">=</span> <span class="kp">abs</span><span class="p">(</span>rnorm<span class="p">(</span><span class="m">12</span><span class="p">,</span> <span class="m">50</span><span class="p">,</span> <span class="m">30</span><span class="p">))</span> <span class="o">%&gt;%</span> <span class="kp">round</span><span class="p">(</span><span class="m">0</span><span class="p">))</span> <span class="o">%&gt;%</span>
  mutate<span class="p">(</span>net <span class="o">=</span> new <span class="o">-</span> churn<span class="p">)</span>  <span class="o">%&gt;%</span>
  mutate<span class="p">(</span>eop <span class="o">=</span> <span class="kp">cumsum</span><span class="p">(</span>net<span class="p">))</span> <span class="o">%&gt;%</span>
  select<span class="p">(</span><span class="o">-</span>net<span class="p">)</span>

data
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">##          date new churn eop</span>
<span class="c1">## 1  1970-01-02  94    62  32</span>
<span class="c1">## 2  1970-02-02  98    53  77</span>
<span class="c1">## 3  1970-03-05 116    33 160</span>
<span class="c1">## 4  1970-04-05 101   104 157</span>
<span class="c1">## 5  1970-05-06 101    65 193</span>
<span class="c1">## 6  1970-06-06 117     9 301</span>
<span class="c1">## 7  1970-07-07 105    71 335</span>
<span class="c1">## 8  1970-08-07  87    36 386</span>
<span class="c1">## 9  1970-09-07  93    18 461</span>
<span class="c1">## 10 1970-10-08  96    43 514</span>
<span class="c1">## 11 1970-11-08 112    19 607</span>
<span class="c1">## 12 1970-12-09 104    28 683</span>
</pre></div>
</div>
<p>Trong ví dụ này, dữ liệu được tạo ngẫu nhiên sao cho số lượng
<code class="docutils literal notranslate"><span class="pre">active</span> <span class="pre">user</span></code> cuối kỳ (eop - end of period) bằng với số cuối kỳ trước,
thêm số lượng mới và trừ đi lượng khách hàng rời bỏ (<code class="docutils literal notranslate"><span class="pre">churn</span></code>).</p>
<p>Để tạo waterfall chart, ta có thể sử dụng <code class="docutils literal notranslate"><span class="pre">geom_segment</span></code> trong ggplot2</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Xác định độ rộng của segment</span>
step <span class="o">&lt;-</span> <span class="m">0.4</span><span class="o">*</span><span class="p">(</span><span class="kp">max</span><span class="p">(</span>data<span class="o">$</span><span class="kp">date</span><span class="p">)</span> <span class="o">-</span> <span class="kp">min</span><span class="p">(</span>data<span class="o">$</span><span class="kp">date</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="kp">nrow</span><span class="p">(</span>data<span class="p">)</span> <span class="o">-</span> <span class="m">1</span><span class="p">)</span>

<span class="c1"># Xác định ymax</span>
data <span class="o">&lt;-</span> data <span class="o">%&gt;%</span>
  mutate<span class="p">(</span>ymax <span class="o">=</span> eop <span class="o">+</span> churn<span class="p">)</span>

<span class="c1"># Xác định ymin</span>
df <span class="o">&lt;-</span> data <span class="o">%&gt;%</span>
  melt<span class="p">(</span>id.vars <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;date&quot;</span><span class="p">,</span> <span class="s">&quot;eop&quot;</span><span class="p">,</span> <span class="s">&quot;ymax&quot;</span><span class="p">))</span> <span class="o">%&gt;%</span>
  mutate<span class="p">(</span>ymin <span class="o">=</span> ymax <span class="o">-</span> value<span class="p">)</span> <span class="o">%&gt;%</span>
  rename<span class="p">(</span>group <span class="o">=</span> variable<span class="p">)</span>

<span class="c1"># Xác định xmin và xmax</span>
df <span class="o">&lt;-</span> df <span class="o">%&gt;%</span>
  mutate<span class="p">(</span>xmin <span class="o">=</span> case_when<span class="p">(</span>
    group <span class="o">==</span> <span class="s">&quot;new&quot;</span> <span class="o">~</span> date <span class="o">-</span> step<span class="p">,</span>
    <span class="kc">TRUE</span> <span class="o">~</span> <span class="kp">date</span>
  <span class="p">))</span> <span class="o">%&gt;%</span>
  mutate<span class="p">(</span>xmax <span class="o">=</span> case_when<span class="p">(</span>
    group <span class="o">==</span> <span class="s">&quot;new&quot;</span> <span class="o">~</span> <span class="kp">date</span><span class="p">,</span>
    <span class="kc">TRUE</span> <span class="o">~</span> date <span class="o">+</span> step
  <span class="p">))</span>


<span class="c1"># Create waterfall chart</span>
p1 <span class="o">&lt;-</span> df <span class="o">%&gt;%</span>
  arrange<span class="p">(</span><span class="kp">date</span><span class="p">)</span> <span class="o">%&gt;%</span>
  ggplot<span class="p">()</span> <span class="o">+</span>
  geom_rect<span class="p">(</span>aes<span class="p">(</span>xmin <span class="o">=</span> xmin<span class="p">,</span>
                xmax <span class="o">=</span> xmax<span class="p">,</span>
                ymin <span class="o">=</span> ymin<span class="p">,</span>
                ymax <span class="o">=</span> ymax<span class="p">,</span>
                fill <span class="o">=</span> group<span class="p">))</span>
p1
</pre></div>
</div>
<p><img alt="image4" src="p13-01-casestudy-truc-quan-hoa_files/figure-html/unnamed-chunk-8-1.png" /></p>
<p>Như vậy, ta đã tạo xong biểu đồ water-fall đơn giản. Ở bước tiếp theo,
chúng ta cần điều chỉnh lại các thành phần cho biểu đồ.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Tạo dữ liệu cho biểu đồ đường</span>
df2 <span class="o">&lt;-</span> df <span class="o">%&gt;%</span> select<span class="p">(</span><span class="kp">date</span><span class="p">,</span> eop<span class="p">)</span> <span class="o">%&gt;%</span> distinct<span class="p">()</span>

<span class="c1"># Điều chỉnh theme</span>
p2 <span class="o">&lt;-</span> p1  <span class="o">+</span>
  geom_line<span class="p">(</span>aes<span class="p">(</span><span class="kp">date</span><span class="p">,</span> eop<span class="p">),</span> col <span class="o">=</span> <span class="s">&quot;dodgerblue4&quot;</span><span class="p">,</span> size <span class="o">=</span> <span class="m">1</span><span class="p">)</span> <span class="o">+</span>
  geom_point<span class="p">(</span>aes<span class="p">(</span><span class="kp">date</span><span class="p">,</span> eop<span class="p">),</span> col <span class="o">=</span> <span class="s">&quot;dodgerblue4&quot;</span><span class="p">,</span> size <span class="o">=</span> <span class="m">2.5</span><span class="p">)</span> <span class="o">+</span>
  geom_text<span class="p">(</span>aes<span class="p">(</span><span class="kp">date</span><span class="p">,</span> eop<span class="p">,</span> label <span class="o">=</span> eop<span class="p">),</span> vjust <span class="o">=</span> <span class="m">1.2</span><span class="p">,</span>
            hjust <span class="o">=</span> <span class="m">-0.1</span><span class="p">)</span> <span class="o">+</span>
  scale_fill_manual<span class="p">(</span>values <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;grey60&quot;</span><span class="p">,</span> <span class="s">&quot;coral2&quot;</span><span class="p">))</span> <span class="o">+</span>
  theme_minimal<span class="p">()</span> <span class="o">+</span>
  theme<span class="p">(</span>
    axis.line <span class="o">=</span> element_line<span class="p">(</span>color <span class="o">=</span> <span class="s">&quot;gray40&quot;</span><span class="p">,</span> size <span class="o">=</span> <span class="m">0.5</span><span class="p">),</span>
    legend.position <span class="o">=</span> <span class="s">&quot;top&quot;</span><span class="p">)</span> <span class="o">+</span>
  scale_x_date<span class="p">(</span>breaks <span class="o">=</span> data<span class="o">$</span><span class="kp">date</span><span class="p">,</span>
               date_labels <span class="o">=</span> <span class="s">&quot;%b&quot;</span><span class="p">)</span> <span class="o">+</span>
  theme<span class="p">(</span>panel.grid.minor.x <span class="o">=</span> element_blank<span class="p">(),</span>
        legend.title <span class="o">=</span> element_blank<span class="p">())</span> <span class="o">+</span>
  ggtitle<span class="p">(</span><span class="s">&quot;Overview of active users&quot;</span><span class="p">)</span> <span class="o">+</span>
  xlab<span class="p">(</span><span class="s">&quot;Date&quot;</span><span class="p">)</span> <span class="o">+</span>
  ylab<span class="p">(</span><span class="s">&quot;Number of active users&quot;</span><span class="p">)</span>
p2
</pre></div>
</div>
<p><img alt="image5" src="p13-01-casestudy-truc-quan-hoa_files/figure-html/unnamed-chunk-9-1.png" /></p>
<p>Bước tiếp theo, ta cần xây dựng biểu đồ bar đơn giản để có thể đưa vào
góc phần tư bên trái của biểu đồ vừa tạo.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span>p3 <span class="o">&lt;-</span> df <span class="o">%&gt;%</span>
  mutate<span class="p">(</span>value <span class="o">=</span> case_when<span class="p">(</span>
    group <span class="o">==</span> <span class="s">&quot;churn&quot;</span> <span class="o">~</span> <span class="m">-1</span> <span class="o">*</span> value<span class="p">,</span>
    <span class="kc">TRUE</span> <span class="o">~</span> value
  <span class="p">))</span> <span class="o">%&gt;%</span>
  ggplot<span class="p">(</span>aes<span class="p">(</span><span class="kp">date</span><span class="p">,</span> value<span class="p">))</span> <span class="o">+</span>
  geom_bar<span class="p">(</span>aes<span class="p">(</span>fill <span class="o">=</span> group<span class="p">),</span> stat <span class="o">=</span> <span class="s">&quot;identity&quot;</span><span class="p">)</span> <span class="o">+</span>
  scale_fill_manual<span class="p">(</span>values <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;grey60&quot;</span><span class="p">,</span> <span class="s">&quot;coral2&quot;</span><span class="p">))</span> <span class="o">+</span>
  theme_minimal<span class="p">()</span> <span class="o">+</span>
  theme<span class="p">(</span>
    legend.position <span class="o">=</span> <span class="s">&quot;none&quot;</span><span class="p">,</span>
    axis.title.x <span class="o">=</span> element_blank<span class="p">(),</span>
    axis.title.y <span class="o">=</span> element_blank<span class="p">(),</span>
    axis.ticks.y <span class="o">=</span> element_blank<span class="p">(),</span>
    axis.text.y <span class="o">=</span> element_blank<span class="p">(),</span>
    panel.grid.minor <span class="o">=</span> element_blank<span class="p">(),</span>
    panel.grid.major <span class="o">=</span> element_blank<span class="p">(),</span>
    axis.text.x <span class="o">=</span> element_text<span class="p">(</span>angle <span class="o">=</span> <span class="m">90</span><span class="p">)</span>
  <span class="p">)</span> <span class="o">+</span>
  scale_x_date<span class="p">(</span>breaks <span class="o">=</span> data<span class="o">$</span><span class="kp">date</span><span class="p">,</span>
               date_labels <span class="o">=</span> <span class="s">&quot;%b&quot;</span><span class="p">)</span>
p3
</pre></div>
</div>
<p><img alt="image6" src="p13-01-casestudy-truc-quan-hoa_files/figure-html/unnamed-chunk-10-1.png" /></p>
<p>Cuối cùng, ta có thể nhóm hai biểu đồ trên với <code class="docutils literal notranslate"><span class="pre">grid</span></code> &amp; <code class="docutils literal notranslate"><span class="pre">gridExtra</span></code>.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span>grid.newpage<span class="p">()</span>

<span class="c1"># Xác định vị trí cho biểu đồ chính</span>
position_1 <span class="o">&lt;-</span> viewport<span class="p">(</span>width <span class="o">=</span> <span class="m">1</span><span class="p">,</span> height <span class="o">=</span> <span class="m">1</span><span class="p">,</span>
                       x <span class="o">=</span> <span class="m">0.5</span><span class="p">,</span> y <span class="o">=</span> <span class="m">0.5</span><span class="p">)</span>

<span class="c1"># Vị trí cho biểu đồ phụ</span>
position_2 <span class="o">&lt;-</span> viewport<span class="p">(</span>width <span class="o">=</span> <span class="m">0.35</span><span class="p">,</span> height <span class="o">=</span> <span class="m">0.25</span><span class="p">,</span>
                       x <span class="o">=</span> <span class="m">0.25</span><span class="p">,</span> y <span class="o">=</span> <span class="m">0.75</span><span class="p">)</span>

<span class="kp">print</span><span class="p">(</span>p2<span class="p">,</span> vp <span class="o">=</span> position_1<span class="p">)</span>
<span class="kp">print</span><span class="p">(</span>p3<span class="p">,</span> vp <span class="o">=</span> position_2<span class="p">)</span>
</pre></div>
</div>
<p><img alt="image7" src="p13-01-casestudy-truc-quan-hoa_files/figure-html/unnamed-chunk-11-1.png" /></p>
</div>
<div class="section" id="xay-dung-bieu-do-lollipop-chart">
<h2>1.3. Xây dựng biểu đồ lollipop chart<a class="headerlink" href="#xay-dung-bieu-do-lollipop-chart" title="Permalink to this headline">¶</a></h2>
<p>Trong trực quan hóa dữ liệu, <code class="docutils literal notranslate"><span class="pre">lollipop</span> <span class="pre">chart</span></code> tuy không phải là một
trong những biểu đồ phổ biến nhưng lại rất hiệu quả khi muốn thể hiện sự
dịch thay đổi của một chỉ số giữa hai điểm thời gian. Trong case study
này, ta xây dựng biểu đồ <code class="docutils literal notranslate"><span class="pre">lollipop</span> <span class="pre">chart</span></code> với <code class="docutils literal notranslate"><span class="pre">ggplot2</span></code>.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load library</span>
<span class="kn">library</span><span class="p">(</span>tidyverse<span class="p">)</span>
<span class="kn">library</span><span class="p">(</span>gapminder<span class="p">)</span>
</pre></div>
</div>
<p>Để xây dựng biểu đồ, ta sử dụng dữ liệu <code class="docutils literal notranslate"><span class="pre">gapminder</span></code> từ tập dữ liệu
gapminder. Mục tiêu là xây dựng biểu đồ thể hiện được sự thay đổi
GDP/đầu người của các nước châu Âu trong năm 1952 so với năm 1977.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span>data <span class="o">&lt;-</span> gapminder <span class="o">%&gt;%</span>
  filter<span class="p">(</span>continent <span class="o">==</span> <span class="s">&quot;Europe&quot;</span><span class="p">)</span> <span class="o">%&gt;%</span>
  filter<span class="p">(</span>year <span class="o">%in%</span> <span class="kt">c</span><span class="p">(</span><span class="m">1952</span><span class="p">,</span> <span class="m">1977</span><span class="p">))</span> <span class="o">%&gt;%</span>
  select<span class="p">(</span>country<span class="p">,</span> year<span class="p">,</span> gdpPercap<span class="p">)</span> <span class="o">%&gt;%</span>
  spread<span class="p">(</span>year<span class="p">,</span> gdpPercap<span class="p">)</span> <span class="o">%&gt;%</span>
  rename<span class="p">(</span>y1952 <span class="o">=</span> <span class="sb">`1952`</span><span class="p">,</span>
         y1977 <span class="o">=</span> <span class="sb">`1977`</span><span class="p">)</span>
data <span class="o">%&gt;%</span> <span class="kp">head</span><span class="p">(</span><span class="m">10</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## # A tibble: 10 x 3</span>
<span class="c1">##    country                y1952  y1977</span>
<span class="c1">##    &lt;fct&gt;                  &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="c1">##  1 Albania                1601.  3533.</span>
<span class="c1">##  2 Austria                6137. 19749.</span>
<span class="c1">##  3 Belgium                8343. 19118.</span>
<span class="c1">##  4 Bosnia and Herzegovina  974.  3528.</span>
<span class="c1">##  5 Bulgaria               2444.  7612.</span>
<span class="c1">##  6 Croatia                3119. 11305.</span>
<span class="c1">##  7 Czech Republic         6876. 14800.</span>
<span class="c1">##  8 Denmark                9692. 20423.</span>
<span class="c1">##  9 Finland                6425. 15605.</span>
<span class="c1">## 10 France                 7030. 18293.</span>
</pre></div>
</div>
<p>Biểu đồ lollipop có thể xây dựng dựa trên <code class="docutils literal notranslate"><span class="pre">geom_point</span></code> và
<code class="docutils literal notranslate"><span class="pre">geom_segment</span></code> như sau.</p>
<p><strong>Biểu đồ đầu tiên</strong></p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span>data <span class="o">%&gt;%</span>
  ggplot<span class="p">(</span>aes<span class="p">(</span>x  <span class="o">=</span> country<span class="p">))</span> <span class="o">+</span>
  <span class="c1"># Tạo đường nối giữa hai điểm</span>
  geom_segment<span class="p">(</span>aes<span class="p">(</span>y <span class="o">=</span> y1952<span class="p">,</span> yend <span class="o">=</span> y1977<span class="p">,</span>
               x <span class="o">=</span> country<span class="p">,</span> xend <span class="o">=</span> country<span class="p">),</span> size <span class="o">=</span> <span class="m">1</span><span class="p">,</span>
               col <span class="o">=</span> <span class="s">&quot;grey50&quot;</span><span class="p">)</span> <span class="o">+</span>
  <span class="c1"># Tạo điểm đầu</span>
  geom_point<span class="p">(</span>aes<span class="p">(</span>country<span class="p">,</span> y1952<span class="p">,</span> color <span class="o">=</span> <span class="s">&quot;1952&quot;</span><span class="p">),</span> size <span class="o">=</span> <span class="m">3.5</span><span class="p">)</span> <span class="o">+</span>
  <span class="c1"># Tạo điểm cuối</span>
  geom_point<span class="p">(</span>aes<span class="p">(</span>country<span class="p">,</span> y1977<span class="p">,</span>
             color <span class="o">=</span> <span class="s">&quot;1977&quot;</span><span class="p">),</span> size <span class="o">=</span> <span class="m">3.5</span><span class="p">)</span> <span class="o">+</span>
  coord_flip<span class="p">()</span>
</pre></div>
</div>
<p><img alt="image8" src="p13-01-casestudy-truc-quan-hoa_files/figure-html/unnamed-chunk-14-1.png" /></p>
<p>Tuy nhiên, với biểu đồ trên, ta thấy xuất hiện hai lỗi cơ bản sau:</p>
<ul class="simple">
<li>Thứ nhất, thứ tự các các quan sát đang để dạng mặc định. Do đó, kết
quả trực quan hóa chỉ mang tính thông tin mà chưa có yêu tố
<code class="docutils literal notranslate"><span class="pre">kể</span> <span class="pre">chuyện</span></code> (story telling). Ta có thể giải quyết bằng cách sắp xếp
lại factor theo thứ tự từ thấp đến cao.</li>
<li>Thứ hai, biểu đồ thể hiện theo chiều ngang. Do đó, các thông tin
không cần thiết có thể được loại bỏ để biểu đồ gọn gàng và mạch lạc
hơn.</li>
</ul>
<p>Ta có thể chỉnh lại biểu đồ như sau.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Tinh chỉnh theme cho biểu đồ</span>
my_theme <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span><span class="kc">...</span><span class="p">)</span> <span class="p">{</span>
  theme_bw<span class="p">()</span> <span class="o">+</span>
    theme<span class="p">(</span>plot.background <span class="o">=</span> element_rect<span class="p">(</span>fill <span class="o">=</span> <span class="s">&quot;white&quot;</span><span class="p">))</span> <span class="o">+</span>
    theme<span class="p">(</span>panel.grid.minor <span class="o">=</span> element_blank<span class="p">())</span> <span class="o">+</span>
    theme<span class="p">(</span>panel.grid.major.y <span class="o">=</span> element_blank<span class="p">())</span> <span class="o">+</span>
    theme<span class="p">(</span>panel.grid.major.x <span class="o">=</span> element_line<span class="p">())</span> <span class="o">+</span>
    theme<span class="p">(</span>axis.ticks <span class="o">=</span> element_blank<span class="p">())</span> <span class="o">+</span>
    theme<span class="p">(</span>panel.border <span class="o">=</span> element_blank<span class="p">())</span> <span class="o">+</span>
    theme<span class="p">(</span>text <span class="o">=</span> element_text<span class="p">(</span>size <span class="o">=</span> <span class="m">13</span><span class="p">,</span> color <span class="o">=</span> <span class="s">&quot;black&quot;</span><span class="p">))</span> <span class="o">+</span>
    theme<span class="p">(</span>plot.subtitle <span class="o">=</span> element_text<span class="p">(</span>color <span class="o">=</span> <span class="s">&quot;gray20&quot;</span><span class="p">,</span> size <span class="o">=</span> <span class="m">10</span><span class="p">,</span> face <span class="o">=</span> <span class="s">&quot;italic&quot;</span><span class="p">))</span> <span class="o">+</span>
    theme<span class="p">(</span>legend.title <span class="o">=</span> element_text<span class="p">(</span>size <span class="o">=</span> <span class="m">10</span><span class="p">,</span> color <span class="o">=</span> <span class="s">&quot;gray20&quot;</span><span class="p">))</span> <span class="o">+</span>
    theme<span class="p">(</span>legend.position <span class="o">=</span> <span class="s">&quot;top&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># Tạo biểu đồ mới</span>
p1 <span class="o">&lt;-</span> data <span class="o">%&gt;%</span>
  mutate<span class="p">(</span>country <span class="o">=</span> fct_reorder<span class="p">(</span>country<span class="p">,</span> y1977<span class="p">))</span> <span class="o">%&gt;%</span>
  ggplot<span class="p">(</span>aes<span class="p">(</span>x  <span class="o">=</span> country<span class="p">))</span> <span class="o">+</span>
  geom_segment<span class="p">(</span>aes<span class="p">(</span>y <span class="o">=</span> y1952<span class="p">,</span> yend <span class="o">=</span> y1977<span class="p">,</span>
               x <span class="o">=</span> country<span class="p">,</span> xend <span class="o">=</span> country<span class="p">),</span> size <span class="o">=</span> <span class="m">1</span><span class="p">,</span>
               col <span class="o">=</span> <span class="s">&quot;grey50&quot;</span><span class="p">,</span>
               alpha <span class="o">=</span> <span class="m">0.7</span><span class="p">)</span> <span class="o">+</span>
  geom_point<span class="p">(</span>aes<span class="p">(</span>country<span class="p">,</span> y1952<span class="p">,</span> color <span class="o">=</span> <span class="s">&quot;1952&quot;</span><span class="p">),</span>
             size <span class="o">=</span> <span class="m">3.5</span><span class="p">,</span> alpha <span class="o">=</span> <span class="m">0.7</span><span class="p">)</span> <span class="o">+</span>
  geom_point<span class="p">(</span>aes<span class="p">(</span>country<span class="p">,</span> y1977<span class="p">,</span> color <span class="o">=</span> <span class="s">&quot;1977&quot;</span><span class="p">),</span>
             size <span class="o">=</span> <span class="m">3.5</span><span class="p">,</span> alpha <span class="o">=</span> <span class="m">0.7</span><span class="p">)</span> <span class="o">+</span>
  coord_flip<span class="p">()</span> <span class="o">+</span>
  my_theme<span class="p">()</span> <span class="o">+</span>
  scale_y_continuous<span class="p">(</span>breaks <span class="o">=</span> <span class="kp">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">30000</span><span class="p">,</span> by <span class="o">=</span> <span class="m">5000</span><span class="p">),</span>
                     limits <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="m">800</span><span class="p">,</span> <span class="m">27000</span><span class="p">))</span> <span class="o">+</span>
  scale_color_manual<span class="p">(</span>
    name <span class="o">=</span> <span class="s">&quot;Year&quot;</span><span class="p">,</span>
    labels <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;1952&quot;</span><span class="p">,</span> <span class="s">&quot;1977&quot;</span><span class="p">),</span>
    values <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;darkblue&quot;</span><span class="p">,</span> <span class="s">&quot;darkred&quot;</span><span class="p">)</span>
  <span class="p">)</span> <span class="o">+</span>
  labs<span class="p">(</span>x <span class="o">=</span> <span class="kc">NULL</span><span class="p">,</span> y <span class="o">=</span> <span class="kc">NULL</span><span class="p">,</span>
       title <span class="o">=</span> <span class="s">&quot;An example of lollipop chart&quot;</span><span class="p">,</span>
       subtitle <span class="o">=</span> <span class="s">&quot;Changes of GDP per capita in Europe&quot;</span><span class="p">,</span>
       caption <span class="o">=</span> <span class="s">&quot;Created by RAnalytics.vn&quot;</span><span class="p">)</span>
p1
</pre></div>
</div>
<p><img alt="image9" src="p13-01-casestudy-truc-quan-hoa_files/figure-html/unnamed-chunk-15-1.png" /></p>
<p><strong>Bonus</strong>: Để nhấn mạnh hơn sự thay đổi của GDP per capita, ta có thể vẽ
thêm các đường nối các điểm trong biểu đồ như sau.</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span>p2 <span class="o">&lt;-</span> p1 <span class="o">+</span> geom_line<span class="p">(</span>aes<span class="p">(</span><span class="kp">as.numeric</span><span class="p">(</span>country<span class="p">),</span> y1977<span class="p">),</span>
               col <span class="o">=</span> <span class="s">&quot;darkred&quot;</span><span class="p">)</span>
p2
</pre></div>
</div>
<p><img alt="image10" src="p13-01-casestudy-truc-quan-hoa_files/figure-html/unnamed-chunk-16-1.png" /></p>
</div>
<div class="section" id="truc-quan-hoa-cac-phan-trung-lap-nhau">
<h2>1.4. Trực quan hóa các phần trùng lặp nhau<a class="headerlink" href="#truc-quan-hoa-cac-phan-trung-lap-nhau" title="Permalink to this headline">¶</a></h2>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="kn">library</span><span class="p">(</span>tidyverse<span class="p">)</span>
<span class="kn">library</span><span class="p">(</span>UpSetR<span class="p">)</span>

movies <span class="o">&lt;-</span> read.csv<span class="p">(</span> <span class="kp">system.file</span><span class="p">(</span><span class="s">&quot;extdata&quot;</span><span class="p">,</span> <span class="s">&quot;movies.csv&quot;</span><span class="p">,</span> package <span class="o">=</span> <span class="s">&quot;UpSetR&quot;</span><span class="p">),</span> header<span class="o">=</span><span class="kc">TRUE</span><span class="p">,</span> sep<span class="o">=</span><span class="s">&quot;;&quot;</span> <span class="p">)</span>

movies <span class="o">%&gt;%</span> <span class="kp">head</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">##                                 Name ReleaseDate Action Adventure Children</span>
<span class="c1">## 1                   Toy Story (1995)        1995      0         0        1</span>
<span class="c1">## 2                     Jumanji (1995)        1995      0         1        1</span>
<span class="c1">## 3            Grumpier Old Men (1995)        1995      0         0        0</span>
<span class="c1">## 4           Waiting to Exhale (1995)        1995      0         0        0</span>
<span class="c1">## 5 Father of the Bride Part II (1995)        1995      0         0        0</span>
<span class="c1">## 6                        Heat (1995)        1995      1         0        0</span>
<span class="c1">##   Comedy Crime Documentary Drama Fantasy Noir Horror Musical Mystery</span>
<span class="c1">## 1      1     0           0     0       0    0      0       0       0</span>
<span class="c1">## 2      0     0           0     0       1    0      0       0       0</span>
<span class="c1">## 3      1     0           0     0       0    0      0       0       0</span>
<span class="c1">## 4      1     0           0     1       0    0      0       0       0</span>
<span class="c1">## 5      1     0           0     0       0    0      0       0       0</span>
<span class="c1">## 6      0     1           0     0       0    0      0       0       0</span>
<span class="c1">##   Romance SciFi Thriller War Western AvgRating Watches</span>
<span class="c1">## 1       0     0        0   0       0      4.15    2077</span>
<span class="c1">## 2       0     0        0   0       0      3.20     701</span>
<span class="c1">## 3       1     0        0   0       0      3.02     478</span>
<span class="c1">## 4       0     0        0   0       0      2.73     170</span>
<span class="c1">## 5       0     0        0   0       0      3.01     296</span>
<span class="c1">## 6       0     0        1   0       0      3.88     940</span>
</pre></div>
</div>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span>upset<span class="p">(</span>movies<span class="p">,</span> nsets <span class="o">=</span> <span class="m">3</span><span class="p">,</span> nintersects <span class="o">=</span> <span class="m">30</span><span class="p">,</span> mb.ratio <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="m">0.55</span><span class="p">,</span> <span class="m">0.45</span><span class="p">),</span>
      order.by <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="s">&quot;freq&quot;</span><span class="p">,</span> <span class="s">&quot;degree&quot;</span><span class="p">),</span> decreasing <span class="o">=</span> <span class="kt">c</span><span class="p">(</span><span class="kc">TRUE</span><span class="p">,</span><span class="kc">FALSE</span><span class="p">),</span>
      mainbar.y.label <span class="o">=</span> <span class="s">&quot;# of users by groups&quot;</span><span class="p">,</span>
      sets.x.label <span class="o">=</span> <span class="s">&quot;# of users by platforms&quot;</span><span class="p">,</span>
      queries <span class="o">=</span> <span class="kt">list</span><span class="p">(</span><span class="kt">list</span><span class="p">(</span>query <span class="o">=</span> intersects<span class="p">,</span> params <span class="o">=</span> <span class="kt">list</span><span class="p">(</span><span class="s">&quot;Drama&quot;</span><span class="p">,</span> <span class="s">&quot;Action&quot;</span><span class="p">),</span>
                          color <span class="o">=</span> <span class="s">&quot;darkred&quot;</span><span class="p">,</span> active <span class="o">=</span> <span class="bp">T</span><span class="p">)),</span>
      main.bar.color <span class="o">=</span> <span class="s">&quot;darkgreen&quot;</span><span class="p">,</span>
      text.scale <span class="o">=</span> <span class="m">1.4</span><span class="p">,</span>
      shade.alpha <span class="o">=</span> <span class="m">0.55</span><span class="p">,</span>
      point.size <span class="o">=</span> <span class="m">3</span><span class="p">)</span>
</pre></div>
</div>
<p><img alt="image11" src="p13-01-casestudy-truc-quan-hoa_files/figure-html/unnamed-chunk-17-1.png" /></p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Lưu file về máy</span>
dev.copy<span class="p">(</span>png<span class="p">,</span><span class="s">&#39;myplot.png&#39;</span><span class="p">,</span> width <span class="o">=</span> <span class="m">600</span><span class="p">,</span> height <span class="o">=</span> <span class="m">400</span><span class="p">)</span>
dev.off<span class="p">()</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="p11-09-other.html" class="btn btn-neutral float-left" title="6. Các tricks khác" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Anh Hoang Duc

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>