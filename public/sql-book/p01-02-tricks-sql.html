

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="vi" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="vi" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>11. Tricks khi dùng với SQL &mdash; Tài liệu Khai thác dữ liệu với SQL 2019</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'./',
              VERSION:'2019',
              LANGUAGE:'vi',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
        <script type="text/javascript" src="_static/copybutton.js"></script>
        <script type="text/javascript" src="_static/translations.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/copybutton.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Tìm Kiếm" href="search.html" />
    <link rel="next" title="1. Pivot - Unpivot" href="p02-03-sql-nang-cao.html" />
    <link rel="prev" title="1. Giới thiệu về SQL" href="p01-01-sql-co-ban.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Khai thác dữ liệu với SQL
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">SQL cơ bản</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="p01-01-sql-co-ban.html">1. Giới thiệu về SQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="p01-01-sql-co-ban.html#cac-nhom-cau-lenh-truy-van-tong-hop">2. Các nhóm câu lệnh truy vấn, tổng hợp</a></li>
<li class="toctree-l1"><a class="reference internal" href="p01-01-sql-co-ban.html#cac-nhom-cau-lenh-thay-doi-du-lieu-trong-csdl">3. Các nhóm câu lệnh thay đổi dữ liệu trong CSDL</a></li>
<li class="toctree-l1"><a class="reference internal" href="p01-01-sql-co-ban.html#sub-query">4. Sub Query</a></li>
<li class="toctree-l1"><a class="reference internal" href="p01-01-sql-co-ban.html#cac-nhom-cau-lenh-co-ban-khac">5. Các nhóm câu lệnh cơ bản khác</a></li>
<li class="toctree-l1"><a class="reference internal" href="p01-01-sql-co-ban.html#sql-dong-voi-exec">6. SQL động với Exec</a></li>
<li class="toctree-l1"><a class="reference internal" href="p01-01-sql-co-ban.html#ham-va-thu-tuc">7. Hàm và thủ tục</a></li>
<li class="toctree-l1"><a class="reference internal" href="p01-01-sql-co-ban.html#cac-nhom-cau-lenh-nang-cao">8. Các nhóm câu lệnh nâng cao</a></li>
<li class="toctree-l1"><a class="reference internal" href="p01-01-sql-co-ban.html#dat-job-trong-sql">9. Đặt job trong SQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="p01-01-sql-co-ban.html#cac-nhom-cau-lenh-quan-tri">10. Các nhóm câu lệnh quản trị</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">11. Tricks khi dùng với SQL</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#du-lieu-bi-collate">11.1. Dữ liệu bị collate</a></li>
<li class="toctree-l2"><a class="reference internal" href="#drop-nhieu-bang-theo-dieu-kien">11.2. Drop nhiều bảng theo điều kiện</a></li>
<li class="toctree-l2"><a class="reference internal" href="#auto-wrap-in-mssql">11.3. Auto Wrap in MSSQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="#format-dinh-dang-them-ky-tu-00-truoc-so">11.4. Format định dạng thêm ký tự 00 trước số</a></li>
<li class="toctree-l2"><a class="reference internal" href="#kiem-tra-dinh-dang-du-lieu-mot-bang">11.5. Kiểm tra định dạng dữ liệu một bảng</a></li>
<li class="toctree-l2"><a class="reference internal" href="#convert-tu-tieng-viet-co-dau-sang-khong-dau">11.6. Convert từ tiếng Việt có dấu sang không dấu</a></li>
<li class="toctree-l2"><a class="reference internal" href="#sua-default-template-trong-sql">11.7. Sửa default template trong SQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="#bat-dau-tem-bang-voi-dim">11.8. Bắt đầu têm bảng với DIM</a></li>
<li class="toctree-l2"><a class="reference internal" href="#xoa-bang-neu-ton-tai">11.9. Xóa bảng nếu tồn tại</a></li>
<li class="toctree-l2"><a class="reference internal" href="#tim-kiem-kieu-du-lieu-trong-bang-cua-db">11.10. Tìm kiếm kiểu dữ liệu trong bảng của db</a></li>
<li class="toctree-l2"><a class="reference internal" href="#su-dung-drop-va-create-trong-cung-batch">11.11. Sử dụng drop và create trong cùng batch</a></li>
<li class="toctree-l2"><a class="reference internal" href="#phan-biet-dinh-dang-integer">11.12. Phân biệt định dạng integer</a></li>
<li class="toctree-l2"><a class="reference internal" href="#varchar-vs-nvarchar">11.13. VARCHAR vs.&nbsp;NVARCHAR</a></li>
<li class="toctree-l2"><a class="reference internal" href="#primary-key-vs-unique-key">11.14. Primary key vs.&nbsp;Unique key</a></li>
<li class="toctree-l2"><a class="reference internal" href="#exec-vs-exec">11.15. EXEC vs.&nbsp;EXEC()</a></li>
<li class="toctree-l2"><a class="reference internal" href="#xem-tat-ca-cac-user-defined-procedure">11.16. Xem tất cả các user-defined procedure</a></li>
<li class="toctree-l2"><a class="reference internal" href="#lam-viec-voi-link-server">11.17. Làm việc với link server</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#procedure-tao-nhieu-link-server">11.17.1. Procedure tạo nhiều link server</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#tim-tat-ca-cac-bang-cot-trong-database">11.18. Tìm tất cả các bảng, cột trong Database</a></li>
<li class="toctree-l2"><a class="reference internal" href="#cac-luu-y-giup-tang-toc-do-truy-van">11.19. Các lưu ý giúp tăng tốc độ truy vấn</a></li>
<li class="toctree-l2"><a class="reference internal" href="#chay-file-bat-tu-t-sql">11.20. Chạy file .BAT từ T-SQL</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">SQL nâng cao</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="p02-03-sql-nang-cao.html">1. Pivot - Unpivot</a></li>
<li class="toctree-l1"><a class="reference internal" href="p02-03-sql-nang-cao.html#chia-mot-cot-thanh-nhieu-cot">2. Chia một cột thành nhiều cột</a></li>
<li class="toctree-l1"><a class="reference internal" href="p02-04-sqlcmd.html">3. SQLCMD</a></li>
<li class="toctree-l1"><a class="reference internal" href="p02-05-sql-project.html">4. SQL prọject</a></li>
</ul>
<p class="caption"><span class="caption-text">SQL &amp; Analytics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="p03-06-sql-va-excel.html">1. Kết nối SQL với Excel phục vụ báo cáo tự động</a></li>
<li class="toctree-l1"><a class="reference internal" href="p03-07-r-va-sql.html">2. R &amp; SQL Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="p03-08-r-server.html">3. SQL RServer</a></li>
</ul>
<p class="caption"><span class="caption-text">Xây dựng DataMart</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="p04-11-xay-dung-database.html">1. Xây dựng Data warehouse &amp; Data Mart</a></li>
</ul>
<p class="caption"><span class="caption-text">Tài liệu tham khảo:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="p09-79-tai-lieu-tham-khao.html">Tài liệu tham khảo</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Khai thác dữ liệu với SQL</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>11. Tricks khi dùng với SQL</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/p01-02-tricks-sql.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="tricks-khi-dung-voi-sql">
<h1>11. Tricks khi dùng với SQL<a class="headerlink" href="#tricks-khi-dung-voi-sql" title="Permalink to this headline">¶</a></h1>
<div class="section" id="du-lieu-bi-collate">
<h2>11.1. Dữ liệu bị collate<a class="headerlink" href="#du-lieu-bi-collate" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Khi làm việc, dữ liệu các bảng có thể bị convert định dạng khác nhau.
Trong trường hợp này, phải dùng <code class="docutils literal notranslate"><span class="pre">COLLATE</span> <span class="pre">DATABASE_DEFAULT</span></code></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span> <span class="n">top</span> <span class="mi">10</span> <span class="o">*</span> <span class="k">from</span>
<span class="n">INFORMATION_SCHEMA</span><span class="p">.</span><span class="n">columns</span>
<span class="k">where</span> <span class="k">table_name</span> <span class="k">COLLATE</span> <span class="n">DATABASE_DEFAULT</span> <span class="k">in</span> <span class="p">(</span><span class="k">select</span> <span class="n">new_table</span> <span class="k">COLLATE</span> <span class="n">DATABASE_DEFAULT</span>
<span class="k">from</span> <span class="n">table_rename</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="drop-nhieu-bang-theo-dieu-kien">
<h2>11.2. Drop nhiều bảng theo điều kiện<a class="headerlink" href="#drop-nhieu-bang-theo-dieu-kien" title="Permalink to this headline">¶</a></h2>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">declare</span> <span class="o">@</span><span class="n">string</span> <span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">)</span>
<span class="k">SET</span> <span class="o">@</span><span class="n">STRING</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="k">SELECT</span> <span class="o">@</span><span class="n">STRING</span> <span class="o">=</span> <span class="o">@</span><span class="n">STRING</span> <span class="o">+</span> <span class="s1">&#39;DROP TABLE ANALYTICS.DBO.&#39;</span> <span class="o">+</span> <span class="k">TABLE_NAME</span> <span class="o">+</span> <span class="s1">&#39;;&#39;</span>
<span class="k">FROM</span> <span class="n">ANALYTICS</span><span class="p">.</span><span class="n">INFORMATION_SCHEMA</span><span class="p">.</span><span class="n">TABLES</span>
<span class="k">WHERE</span> <span class="k">TABLE_NAME</span> <span class="k">like</span> <span class="s1">&#39;Mckinsey%&#39;</span>
<span class="k">exec</span> <span class="p">(</span><span class="o">@</span><span class="n">string</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="auto-wrap-in-mssql">
<h2>11.3. Auto Wrap in MSSQL<a class="headerlink" href="#auto-wrap-in-mssql" title="Permalink to this headline">¶</a></h2>
<p>Tools &gt;&gt; Options &gt;&gt; Text Editor &gt;&gt; Transact SQL &gt;&gt; General &gt;&gt; WordWrap</p>
</div>
<div class="section" id="format-dinh-dang-them-ky-tu-00-truoc-so">
<h2>11.4. Format định dạng thêm ký tự 00 trước số<a class="headerlink" href="#format-dinh-dang-them-ky-tu-00-truoc-so" title="Permalink to this headline">¶</a></h2>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span> <span class="n">FORMAT</span><span class="p">(</span><span class="mi">01</span><span class="p">,</span><span class="s1">&#39;00#&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="k">index</span>
</pre></div>
</div>
</div>
<div class="section" id="kiem-tra-dinh-dang-du-lieu-mot-bang">
<h2>11.5. Kiểm tra định dạng dữ liệu một bảng<a class="headerlink" href="#kiem-tra-dinh-dang-du-lieu-mot-bang" title="Permalink to this headline">¶</a></h2>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Với Link server</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">ANHNT67</span><span class="p">.</span><span class="k">DATA</span><span class="p">.</span><span class="n">INFORMATION_SCHEMA</span><span class="p">.</span><span class="n">COLUMNS</span> <span class="k">where</span> <span class="k">TABLE_NAME</span><span class="o">=</span><span class="s1">&#39;CARD_LIVE&#39;</span>

<span class="c1">-- Với Local</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">COLUMNS</span> <span class="k">where</span> <span class="k">TABLE_NAME</span><span class="o">=</span><span class="s1">&#39;CARD_LIVE&#39;</span>

<span class="c1">-- Kiểm tra toàn bộ thông tin</span>
<span class="n">sp_help</span> <span class="k">table_name</span>
<span class="n">sp_help</span> <span class="n">CARD_LIVE</span>
</pre></div>
</div>
</div>
<div class="section" id="convert-tu-tieng-viet-co-dau-sang-khong-dau">
<h2>11.6. Convert từ tiếng Việt có dấu sang không dấu<a class="headerlink" href="#convert-tu-tieng-viet-co-dau-sang-khong-dau" title="Permalink to this headline">¶</a></h2>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">FUNCTION</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">fChuyenCoDauThanhKhongDau</span><span class="p">](</span><span class="o">@</span><span class="n">inputVar</span> <span class="n">NVARCHAR</span><span class="p">(</span><span class="k">MAX</span><span class="p">)</span> <span class="p">)</span>
<span class="k">RETURNS</span> <span class="n">NVARCHAR</span><span class="p">(</span><span class="k">MAX</span><span class="p">)</span>
<span class="k">AS</span>
<span class="k">BEGIN</span>
    <span class="k">IF</span> <span class="p">(</span><span class="o">@</span><span class="n">inputVar</span> <span class="k">IS</span> <span class="k">NULL</span> <span class="k">OR</span> <span class="o">@</span><span class="n">inputVar</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>  <span class="k">RETURN</span> <span class="s1">&#39;&#39;</span>

    <span class="k">DECLARE</span> <span class="o">@</span><span class="n">RT</span> <span class="n">NVARCHAR</span><span class="p">(</span><span class="k">MAX</span><span class="p">)</span>
    <span class="k">DECLARE</span> <span class="o">@</span><span class="n">SIGN_CHARS</span> <span class="k">NCHAR</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span>
    <span class="k">DECLARE</span> <span class="o">@</span><span class="n">UNSIGN_CHARS</span> <span class="k">NCHAR</span> <span class="p">(</span><span class="mi">256</span><span class="p">)</span>

    <span class="k">SET</span> <span class="o">@</span><span class="n">SIGN_CHARS</span> <span class="o">=</span> <span class="n">N</span><span class="s1">&#39;ăâđêôơưàảãạáằẳẵặắầẩẫậấèẻẽẹéềểễệếìỉĩịíòỏõọóồổỗộốờởỡợớùủũụúừửữựứỳỷỹỵýĂÂĐÊÔƠƯÀẢÃẠÁẰẲẴẶẮẦẨẪẬẤÈẺẼẸÉỀỂỄỆẾÌỈĨỊÍÒỎÕỌÓỒỔỖỘỐỜỞỠỢỚÙỦŨỤÚỪỬỮỰỨỲỶỸỴÝ&#39;</span> <span class="o">+</span> <span class="k">NCHAR</span><span class="p">(</span><span class="mi">272</span><span class="p">)</span> <span class="o">+</span> <span class="k">NCHAR</span><span class="p">(</span><span class="mi">208</span><span class="p">)</span>
    <span class="k">SET</span> <span class="o">@</span><span class="n">UNSIGN_CHARS</span> <span class="o">=</span> <span class="n">N</span><span class="s1">&#39;aadeoouaaaaaaaaaaaaaaaeeeeeeeeeeiiiiiooooooooooooooouuuuuuuuuuyyyyyAADEOOUAAAAAAAAAAAAAAAEEEEEEEEEEIIIIIOOOOOOOOOOOOOOOUUUUUUUUUUYYYYYDD&#39;</span>

    <span class="k">DECLARE</span> <span class="o">@</span><span class="n">COUNTER</span> <span class="nb">int</span>
    <span class="k">DECLARE</span> <span class="o">@</span><span class="n">COUNTER1</span> <span class="nb">int</span>

    <span class="k">SET</span> <span class="o">@</span><span class="n">COUNTER</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">WHILE</span> <span class="p">(</span><span class="o">@</span><span class="n">COUNTER</span> <span class="o">&lt;=</span> <span class="n">LEN</span><span class="p">(</span><span class="o">@</span><span class="n">inputVar</span><span class="p">))</span>
    <span class="k">BEGIN</span>
        <span class="k">SET</span> <span class="o">@</span><span class="n">COUNTER1</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">WHILE</span> <span class="p">(</span><span class="o">@</span><span class="n">COUNTER1</span> <span class="o">&lt;=</span> <span class="n">LEN</span><span class="p">(</span><span class="o">@</span><span class="n">SIGN_CHARS</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">BEGIN</span>
            <span class="k">IF</span> <span class="n">UNICODE</span><span class="p">(</span><span class="k">SUBSTRING</span><span class="p">(</span><span class="o">@</span><span class="n">SIGN_CHARS</span><span class="p">,</span> <span class="o">@</span><span class="n">COUNTER1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="o">=</span> <span class="n">UNICODE</span><span class="p">(</span><span class="k">SUBSTRING</span><span class="p">(</span><span class="o">@</span><span class="n">inputVar</span><span class="p">,</span><span class="o">@</span><span class="n">COUNTER</span> <span class="p">,</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">BEGIN</span>
                <span class="k">IF</span> <span class="o">@</span><span class="n">COUNTER</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">SET</span> <span class="o">@</span><span class="n">inputVar</span> <span class="o">=</span> <span class="k">SUBSTRING</span><span class="p">(</span><span class="o">@</span><span class="n">UNSIGN_CHARS</span><span class="p">,</span> <span class="o">@</span><span class="n">COUNTER1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="k">SUBSTRING</span><span class="p">(</span><span class="o">@</span><span class="n">inputVar</span><span class="p">,</span> <span class="o">@</span><span class="n">COUNTER</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">LEN</span><span class="p">(</span><span class="o">@</span><span class="n">inputVar</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">ELSE</span>
                    <span class="k">SET</span> <span class="o">@</span><span class="n">inputVar</span> <span class="o">=</span> <span class="k">SUBSTRING</span><span class="p">(</span><span class="o">@</span><span class="n">inputVar</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">@</span><span class="n">COUNTER</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span><span class="k">SUBSTRING</span><span class="p">(</span><span class="o">@</span><span class="n">UNSIGN_CHARS</span><span class="p">,</span> <span class="o">@</span><span class="n">COUNTER1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="k">SUBSTRING</span><span class="p">(</span><span class="o">@</span><span class="n">inputVar</span><span class="p">,</span> <span class="o">@</span><span class="n">COUNTER</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">LEN</span><span class="p">(</span><span class="o">@</span><span class="n">inputVar</span><span class="p">)</span><span class="o">-</span> <span class="o">@</span><span class="n">COUNTER</span><span class="p">)</span>
                <span class="n">BREAK</span>
            <span class="k">END</span>
            <span class="k">SET</span> <span class="o">@</span><span class="n">COUNTER1</span> <span class="o">=</span> <span class="o">@</span><span class="n">COUNTER1</span> <span class="o">+</span><span class="mi">1</span>
        <span class="k">END</span>
        <span class="k">SET</span> <span class="o">@</span><span class="n">COUNTER</span> <span class="o">=</span> <span class="o">@</span><span class="n">COUNTER</span> <span class="o">+</span><span class="mi">1</span>
    <span class="k">END</span>
    <span class="c1">-- SET @inputVar = replace(@inputVar,&#39; &#39;,&#39;-&#39;)</span>
    <span class="k">RETURN</span> <span class="o">@</span><span class="n">inputVar</span>
<span class="k">END</span>
</pre></div>
</div>
<ul class="simple">
<li>Ví dụ</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span> <span class="n">dbo</span><span class="p">.</span><span class="n">fChuyenCoDauThanhKhongDau</span><span class="p">(</span><span class="n">N</span><span class="s1">&#39;Một thiên thần&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="sua-default-template-trong-sql">
<h2>11.7. Sửa default template trong SQL<a class="headerlink" href="#sua-default-template-trong-sql" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Sửa file <code class="docutils literal notranslate"><span class="pre">SQLfile.sql</span></code> tại đường dẫn sau
<code class="docutils literal notranslate"><span class="pre">C:\Program</span> <span class="pre">Files</span> <span class="pre">(x86)\Microsoft</span> <span class="pre">SQL</span> <span class="pre">Server\130\Tools\Binn\ManagementStudio\SqlWorkbenchProjectItems\Sql</span></code></li>
<li>Nội dung default script</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="cm">/********************************</span>
<span class="cm">Script:         Giao dịch Ebanking</span>
<span class="cm">Author:         AnhHD3</span>
<span class="cm">Created date:   20180701</span>
<span class="cm">Modifed date:   20181127</span>
<span class="cm">========================================</span>
<span class="cm">Description: Create Data Preparation</span>
<span class="cm">for datamart</span>
<span class="cm">========================================</span>
<span class="cm">Affected tables:</span>
<span class="cm">    - [dbo].[POS_ECOMCARD_2017]</span>

<span class="cm">Steps:</span>
<span class="cm">    - Step 1: Declare date</span>
<span class="cm">    - Step 2:</span>
<span class="cm">        - POS transaction</span>
<span class="cm">        - ATM/CDM transaction</span>
<span class="cm">*********************************/</span>
<span class="k">SELECT</span> <span class="n">TOP</span> <span class="mi">1</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">XXX</span>
</pre></div>
</div>
</div>
<div class="section" id="bat-dau-tem-bang-voi-dim">
<h2>11.8. Bắt đầu têm bảng với DIM<a class="headerlink" href="#bat-dau-tem-bang-voi-dim" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Tên các bảng thường bắt đầu bằng Dim - viết tắt của Dimension</li>
</ul>
</div>
<div class="section" id="xoa-bang-neu-ton-tai">
<h2>11.9. Xóa bảng nếu tồn tại<a class="headerlink" href="#xoa-bang-neu-ton-tai" title="Permalink to this headline">¶</a></h2>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">drop</span> <span class="k">table</span> <span class="k">if</span> <span class="k">exists</span> <span class="n">CROSS_SELLING_RESULTS</span>
</pre></div>
</div>
</div>
<div class="section" id="tim-kiem-kieu-du-lieu-trong-bang-cua-db">
<h2>11.10. Tìm kiếm kiểu dữ liệu trong bảng của db<a class="headerlink" href="#tim-kiem-kieu-du-lieu-trong-bang-cua-db" title="Permalink to this headline">¶</a></h2>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Kiểm tra thông tin kiểu dữ liệu trong bảng</span>
<span class="k">select</span> <span class="k">table_name</span><span class="p">,</span> <span class="k">column_name</span><span class="p">,</span> <span class="n">data_type</span> <span class="k">from</span> <span class="p">[</span><span class="n">learningsql</span><span class="p">].[</span><span class="n">INFORMATION_SCHEMA</span><span class="p">].[</span><span class="n">columns</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="su-dung-drop-va-create-trong-cung-batch">
<h2>11.11. Sử dụng drop và create trong cùng batch<a class="headerlink" href="#su-dung-drop-va-create-trong-cung-batch" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>DROP và CREATE không thể chạy cùng trong 1 batch, khi muốn sử dụng
phải thêm câu lệnh GO</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">drop</span> <span class="k">table</span> <span class="k">if</span> <span class="k">exists</span> <span class="o">#</span><span class="n">temp</span>
<span class="k">GO</span>

<span class="k">create</span> <span class="k">table</span> <span class="o">#</span><span class="n">temp</span><span class="p">(</span><span class="n">abc</span> <span class="nb">int</span><span class="p">)</span>
<span class="k">insert</span> <span class="k">into</span> <span class="o">#</span><span class="n">temp</span><span class="p">(</span><span class="n">abc</span><span class="p">)</span>
<span class="k">values</span> <span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="k">GO</span>
</pre></div>
</div>
</div>
<div class="section" id="phan-biet-dinh-dang-integer">
<h2>11.12. Phân biệt định dạng integer<a class="headerlink" href="#phan-biet-dinh-dang-integer" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>SQL không phân biệt được định dạng numeric &amp; integer ngay lập tức</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span> <span class="mi">7</span><span class="o">/</span><span class="mi">10</span>  <span class="c1">-- Trả kết quả 0</span>

<span class="c1">--So sánh</span>

<span class="k">select</span> <span class="mi">7</span><span class="p">.</span><span class="mi">0</span><span class="o">/</span><span class="mi">10</span> <span class="c1">-- Chạy đúng</span>
</pre></div>
</div>
</div>
<div class="section" id="varchar-vs-nvarchar">
<h2>11.13. VARCHAR vs.&nbsp;NVARCHAR<a class="headerlink" href="#varchar-vs-nvarchar" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>varchar vs.&nbsp;nvarchar: nvarchar cho phép lưu trữ ký tự Unicode,
varchar không cho phép</li>
<li>varchar(n) vs.&nbsp;varchar(max):</li>
</ul>
<table border="1" class="docutils">
<colgroup>
<col width="42%" />
<col width="58%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">varchar(n)</th>
<th class="head">varchar(max)</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Tối đa 8000 ký tự</td>
<td>Tối đa hơn 2 tỷ, khoảng 2G</td>
</tr>
<tr class="row-odd"><td>Cho phép tạo index</td>
<td>Không cho phép tạo index</td>
</tr>
</tbody>
</table>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">--Varchar(50): Work</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">dbo</span><span class="p">.</span><span class="n">Employee</span>
<span class="p">(</span><span class="n">id</span> <span class="nb">INT</span> <span class="k">identity</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
   <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
 <span class="n">Name</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>
<span class="k">GO</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">IX_EmployeeName</span>
 <span class="k">ON</span> <span class="n">dbo</span><span class="p">.</span><span class="n">Employee</span><span class="p">(</span><span class="n">Name</span><span class="p">)</span>
<span class="k">GO</span>

<span class="c1">--Varchar(max): Not work</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">dbo</span><span class="p">.</span><span class="n">Employee</span>
<span class="p">(</span><span class="n">id</span> <span class="nb">INT</span> <span class="k">identity</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
   <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
 <span class="n">Name</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="k">Max</span><span class="p">))</span>
<span class="k">GO</span>
<span class="k">CREATE</span> <span class="k">INDEX</span> <span class="n">IX_EmployeeName</span>
 <span class="k">ON</span> <span class="n">dbo</span><span class="p">.</span><span class="n">Employee</span><span class="p">(</span><span class="n">Name</span><span class="p">)</span>
<span class="k">GO</span>
</pre></div>
</div>
</div>
<div class="section" id="primary-key-vs-unique-key">
<h2>11.14. Primary key vs.&nbsp;Unique key<a class="headerlink" href="#primary-key-vs-unique-key" title="Permalink to this headline">¶</a></h2>
<table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="37%" />
<col width="50%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Tiêu
chí</th>
<th class="head">Primary key</th>
<th class="head">Unique key</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>NULL</td>
<td>Không cho phép null</td>
<td>Cho phép MỘT giá trị NULL</td>
</tr>
<tr class="row-odd"><td>Index</td>
<td>Default là clustered
index</td>
<td>Default là unique non-cluster
index</td>
</tr>
<tr class="row-even"><td>Limit</td>
<td>Chỉ có 1 key</td>
<td>Có thể có nhiều key</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="exec-vs-exec">
<h2>11.15. EXEC vs.&nbsp;EXEC()<a class="headerlink" href="#exec-vs-exec" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Exec dùng để thực hiện các procedure. VD: <code class="docutils literal notranslate"><span class="pre">exec</span> <span class="pre">sp_pivot</span></code></li>
<li>Exec() dùng để thực hiện dinamic SQL.</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">exec</span><span class="p">(</span><span class="s1">&#39;Select top 10 * from @table&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="xem-tat-ca-cac-user-defined-procedure">
<h2>11.16. Xem tất cả các user-defined procedure<a class="headerlink" href="#xem-tat-ca-cac-user-defined-procedure" title="Permalink to this headline">¶</a></h2>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">name</span><span class="p">,</span>
       <span class="k">type</span>
  <span class="k">FROM</span> <span class="n">dbo</span><span class="p">.</span><span class="n">sysobjects</span>
 <span class="k">WHERE</span> <span class="p">(</span><span class="k">type</span> <span class="o">=</span> <span class="s1">&#39;P&#39;</span><span class="p">)</span> <span class="k">and</span>
 <span class="n">name</span> <span class="k">like</span> <span class="s1">&#39;u%&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="lam-viec-voi-link-server">
<h2>11.17. Làm việc với link server<a class="headerlink" href="#lam-viec-voi-link-server" title="Permalink to this headline">¶</a></h2>
<p><strong>Vấn đề</strong>: Cách link server thủ công (GUI) có thể sẽ gặp vấn đề khi
cùng lúc làm việc với nhiều server. Ta có thể sử dụng T-SQL để làm việc
với link server như sau</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Bước 1: Tạo link server</span>

<span class="k">EXEC</span> <span class="n">sp_addlinkedserver</span>
   <span class="o">@</span><span class="n">server</span><span class="o">=</span><span class="s1">&#39;RBD&#39;</span><span class="p">,</span>
   <span class="o">@</span><span class="n">srvproduct</span><span class="o">=</span><span class="n">N</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
   <span class="o">@</span><span class="n">provider</span><span class="o">=</span><span class="n">N</span><span class="s1">&#39;SQLNCLI&#39;</span><span class="p">,</span>
   <span class="o">@</span><span class="n">datasrc</span><span class="o">=</span><span class="s1">&#39;10.39.200.204&#39;</span>

<span class="c1">-- Bước 2: Tạo password</span>

<span class="k">EXEC</span> <span class="n">sp_addlinkedsrvlogin</span>
  <span class="o">@</span><span class="n">rmtsrvname</span> <span class="o">=</span><span class="s1">&#39;RBD&#39;</span>
<span class="p">,</span> <span class="o">@</span><span class="n">useself</span> <span class="o">=</span> <span class="s1">&#39;FALSE&#39;</span>
<span class="p">,</span> <span class="o">@</span><span class="n">rmtuser</span> <span class="o">=</span> <span class="s1">&#39;bic_user&#39;</span>
<span class="p">,</span> <span class="o">@</span><span class="n">rmtpassword</span> <span class="o">=</span> <span class="s1">&#39;bic_user&#39;</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Kiểm tra tất cả link server</span>
<span class="n">sp_helpserver</span>

<span class="c1">-- Xóa link server RBD</span>
<span class="n">sp_dropserver</span> <span class="s1">&#39;RBD&#39;</span><span class="p">,</span> <span class="s1">&#39;droplogins&#39;</span><span class="p">;</span>
</pre></div>
</div>
<div class="section" id="procedure-tao-nhieu-link-server">
<h3>11.17.1. Procedure tạo nhiều link server<a class="headerlink" href="#procedure-tao-nhieu-link-server" title="Permalink to this headline">¶</a></h3>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">drop</span> <span class="k">procedure</span> <span class="k">if</span> <span class="k">exists</span> <span class="n">u_createlinkserver</span>
<span class="k">GO</span>
<span class="k">create</span> <span class="k">procedure</span> <span class="n">u_createlinkserver</span>
    <span class="o">@</span><span class="n">name</span> <span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">),</span>
    <span class="o">@</span><span class="k">source</span> <span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">),</span>
    <span class="o">@</span><span class="k">user</span> <span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">),</span>
    <span class="o">@</span><span class="n">password</span> <span class="n">nvarchar</span><span class="p">(</span><span class="k">max</span><span class="p">)</span>
<span class="k">as</span>

<span class="k">BEGIN</span>
    <span class="k">EXEC</span> <span class="n">sp_addlinkedserver</span>
       <span class="o">@</span><span class="n">server</span><span class="o">=@</span><span class="n">name</span><span class="p">,</span>
       <span class="o">@</span><span class="n">srvproduct</span><span class="o">=</span><span class="n">N</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
       <span class="o">@</span><span class="n">provider</span><span class="o">=</span><span class="n">N</span><span class="s1">&#39;SQLNCLI&#39;</span><span class="p">,</span>
       <span class="o">@</span><span class="n">datasrc</span><span class="o">=@</span><span class="k">source</span><span class="p">;</span>

    <span class="k">EXEC</span> <span class="n">sp_addlinkedsrvlogin</span>
      <span class="o">@</span><span class="n">rmtsrvname</span> <span class="o">=</span> <span class="o">@</span><span class="n">name</span>
    <span class="p">,</span> <span class="o">@</span><span class="n">useself</span> <span class="o">=</span> <span class="s1">&#39;FALSE&#39;</span>
    <span class="p">,</span> <span class="o">@</span><span class="n">rmtuser</span> <span class="o">=</span> <span class="o">@</span><span class="k">user</span>
    <span class="p">,</span> <span class="o">@</span><span class="n">rmtpassword</span> <span class="o">=</span> <span class="o">@</span><span class="n">password</span>
<span class="k">END</span>
</pre></div>
</div>
<p><strong>Ví dụ</strong>:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">exec</span> <span class="n">u_createlinkserver</span>
    <span class="o">@</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;RBD&#39;</span><span class="p">,</span>
    <span class="o">@</span><span class="k">source</span><span class="o">=</span><span class="s1">&#39;10.39.200.204&#39;</span><span class="p">,</span>
    <span class="o">@</span><span class="k">user</span> <span class="o">=</span> <span class="s1">&#39;bic_user&#39;</span><span class="p">,</span>
    <span class="o">@</span><span class="n">password</span> <span class="o">=</span> <span class="s1">&#39;bic_user&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="tim-tat-ca-cac-bang-cot-trong-database">
<h2>11.18. Tìm tất cả các bảng, cột trong Database<a class="headerlink" href="#tim-tat-ca-cac-bang-cot-trong-database" title="Permalink to this headline">¶</a></h2>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="s1">&#39;SERVER_74&#39;</span> <span class="k">as</span> <span class="n">SERVER</span><span class="p">,</span>
        <span class="s1">&#39;BICDATA&#39;</span> <span class="k">as</span> <span class="n">DATA_BASE</span><span class="p">,</span>
        <span class="n">lst</span><span class="p">.</span><span class="n">name</span> <span class="k">AS</span> <span class="k">Table_Name</span><span class="p">,</span>
        <span class="n">lsc</span><span class="p">.</span><span class="n">name</span> <span class="k">AS</span> <span class="k">Column_Name</span><span class="p">,</span>
        <span class="n">lsc</span><span class="p">.</span><span class="n">max_length</span> <span class="k">as</span> <span class="n">Max_Length</span>
<span class="k">FROM</span> <span class="p">[</span><span class="n">M74</span><span class="p">].[</span><span class="n">BICDATA</span><span class="p">].[</span><span class="n">sys</span><span class="p">].[</span><span class="n">tables</span><span class="p">]</span> <span class="n">lst</span>
    <span class="k">INNER</span> <span class="k">JOIN</span> <span class="p">[</span><span class="n">M74</span><span class="p">].[</span><span class="n">BICDATA</span><span class="p">].[</span><span class="n">sys</span><span class="p">].[</span><span class="n">columns</span><span class="p">]</span> <span class="n">lsc</span>
        <span class="k">ON</span> <span class="n">lst</span><span class="p">.</span><span class="n">OBJECT_ID</span><span class="o">=</span><span class="n">lsc</span><span class="p">.</span><span class="n">object_id</span>
<span class="k">union</span>
<span class="k">SELECT</span> <span class="s1">&#39;SERVER_16&#39;</span> <span class="k">as</span> <span class="n">SERVER</span><span class="p">,</span>
       <span class="s1">&#39;VPB_WHR2&#39;</span> <span class="k">as</span> <span class="n">DATA_BASE</span><span class="p">,</span>
       <span class="n">lst</span><span class="p">.</span><span class="n">name</span> <span class="k">AS</span> <span class="k">Table_Name</span><span class="p">,</span>
       <span class="n">lsc</span><span class="p">.</span><span class="n">name</span> <span class="k">AS</span> <span class="k">Column_Name</span><span class="p">,</span>
       <span class="n">lsc</span><span class="p">.</span><span class="n">max_length</span> <span class="k">as</span> <span class="n">Max_Length</span>
<span class="k">FROM</span> <span class="p">[</span><span class="n">M16</span><span class="p">].[</span><span class="n">VPB_WHR2</span><span class="p">].[</span><span class="n">sys</span><span class="p">].[</span><span class="n">tables</span><span class="p">]</span> <span class="n">lst</span>
    <span class="k">INNER</span> <span class="k">JOIN</span> <span class="p">[</span><span class="n">M16</span><span class="p">].[</span><span class="n">VPB_WHR2</span><span class="p">].[</span><span class="n">sys</span><span class="p">].[</span><span class="n">columns</span><span class="p">]</span> <span class="n">lsc</span>
        <span class="k">ON</span> <span class="n">lst</span><span class="p">.</span><span class="n">OBJECT_ID</span><span class="o">=</span><span class="n">lsc</span><span class="p">.</span><span class="n">object_id</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">DATA_BASE</span><span class="p">,</span> <span class="n">lst</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">lsc</span><span class="p">.</span><span class="n">name</span>
</pre></div>
</div>
</div>
<div class="section" id="cac-luu-y-giup-tang-toc-do-truy-van">
<h2>11.19. Các lưu ý giúp tăng tốc độ truy vấn<a class="headerlink" href="#cac-luu-y-giup-tang-toc-do-truy-van" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Không nên dùng select *, sẽ tốn tài nguyên</li>
<li>Không dùng distinct, gây chậm câu lệnh</li>
<li>Khi dùng câu lệnh UNION, kết quả tương tự như SELECT DISTINCT. Do đó
nếu biết chắc rằng không có 1 hàng nào trùng lắp được tạo ra từ kết
quả của UNION thì ta nên sử dụng câu lệnh UNION ALL.</li>
<li>Ưu tiên sử dụng câu lệnh theo mức độ ưu tiên: IN &gt;&gt; OR, EXISTS &gt;&gt; IN,
BETWEEN &gt;&gt; IN</li>
<li>Khi truy vấn, phải đảm bảo điều kiệu sargable (search argument able):<ul>
<li>Tránh sử dụng function trong điều kiện where</li>
<li>Các cột nào là index nên đưa vào trước</li>
</ul>
</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">--VD 1</span>
<span class="c1">-- câu lệnh 1 (non-sargable)</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">Sales</span><span class="p">.</span><span class="n">Individual</span>
<span class="k">WHERE</span> <span class="n">CustomerID</span><span class="o">+</span><span class="mi">2</span> <span class="o">=</span> <span class="mi">11002</span>

<span class="c1">-- câu lệnh 2 (sargable)</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">Sales</span><span class="p">.</span><span class="n">Individual</span>
<span class="k">WHERE</span> <span class="n">CustomerID</span> <span class="o">=</span> <span class="mi">11000</span>

<span class="c1">----</span>
<span class="c1">--VD2</span>
<span class="c1">-- Câu lệnh 1: Non-sargable</span>
<span class="k">SELECT</span> <span class="n">member_number</span><span class="p">,</span> <span class="n">first_name</span><span class="p">,</span> <span class="n">last_name</span>
<span class="k">FROM</span> <span class="n">members</span>
<span class="k">WHERE</span> <span class="n">DATEDIFF</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span><span class="n">datofbirth</span><span class="p">,</span><span class="n">GETDATE</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">21</span>

<span class="c1">-- Câu lệnh 2: Sargable</span>
<span class="k">SELECT</span> <span class="n">member_number</span><span class="p">,</span> <span class="n">first_name</span><span class="p">,</span> <span class="n">last_name</span>
<span class="k">FROM</span> <span class="n">members</span>
<span class="k">WHERE</span> <span class="n">dateofbirth</span> <span class="o">&lt;</span> <span class="n">DATEADD</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span><span class="o">-</span><span class="mi">21</span><span class="p">,</span><span class="n">GETDATE</span><span class="p">())</span>
</pre></div>
</div>
<ul class="simple">
<li>Khi dùng IN, có thể thay thế bằng UNION ALL</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Câu lệnh 1: 242 ms</span>
<span class="k">set</span> <span class="k">statistics</span> <span class="n">time</span> <span class="k">on</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="p">[</span><span class="n">CUSTOMER</span> <span class="o">-</span> <span class="n">M74</span> <span class="o">-</span> <span class="n">BICDATA</span><span class="p">]</span> <span class="k">where</span> <span class="n">cus_name</span> <span class="k">like</span> <span class="s1">&#39;VO%&#39;</span> <span class="k">or</span> <span class="n">cus_name</span> <span class="k">like</span> <span class="s1">&#39;%PHAN%&#39;</span>

<span class="c1">-- Câu lệnh 2: 172 ms</span>
<span class="k">set</span> <span class="k">statistics</span> <span class="n">time</span> <span class="k">on</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="p">[</span><span class="n">CUSTOMER</span> <span class="o">-</span> <span class="n">M74</span> <span class="o">-</span> <span class="n">BICDATA</span><span class="p">]</span> <span class="k">where</span> <span class="n">cus_name</span> <span class="k">like</span> <span class="s1">&#39;VO%&#39;</span>
<span class="k">union</span> <span class="k">all</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="p">[</span><span class="n">CUSTOMER</span> <span class="o">-</span> <span class="n">M74</span> <span class="o">-</span> <span class="n">BICDATA</span><span class="p">]</span> <span class="k">where</span> <span class="n">cus_name</span> <span class="k">like</span> <span class="s1">&#39;%PHAN%&#39;</span>
</pre></div>
</div>
<ul class="simple">
<li>Khi muốn xác định sự tồn tại của 1 record, không nên dùng count(*),
nên dùng if exists</li>
<li>Dùng hàm tính toán tổng hợp với IN</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Câu lệnh 1: 18 ms</span>
<span class="k">set</span> <span class="k">statistics</span> <span class="n">time</span> <span class="k">on</span>
<span class="k">SELECT</span> <span class="k">MIN</span><span class="p">(</span><span class="n">IntDataColumn</span><span class="p">)</span>
  <span class="k">FROM</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">Parent</span><span class="p">]</span>
 <span class="k">WHERE</span> <span class="n">ParentID</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">TOP</span> <span class="mi">2</span> <span class="n">ParentID</span>
                      <span class="k">FROM</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">Parent</span><span class="p">]</span>
                    <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">IntDataColumn</span> <span class="k">DESC</span><span class="p">)</span>

<span class="c1">-- Câu lệnh 2: 0 ms</span>
<span class="k">set</span> <span class="k">statistics</span> <span class="n">time</span> <span class="k">on</span>
<span class="k">SELECT</span> <span class="k">MIN</span><span class="p">(</span><span class="n">IntDataColumn</span><span class="p">)</span>
  <span class="k">FROM</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">TOP</span> <span class="mi">2</span> <span class="n">IntDataColumn</span>
          <span class="k">FROM</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">Parent</span><span class="p">]</span>
        <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">IntDataColumn</span> <span class="k">DESC</span><span class="p">)</span> <span class="k">AS</span> <span class="n">A</span>
</pre></div>
</div>
</div>
<div class="section" id="chay-file-bat-tu-t-sql">
<h2>11.20. Chạy file .BAT từ T-SQL<a class="headerlink" href="#chay-file-bat-tu-t-sql" title="Permalink to this headline">¶</a></h2>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">sp_configure</span> <span class="s1">&#39;show advanced options&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span>
<span class="n">RECONFIGURE</span>
<span class="n">sp_configure</span> <span class="s1">&#39;xp_cmdshell&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span>
<span class="n">RECONFIGURE</span>
</pre></div>
</div>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">EXEC</span> <span class="n">xp_cmdshell</span> <span class="s1">&#39;cmd /c &quot;F:\D\my_file.bat&quot;&#39;</span>
</pre></div>
</div>
<p><strong>Lưu ý</strong>: Cách sử dụng <code class="docutils literal notranslate"><span class="pre">xp_cmdshell</span></code> khắc phục được nhược điểm của
<code class="docutils literal notranslate"><span class="pre">sqlcmd</span></code>, cho phép đặt job với file <code class="docutils literal notranslate"><span class="pre">bat</span></code></p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="p02-03-sql-nang-cao.html" class="btn btn-neutral float-right" title="1. Pivot - Unpivot" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="p01-01-sql-co-ban.html" class="btn btn-neutral float-left" title="1. Giới thiệu về SQL" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Anh Hoang Duc

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>