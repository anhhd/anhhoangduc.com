

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="vi" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="vi" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>3. SQL RServer &mdash; Tài liệu Khai thác dữ liệu với SQL 2019</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'./',
              VERSION:'2019',
              LANGUAGE:'vi',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
        <script type="text/javascript" src="_static/copybutton.js"></script>
        <script type="text/javascript" src="_static/translations.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/copybutton.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Tìm Kiếm" href="search.html" />
    <link rel="next" title="1. Xây dựng Data warehouse &amp; Data Mart" href="p04-11-xay-dung-database.html" />
    <link rel="prev" title="2. R &amp; SQL Server" href="p03-07-r-va-sql.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Khai thác dữ liệu với SQL
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">SQL cơ bản</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="p01-01-sql-co-ban.html">1. Giới thiệu về SQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="p01-01-sql-co-ban.html#cac-nhom-cau-lenh-truy-van-tong-hop">2. Các nhóm câu lệnh truy vấn, tổng hợp</a></li>
<li class="toctree-l1"><a class="reference internal" href="p01-01-sql-co-ban.html#cac-nhom-cau-lenh-thay-doi-du-lieu-trong-csdl">3. Các nhóm câu lệnh thay đổi dữ liệu trong CSDL</a></li>
<li class="toctree-l1"><a class="reference internal" href="p01-01-sql-co-ban.html#sub-query">4. Sub Query</a></li>
<li class="toctree-l1"><a class="reference internal" href="p01-01-sql-co-ban.html#cac-nhom-cau-lenh-co-ban-khac">5. Các nhóm câu lệnh cơ bản khác</a></li>
<li class="toctree-l1"><a class="reference internal" href="p01-01-sql-co-ban.html#sql-dong-voi-exec">6. SQL động với Exec</a></li>
<li class="toctree-l1"><a class="reference internal" href="p01-01-sql-co-ban.html#ham-va-thu-tuc">7. Hàm và thủ tục</a></li>
<li class="toctree-l1"><a class="reference internal" href="p01-01-sql-co-ban.html#cac-nhom-cau-lenh-nang-cao">8. Các nhóm câu lệnh nâng cao</a></li>
<li class="toctree-l1"><a class="reference internal" href="p01-01-sql-co-ban.html#dat-job-trong-sql">9. Đặt job trong SQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="p01-01-sql-co-ban.html#cac-nhom-cau-lenh-quan-tri">10. Các nhóm câu lệnh quản trị</a></li>
<li class="toctree-l1"><a class="reference internal" href="p01-02-tricks-sql.html">11. Tricks khi dùng với SQL</a></li>
</ul>
<p class="caption"><span class="caption-text">SQL nâng cao</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="p02-03-sql-nang-cao.html">1. Pivot - Unpivot</a></li>
<li class="toctree-l1"><a class="reference internal" href="p02-03-sql-nang-cao.html#chia-mot-cot-thanh-nhieu-cot">2. Chia một cột thành nhiều cột</a></li>
<li class="toctree-l1"><a class="reference internal" href="p02-04-sqlcmd.html">3. SQLCMD</a></li>
<li class="toctree-l1"><a class="reference internal" href="p02-05-sql-project.html">4. SQL prọject</a></li>
</ul>
<p class="caption"><span class="caption-text">SQL &amp; Analytics</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="p03-06-sql-va-excel.html">1. Kết nối SQL với Excel phục vụ báo cáo tự động</a></li>
<li class="toctree-l1"><a class="reference internal" href="p03-07-r-va-sql.html">2. R &amp; SQL Server</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">3. SQL RServer</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#cai-dat-r-server-trong-sql2016">3.1. Cài đặt R Server trong SQL2016</a></li>
<li class="toctree-l2"><a class="reference internal" href="#cai-dat-library-trong-sql-r-services">3.2. Cài đặt library trong SQL-R Services</a></li>
<li class="toctree-l2"><a class="reference internal" href="#cai-dat-sql-rserver-9-1">3.3. Cài đặt SQL RServer 9.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="#thuc-hien-cau-lenh-r-trong-sql">3.4. Thực hiện câu lệnh R trong SQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="#tao-procedure-de-chay-association-rule">3.5. Tạo procedure để chạy Association Rule</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ket-noi-voi-sqlrserver">3.6. Kết nối với SQLRServer</a></li>
<li class="toctree-l2"><a class="reference internal" href="#data-thuc-hien-case-study">3.7. Data thực hiện case study</a></li>
<li class="toctree-l2"><a class="reference internal" href="#tai-lieu-tham-khao">3.8. Tài liệu tham khảo</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Xây dựng DataMart</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="p04-11-xay-dung-database.html">1. Xây dựng Data warehouse &amp; Data Mart</a></li>
</ul>
<p class="caption"><span class="caption-text">Tài liệu tham khảo:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="p09-79-tai-lieu-tham-khao.html">Tài liệu tham khảo</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Khai thác dữ liệu với SQL</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>3. SQL RServer</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/p03-08-r-server.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="sql-rserver">
<h1>3. SQL RServer<a class="headerlink" href="#sql-rserver" title="Permalink to this headline">¶</a></h1>
<p>Từ SQL 2016, Microsoft hỗ trợ R-server trong database, bao gồm hai cấu
phần:</p>
<ul class="simple">
<li>RServer: Sử dụng bản <code class="docutils literal notranslate"><span class="pre">Revolution</span> <span class="pre">Analytics</span></code> để thực hiện
<code class="docutils literal notranslate"><span class="pre">in</span> <span class="pre">database</span> <span class="pre">analytics</span></code></li>
<li>RService: Hỗ trợ chạy <code class="docutils literal notranslate"><span class="pre">R</span></code> song song với <code class="docutils literal notranslate"><span class="pre">SQL</span></code> trong SQLServer</li>
</ul>
<div class="section" id="cai-dat-r-server-trong-sql2016">
<h2>3.1. Cài đặt R Server trong SQL2016<a class="headerlink" href="#cai-dat-r-server-trong-sql2016" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><strong>Bước 1</strong>: Chạy câu lệnh sau để cho phép chạy external scripts</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">Exec</span> <span class="n">sp_configure</span>  <span class="s1">&#39;external scripts enabled&#39;</span><span class="p">,</span> <span class="mi">1</span>
<span class="n">Reconfigure</span>  <span class="k">with</span>  <span class="n">override</span>
</pre></div>
</div>
<ul class="simple">
<li><strong>Bước 2</strong>: Restart SQLServer &amp; SQLServer Launch Pad (SQLServer
Configuration Manager)</li>
<li><strong>Bước 3</strong>: Kiểm tra lại để chắc chắn “external scripts enabled” có
giá trị bằng 1</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">Exec</span> <span class="n">sp_configure</span>  <span class="s1">&#39;external scripts enabled&#39;</span>
</pre></div>
</div>
<p><img alt="image0" src="Images/r-server-1.png" /></p>
<ul class="simple">
<li><strong>Bước 4</strong>: Cài đặt nâng cao dung lượng RAM tối đa khi sử dụng</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">--Kiểm tra dung lượng RAM</span>
<span class="k">SELECT</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="n">sys</span><span class="p">.</span><span class="n">resource_governor_external_resource_pools</span>
<span class="k">WHERE</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;default&#39;</span>
<span class="c1">--Alter Pool</span>
<span class="k">ALTER</span> <span class="n">RESOURCE</span> <span class="n">POOL</span> <span class="ss">&quot;default&quot;</span> <span class="k">WITH</span> <span class="p">(</span><span class="n">max_memory_percent</span> <span class="o">=</span> <span class="mi">20</span><span class="p">);</span>
<span class="c1">--Điều chỉnh dung lượng RAM</span>
<span class="k">ALTER</span> <span class="k">EXTERNAL</span> <span class="n">RESOURCE</span> <span class="n">POOL</span> <span class="ss">&quot;default&quot;</span> <span class="k">WITH</span> <span class="p">(</span><span class="n">max_memory_percent</span> <span class="o">=</span> <span class="mi">90</span><span class="p">);</span>
<span class="c1">--Kiểm tra lại</span>
<span class="k">ALTER</span> <span class="n">RESOURCE</span> <span class="n">GOVERNOR</span> <span class="n">reconfigure</span><span class="p">;</span>
</pre></div>
</div>
<p>Kết quả hiển thị như sau:</p>
<p><img alt="image1" src="Images/r-server-2.png" /></p>
</div>
<div class="section" id="cai-dat-library-trong-sql-r-services">
<h2>3.2. Cài đặt library trong SQL-R Services<a class="headerlink" href="#cai-dat-library-trong-sql-r-services" title="Permalink to this headline">¶</a></h2>
<p><strong>Cách 1</strong>:</p>
<ul class="simple">
<li><strong>Bước 1</strong>: Truy cập vào</li>
</ul>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1">#Cài đặt R Services</span>
<span class="n">C</span><span class="o">:</span><span class="n">\Program</span> <span class="n">Files\Microsoft</span> <span class="n">SQL</span> <span class="n">Server\MSSQL13.ANHHD\R_SERVICES</span>
<span class="c1">#Cài đặt R cho Visual Studio</span>
<span class="n">C</span><span class="o">:</span><span class="n">\Program</span> <span class="n">Files\Microsoft</span> <span class="n">SQL\Server\130\R_SERVER\library\base\R</span>
<span class="c1">#Cài đặt cho R server 9.0.1 or higher</span>
<span class="n">C</span><span class="o">:</span><span class="n">\Program</span> <span class="n">Files\Microsoft\R</span> <span class="n">Server\R_SERVER\library\base\R</span>
</pre></div>
</div>
<p><strong>Lưu ý</strong>: Sử dụng đường dẫn vào <strong>R_SERVICES</strong></p>
<ul class="simple">
<li><strong>Bước 2</strong>: Thêm đường dẫn vào library vào file .Rprofile</li>
</ul>
<p><strong>Cách 2</strong>:</p>
<ul class="simple">
<li>Cài đặt library muốn cài vào 1 thư mục. Ví dụ</li>
</ul>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">.libPaths</span><span class="p">(</span><span class="s">&quot;D:/sqlrlibrary&quot;</span><span class="p">)</span>
<span class="nf">install.packages</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;tidyverse&quot;</span><span class="p">,</span> <span class="s">&quot;arules&quot;</span><span class="p">))</span>
</pre></div>
</div>
<ul class="simple">
<li>Copy toàn bộ library trong thư mục vừa tạo vào library của Rservice</li>
</ul>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1">#Cài đặt R Services</span>
<span class="n">C</span><span class="o">:</span><span class="n">\Program</span> <span class="n">Files\Microsoft</span> <span class="n">SQL</span> <span class="n">Server\MSSQL13.MSSQLSERVER\R_SERVICES\library</span>
</pre></div>
</div>
</div>
<div class="section" id="cai-dat-sql-rserver-9-1">
<h2>3.3. Cài đặt SQL RServer 9.1<a class="headerlink" href="#cai-dat-sql-rserver-9-1" title="Permalink to this headline">¶</a></h2>
<p><strong>Các bước thực hiện</strong>:</p>
<ul class="simple">
<li>Update bản Service Pack Cumulative Update 3 hoặc higher (file
<strong>SQLServer2016-KB4013105-x64</strong>)</li>
<li>Caì đặt SQL RServer 9.0.1 (foler
<strong>en_r_server_901_for_windows_x64_9649035</strong>)<ul>
<li>Chạy cmd với quyền Admin</li>
<li>Thực hiện câu lệnh sau</li>
</ul>
</li>
</ul>
<div class="highlight-cmd notranslate"><div class="highlight"><pre><span></span>cd C:\Program Files\Microsoft\R Server\Setup

##Kiểm tra instance
sqlbindr.exe /list


##Bind R với instance vừa tạo
sqlbindr.exe /bind YOUR_INSTANCE
</pre></div>
</div>
<ul class="simple">
<li>Cài dặt R SERVER 9.1 (folder
<strong>en_microsoft_r_server_910_for_windows_x64_10324119</strong>)</li>
</ul>
<p><strong>Tài liệu tham khảo</strong>:</p>
<ul class="simple">
<li><a class="reference external" href="https://msdn.microsoft.com/en-us/microsoft-r/rserver-install-windows#download">Guide</a></li>
<li><a class="reference external" href="https://blogs.msdn.microsoft.com/microsoftrservertigerteam/2017/03/22/running-microsoftml-in-sql-server/">Update SQL Server
9.0.1</a></li>
<li><a class="reference external" href="https://docs.microsoft.com/en-us/sql/advanced-analytics/r-services/use-sqlbindr-exe-to-upgrade-an-instance-of-r-services">Binding SQL R
service</a></li>
</ul>
</div>
<div class="section" id="thuc-hien-cau-lenh-r-trong-sql">
<h2>3.4. Thực hiện câu lệnh R trong SQL<a class="headerlink" href="#thuc-hien-cau-lenh-r-trong-sql" title="Permalink to this headline">¶</a></h2>
<p>Ví dụ câu lệnh chạy R trong SQL (từ 2016)</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">DECLARE</span> <span class="o">@</span><span class="n">RScript</span> <span class="n">NVARCHAR</span><span class="p">(</span><span class="k">MAX</span><span class="p">)</span>
<span class="k">SET</span> <span class="o">@</span><span class="n">RScript</span> <span class="o">=</span> <span class="n">N</span><span class="s1">&#39;</span>
<span class="s1">            library(reshape2)</span>
<span class="s1">            WWWTrans &lt;- InputDataSet</span>
<span class="s1">            data &lt;- dcast(WWWTrans, CustomerID ~ TransactionTypeID,</span>
<span class="s1">            value.var = &quot;TransactionAmount&quot;,</span>
<span class="s1">            fun.aggregate = sum)</span>
<span class="s1">            OutputDataSet &lt;- data.frame(data)&#39;</span>

<span class="k">DECLARE</span> <span class="o">@</span><span class="n">SQLScript</span> <span class="n">NVARCHAR</span><span class="p">(</span><span class="k">MAX</span><span class="p">)</span>
<span class="k">SET</span> <span class="o">@</span><span class="n">SQLScript</span> <span class="o">=</span> <span class="n">N</span><span class="s1">&#39;</span>
<span class="s1">        SELECT CustomerID, TransactionTypeID, TransactionAmount</span>
<span class="s1">        FROM [WideWorldImportersDW].[Sales].[CustomerTransactions]&#39;</span>

<span class="k">EXECUTE</span> <span class="n">sp_execute_external_script</span>
          <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">&#39;R&#39;</span>
        <span class="p">,</span> <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="o">@</span><span class="n">RScript</span>
        <span class="p">,</span> <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="o">@</span><span class="n">SQLScript</span>
        <span class="p">,</span> <span class="o">@</span><span class="n">output_data_1_name</span> <span class="o">=</span> <span class="n">N</span><span class="s1">&#39;OutputDataSet&#39;</span>
<span class="k">with</span> <span class="k">result</span> <span class="k">sets</span> <span class="p">((</span>
<span class="n">ID</span> <span class="n">nvarchar</span><span class="p">(</span><span class="mi">40</span><span class="p">),</span>
<span class="n">Var1</span> <span class="nb">int</span><span class="p">,</span>
<span class="n">Var2</span> <span class="nb">int</span>
<span class="p">));</span>
</pre></div>
</div>
<p><strong>Lưu ý</strong>: Khi đặt set results, cần lưu ý kiểu dữ liệu</p>
<p>##Ghi kết quả của Rscript vào bảng</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">--Bước 1: Tạo Procedure</span>
<span class="k">create</span> <span class="k">procedure</span> <span class="n">cast_data</span> <span class="k">as</span>
<span class="k">DECLARE</span> <span class="o">@</span><span class="n">RScript</span> <span class="n">NVARCHAR</span><span class="p">(</span><span class="k">MAX</span><span class="p">)</span>
<span class="k">SET</span> <span class="o">@</span><span class="n">RScript</span> <span class="o">=</span> <span class="n">N</span><span class="s1">&#39;</span>
<span class="s1">            library(reshape2)</span>
<span class="s1">            WWWTrans &lt;- InputDataSet</span>
<span class="s1">            data &lt;- dcast(WWWTrans, CustomerID ~ TransactionTypeID,</span>
<span class="s1">            value.var = &quot;TransactionAmount&quot;,</span>
<span class="s1">            fun.aggregate = sum)</span>
<span class="s1">            OutputDataSet &lt;- data.frame(data)&#39;</span>
<span class="k">DECLARE</span> <span class="o">@</span><span class="n">SQLScript</span> <span class="n">NVARCHAR</span><span class="p">(</span><span class="k">MAX</span><span class="p">)</span>
<span class="k">SET</span> <span class="o">@</span><span class="n">SQLScript</span> <span class="o">=</span> <span class="n">N</span><span class="s1">&#39;</span>
<span class="s1">        SELECT CustomerID, TransactionTypeID, TransactionAmount</span>
<span class="s1">        FROM [WideWorldImportersDW].[Sales].[CustomerTransactions]&#39;</span>
<span class="k">EXECUTE</span> <span class="n">sp_execute_external_script</span>
          <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">&#39;R&#39;</span>
        <span class="p">,</span> <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="o">@</span><span class="n">RScript</span>
        <span class="p">,</span> <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="o">@</span><span class="n">SQLScript</span>
        <span class="p">,</span> <span class="o">@</span><span class="n">output_data_1_name</span> <span class="o">=</span> <span class="n">N</span><span class="s1">&#39;OutputDataSet&#39;</span>
<span class="k">with</span> <span class="k">result</span> <span class="k">sets</span> <span class="p">((</span>
<span class="n">ID</span> <span class="n">nvarchar</span><span class="p">(</span><span class="mi">40</span><span class="p">),</span>
<span class="n">Var1</span> <span class="nb">int</span><span class="p">,</span>
<span class="n">Var2</span> <span class="nb">int</span>
<span class="p">));</span>

<span class="c1">--Bước 2: Tạo bảng tạm</span>
<span class="k">create</span> <span class="k">table</span> <span class="o">#</span><span class="n">a</span><span class="p">(</span><span class="n">ID</span> <span class="n">nvarchar</span><span class="p">(</span><span class="mi">40</span><span class="p">),</span>
<span class="n">Var1</span> <span class="nb">int</span><span class="p">,</span>
<span class="n">Var2</span> <span class="nb">int</span><span class="p">)</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="o">#</span><span class="n">a</span>

<span class="c1">--Bước 3: Insert vào bảng</span>
<span class="k">insert</span> <span class="k">into</span> <span class="o">#</span><span class="n">a</span><span class="p">(</span><span class="n">ID</span><span class="p">,</span> <span class="n">Var1</span><span class="p">,</span> <span class="n">Var2</span><span class="p">)</span>
<span class="k">execute</span> <span class="n">cast_data</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="tao-procedure-de-chay-association-rule">
<h2>3.5. Tạo procedure để chạy Association Rule<a class="headerlink" href="#tao-procedure-de-chay-association-rule" title="Permalink to this headline">¶</a></h2>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">--Xóa procedure trong hệ thống</span>
<span class="k">drop</span> <span class="k">procedure</span> <span class="n">cross_selling_priori</span>

<span class="c1">----------------</span>
<span class="c1">--Tạo procedure</span>

<span class="k">create</span> <span class="k">procedure</span> <span class="n">cross_selling_priori</span> <span class="o">@</span><span class="n">supp</span> <span class="n">nvarchar</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">,</span> <span class="o">@</span><span class="n">conf</span> <span class="n">nvarchar</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span> <span class="o">=</span> <span class="k">NULL</span>
<span class="k">as</span>
<span class="k">DECLARE</span> <span class="o">@</span><span class="n">RScript</span> <span class="n">NVARCHAR</span><span class="p">(</span><span class="k">MAX</span><span class="p">)</span>
<span class="k">SET</span> <span class="o">@</span><span class="n">RScript</span> <span class="o">=</span> <span class="n">N</span><span class="s1">&#39;</span>
<span class="s1">            library(reshape2)</span>
<span class="s1">            library(dplyr)</span>
<span class="s1">            library(arules)</span>
<span class="s1">            library(stringr)</span>

<span class="s1">#Hàm tạo transaction convert</span>
<span class="s1">transaction.convert &lt;- function(data, type = c(&quot;wide&quot;,&quot;long&quot;)){</span>
<span class="s1">  type &lt;- match.arg(type)</span>
<span class="s1">  library(dplyr)</span>
<span class="s1">  library(reshape2)</span>
<span class="s1">  library(arules)</span>
<span class="s1">  if (type == &quot;wide&quot;){</span>
<span class="s1">    names(data)[1]=&quot;ID&quot;</span>
<span class="s1">    data[data==0] &lt;- NA</span>
<span class="s1">    data.product.melt &lt;- melt(data, id.vars = &quot;ID&quot;) %&gt;% na.omit %&gt;% select(-3) %&gt;% distinct()</span>
<span class="s1">    write.table(data.product.melt, file = &quot;transaction.txt&quot;, sep = &quot;,&quot;, col.names = FALSE,</span>
<span class="s1">                row.names = FALSE)</span>
<span class="s1">    transaction &lt;- read.transactions(&quot;transaction.txt&quot;, format = &quot;single&quot;, cols=c(1,2), sep = &quot;,&quot;, encoding = &quot;Unicode&quot;)</span>
<span class="s1">    fn &lt;- &quot;transaction.txt&quot;</span>
<span class="s1">    if(file.exists(fn)) file.remove(fn)</span>
<span class="s1">  }</span>
<span class="s1">  else{</span>
<span class="s1">    data.product.melt &lt;- data %&gt;% select(c(1,2)) %&gt;% distinct()</span>
<span class="s1">    write.table(data.product.melt, file = &quot;transaction.txt&quot;, sep = &quot;,&quot;, col.names = FALSE,</span>
<span class="s1">                row.names = FALSE)</span>
<span class="s1">    transaction &lt;- read.transactions(&quot;transaction.txt&quot;, format = &quot;single&quot;, cols=c(1,2), sep = &quot;,&quot;, encoding = &quot;Unicode&quot;)</span>
<span class="s1">    fn &lt;- &quot;transaction.txt&quot;</span>
<span class="s1">    if(file.exists(fn)) file.remove(fn)</span>
<span class="s1">  }</span>
<span class="s1">  return(transaction)</span>
<span class="s1"> }</span>

<span class="s1"> #List customer</span>

<span class="s1">list.cus &lt;- function(rules, data){</span>
<span class="s1">  #Create data frame from rules</span>
<span class="s1">  df2 &lt;- rules %&gt;% as(&quot;data.frame&quot;)</span>
<span class="s1">  data.frame(do.call(&quot;rbind&quot;,</span>
<span class="s1">                     strsplit(as.character(df2$rules),&quot;=&gt;&quot;,fixed=TRUE)),</span>
<span class="s1">             support = df2$support, confidence = df2$confidence,</span>
<span class="s1">             lift = df2$lift) -&gt; df3</span>
<span class="s1">  names(df3) &lt;- c(&quot;lhs&quot;, &quot;rhs&quot;, &quot;support&quot;, &quot;confidence&quot;, &quot;lift&quot;)</span>
<span class="s1">  df3$rule &lt;- paste(&quot;rule_&quot;, seq(1,dim(df3)[1]), sep=&quot;&quot;)</span>
<span class="s1">  # Turn data frame to filter condition -------------------------------------</span>
<span class="s1">  lhs.trans &lt;- function(a){</span>
<span class="s1">    a &lt;- gsub(&quot;{&quot;, &quot;&quot;, a, fixed = T);</span>
<span class="s1">    a &lt;- gsub(&quot;}&quot;, &quot; != 0 &amp; &quot;, a, fixed = T);</span>
<span class="s1">    a &lt;- gsub(&quot;,&quot;, &quot; != 0 &amp; &quot;, a, fixed = T);</span>
<span class="s1">    return(a)</span>
<span class="s1">  }</span>

<span class="s1">  rhs.trans &lt;- function(a){</span>
<span class="s1">    a &lt;- gsub(&quot;{&quot;, &quot;&quot;, a, fixed = T);</span>
<span class="s1">    a &lt;- gsub(&quot;}&quot;, &quot; == 0&quot;, a, fixed = T);</span>
<span class="s1">    return(a)</span>
<span class="s1">  }</span>
<span class="s1">  data.frame(</span>
<span class="s1">    lhs = sapply(df3$lhs, lhs.trans),</span>
<span class="s1">    rhs = sapply(df3$rhs, rhs.trans)</span>
<span class="s1">  ) -&gt; df4</span>
<span class="s1">  df4$condition &lt;- paste0(df4$lhs, df4$rhs)</span>
<span class="s1">  df4 &lt;- data.frame(df4, rule = df3$rule);</span>

<span class="s1">  #Mapping data frame</span>
<span class="s1">  data3 &lt;- data.frame()</span>
<span class="s1">  for (i in seq(1, dim(df4)[1])){</span>
<span class="s1">    data2 &lt;- data %&gt;% filter_(df4$condition[i]) %&gt;%</span>
<span class="s1">      mutate(rule = df4$rule[i])</span>
<span class="s1">    data3 &lt;- rbind(data3,data2)</span>
<span class="s1">  }</span>

<span class="s1">  data3 %&gt;% select(CIF, rule) -&gt; df5</span>
<span class="s1">  left_join(df5, df3, by = &quot;rule&quot;) -&gt; df6;</span>

<span class="s1">  #Keep distinct rules</span>
<span class="s1">  df6 %&gt;% group_by(CIF) %&gt;% arrange(desc(lift)) %&gt;%</span>
<span class="s1">    distinct(CIF, .keep_all = T) -&gt; result</span>
<span class="s1">  return(result)</span>
<span class="s1"> }</span>

<span class="s1">####Import data</span>

<span class="s1">data &lt;- InputDataSet</span>
<span class="s1">data[is.na(data)] &lt;- 0</span>
<span class="s1">data$CUSTOMER_NAME &lt;- data$CUSTOMER_NAME %&gt;% as.character</span>
<span class="s1">Transaction &lt;- data %&gt;% select(-CUSTOMER_NAME) %&gt;% transaction.convert()</span>
<span class="s1">a &lt;- &#39;</span> <span class="o">+</span> <span class="o">@</span><span class="n">supp</span> <span class="o">+</span>
<span class="s1">&#39;</span>
<span class="s1">b &lt;- &#39;</span>  <span class="o">+</span> <span class="o">@</span><span class="n">conf</span> <span class="o">+</span>
<span class="s1">&#39;</span>

<span class="s1">rhs.new &lt;- Transaction@itemInfo$labels</span>

<span class="s1"># Get all results for all products ----------------------------------------</span>

<span class="s1">result &lt;- data.frame()</span>
<span class="s1">for (i in rhs.new) {</span>
<span class="s1">  tryCatch({</span>
<span class="s1">    rules &lt;-  apriori(</span>
<span class="s1">      Transaction,</span>
<span class="s1">      parameter = list(</span>
<span class="s1">        supp = a,</span>
<span class="s1">        conf = b ,</span>
<span class="s1">        minlen = 2</span>
<span class="s1">      ),</span>
<span class="s1">      appearance = list(default = &quot;lhs&quot;, rhs = i)</span>
<span class="s1">    )</span>
<span class="s1">    subset.matrix &lt;- is.subset(rules, rules)</span>
<span class="s1">    subset.matrix[lower.tri(subset.matrix, diag = T)] &lt;- NA</span>
<span class="s1">    redundant &lt;- colSums(subset.matrix, na.rm = T) &gt;= 1</span>
<span class="s1">    rules.pruned &lt;- rules[!redundant]</span>
<span class="s1">    subrules2 &lt;- sort(rules.pruned, by = &quot;lift&quot;)</span>

<span class="s1">    my_result &lt;- list.cus(subrules2, data) %&gt;% as.data.frame</span>
<span class="s1">    result &lt;- rbind(result, my_result)</span>
<span class="s1">  }, error = function(e) {</span>
<span class="s1">  })</span>
<span class="s1">  }</span>
<span class="s1">OutputDataSet &lt;- data.frame(result)&#39;</span>

<span class="k">DECLARE</span> <span class="o">@</span><span class="n">SQLScript</span> <span class="n">NVARCHAR</span><span class="p">(</span><span class="k">MAX</span><span class="p">)</span>
<span class="k">SET</span> <span class="o">@</span><span class="n">SQLScript</span> <span class="o">=</span> <span class="n">N</span><span class="s1">&#39;</span>
<span class="s1">        SELECT *</span>
<span class="s1">        FROM VPBANK.dbo.Product_holding&#39;</span>

<span class="k">EXECUTE</span> <span class="n">sp_execute_external_script</span>
          <span class="o">@</span><span class="k">language</span> <span class="o">=</span> <span class="n">N</span><span class="s1">&#39;R&#39;</span>
        <span class="p">,</span> <span class="o">@</span><span class="n">script</span> <span class="o">=</span> <span class="o">@</span><span class="n">RScript</span>
        <span class="p">,</span> <span class="o">@</span><span class="n">input_data_1</span> <span class="o">=</span> <span class="o">@</span><span class="n">SQLScript</span>
        <span class="p">,</span> <span class="o">@</span><span class="n">output_data_1_name</span> <span class="o">=</span> <span class="n">N</span><span class="s1">&#39;OutputDataSet&#39;</span>

<span class="k">with</span> <span class="k">result</span> <span class="k">sets</span> <span class="p">((</span>
<span class="n">CIF</span> <span class="n">nvarchar</span><span class="p">(</span><span class="mi">40</span><span class="p">),</span>
<span class="n">rules</span> <span class="n">nvarchar</span><span class="p">(</span><span class="mi">40</span><span class="p">),</span>
<span class="n">lhs</span> <span class="n">nvarchar</span><span class="p">(</span><span class="mi">40</span><span class="p">),</span>
<span class="n">rhs</span> <span class="n">nvarchar</span><span class="p">(</span><span class="mi">40</span><span class="p">),</span>
<span class="n">support</span> <span class="nb">float</span><span class="p">,</span>
<span class="n">confidence</span> <span class="nb">float</span><span class="p">,</span>
<span class="n">lift</span> <span class="nb">float</span>
<span class="p">))</span>
<span class="k">GO</span>

<span class="c1">-- Chạy procedure</span>
<span class="n">cross_selling_priori</span> <span class="o">@</span><span class="n">supp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">005</span><span class="p">,</span> <span class="o">@</span><span class="n">conf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">26</span>
</pre></div>
</div>
</div>
<div class="section" id="ket-noi-voi-sqlrserver">
<h2>3.6. Kết nối với SQLRServer<a class="headerlink" href="#ket-noi-voi-sqlrserver" title="Permalink to this headline">¶</a></h2>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1">#Bước 1: Tạo connection</span>
<span class="n">connStr</span> <span class="o">&lt;-</span> <span class="s">&quot;Driver=SQL Server;</span>
<span class="s">Server=HON-BICC-PC0035;</span>
<span class="s">Database=DBS_BI;</span>
<span class="s">Uid=sa;</span>
<span class="s">Pwd=123&quot;</span>

<span class="n">sqlShareDir</span> <span class="o">&lt;-</span> <span class="s">&quot;C:/Users/anhhd3/Desktop/SQLRserver test&quot;</span>
<span class="n">sqlWait</span> <span class="o">&lt;-</span> <span class="kc">TRUE</span>
<span class="n">sqlConsoleOutput</span> <span class="o">&lt;-</span> <span class="kc">FALSE</span>
<span class="n">sqlShareDir</span>

<span class="n">cc</span> <span class="o">&lt;-</span> <span class="nf">RxInSqlServer</span><span class="p">(</span><span class="n">connectionString</span> <span class="o">=</span> <span class="n">connStr</span><span class="p">,</span>
                    <span class="n">shareDir</span> <span class="o">=</span> <span class="n">sqlShareDir</span><span class="p">,</span>
                    <span class="n">wait</span> <span class="o">=</span> <span class="n">sqlWait</span><span class="p">,</span>
                    <span class="n">consoleOutput</span> <span class="o">=</span> <span class="n">sqlConsoleOutput</span><span class="p">)</span>
<span class="nf">rxSetComputeContext</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>

<span class="n">sampleDataQuery</span> <span class="o">&lt;-</span> <span class="s">&quot;select NO_TRANS, TXN_AMT from EBANKING_TRANS_CIF&quot;</span>
<span class="n">inDataSource</span> <span class="o">&lt;-</span> <span class="nf">RxSqlServerData</span><span class="p">(</span><span class="n">sqlQuery</span> <span class="o">=</span> <span class="n">sampleDataQuery</span><span class="p">,</span>
                                <span class="n">connectionString</span> <span class="o">=</span> <span class="n">connStr</span><span class="p">,</span>
                                <span class="n">rowsPerRead</span><span class="o">=</span><span class="m">500</span><span class="p">)</span>
                                <span class="c1"># colClasses = c(INTERNAL_AMOUNT = &quot;numeric&quot;, ONLINE_LIMIT_DATE = &quot;numeric&quot;,</span>
                                <span class="c1">#                COLLATERAL_CODE = &quot;factor&quot;))</span>

<span class="nf">rxGetVarInfo</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">inDataSource</span><span class="p">)</span>

<span class="nf">system.time</span><span class="p">(</span><span class="nf">rxSummary</span><span class="p">(</span><span class="o">~</span><span class="n">TXN_AMT^2</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">inDataSource</span><span class="p">))</span>

<span class="nf">rxHistogram</span><span class="p">(</span><span class="o">~</span><span class="n">TXN_AMT</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">inDataSource</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s">&quot;Fare Amount Histogram&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="data-thuc-hien-case-study">
<h2>3.7. Data thực hiện case study<a class="headerlink" href="#data-thuc-hien-case-study" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Taxi: <a class="reference external" href="http://getgoing.blob.core.windows.net/public/nyctaxi1pct.csv">http://getgoing.blob.core.windows.net/public/nyctaxi1pct.csv</a>)</li>
</ul>
</div>
<div class="section" id="tai-lieu-tham-khao">
<h2>3.8. Tài liệu tham khảo<a class="headerlink" href="#tai-lieu-tham-khao" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="http://www.pertell.com/sqlservings/archive/2015/11/sql-2016-and-r-some-basic-examples/">Pertell.com</a></li>
<li><a class="reference external" href="https://tomaztsql.wordpress.com/2016/08/01/using-parameter-and-multiparameters-with-sp_execute_external_script/">TomaszTSQL</a></li>
<li><a class="reference external" href="https://msdn.microsoft.com/en-us/library/mt703706.aspx">Microsof SQL
2016</a></li>
<li>Data Science with Microsoft SQL Server 2016</li>
<li><a class="reference external" href="https://blogs.msdn.microsoft.com/microsoftrservertigerteam/">Microsoft
support</a></li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="p04-11-xay-dung-database.html" class="btn btn-neutral float-right" title="1. Xây dựng Data warehouse &amp; Data Mart" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="p03-07-r-va-sql.html" class="btn btn-neutral float-left" title="2. R &amp; SQL Server" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Anh Hoang Duc

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>