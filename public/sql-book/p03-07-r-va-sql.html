

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="vi" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="vi" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>2. R &amp; SQL Server &mdash; Tài liệu Khai thác dữ liệu với SQL 2019</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'./',
              VERSION:'2019',
              LANGUAGE:'vi',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
        <script type="text/javascript" src="_static/copybutton.js"></script>
        <script type="text/javascript" src="_static/translations.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/copybutton.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Tìm Kiếm" href="search.html" />
    <link rel="next" title="3. SQL RServer" href="p03-08-r-server.html" />
    <link rel="prev" title="1. Kết nối SQL với Excel phục vụ báo cáo tự động" href="p03-06-sql-va-excel.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Khai thác dữ liệu với SQL
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">SQL cơ bản</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="p01-01-sql-co-ban.html">1. Giới thiệu về SQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="p01-01-sql-co-ban.html#cac-nhom-cau-lenh-truy-van-tong-hop">2. Các nhóm câu lệnh truy vấn, tổng hợp</a></li>
<li class="toctree-l1"><a class="reference internal" href="p01-01-sql-co-ban.html#cac-nhom-cau-lenh-thay-doi-du-lieu-trong-csdl">3. Các nhóm câu lệnh thay đổi dữ liệu trong CSDL</a></li>
<li class="toctree-l1"><a class="reference internal" href="p01-01-sql-co-ban.html#sub-query">4. Sub Query</a></li>
<li class="toctree-l1"><a class="reference internal" href="p01-01-sql-co-ban.html#cac-nhom-cau-lenh-co-ban-khac">5. Các nhóm câu lệnh cơ bản khác</a></li>
<li class="toctree-l1"><a class="reference internal" href="p01-01-sql-co-ban.html#sql-dong-voi-exec">6. SQL động với Exec</a></li>
<li class="toctree-l1"><a class="reference internal" href="p01-01-sql-co-ban.html#ham-va-thu-tuc">7. Hàm và thủ tục</a></li>
<li class="toctree-l1"><a class="reference internal" href="p01-01-sql-co-ban.html#cac-nhom-cau-lenh-nang-cao">8. Các nhóm câu lệnh nâng cao</a></li>
<li class="toctree-l1"><a class="reference internal" href="p01-01-sql-co-ban.html#dat-job-trong-sql">9. Đặt job trong SQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="p01-01-sql-co-ban.html#cac-nhom-cau-lenh-quan-tri">10. Các nhóm câu lệnh quản trị</a></li>
<li class="toctree-l1"><a class="reference internal" href="p01-02-tricks-sql.html">11. Tricks khi dùng với SQL</a></li>
</ul>
<p class="caption"><span class="caption-text">SQL nâng cao</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="p02-03-sql-nang-cao.html">1. Pivot - Unpivot</a></li>
<li class="toctree-l1"><a class="reference internal" href="p02-03-sql-nang-cao.html#chia-mot-cot-thanh-nhieu-cot">2. Chia một cột thành nhiều cột</a></li>
<li class="toctree-l1"><a class="reference internal" href="p02-04-sqlcmd.html">3. SQLCMD</a></li>
<li class="toctree-l1"><a class="reference internal" href="p02-05-sql-project.html">4. SQL prọject</a></li>
</ul>
<p class="caption"><span class="caption-text">SQL &amp; Analytics</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="p03-06-sql-va-excel.html">1. Kết nối SQL với Excel phục vụ báo cáo tự động</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">2. R &amp; SQL Server</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#cach-1-su-dung-rodbc">2.1. Cách 1: Sử dụng RODBC</a></li>
<li class="toctree-l2"><a class="reference internal" href="#cach-2-su-dung-dbi-odbc">2.2. Cách 2: Sử dụng DBI, odbc</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#cac-cau-lenh-truy-van">2.2.1. Các câu lệnh truy vấn</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cac-cau-lenh-bien-doi-du-lieu">2.2.2. Các câu lệnh biến đổi dữ liệu</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cac-ung-dung-nang-cao">2.2.3. Các ứng dụng nâng cao</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="p03-08-r-server.html">3. SQL RServer</a></li>
</ul>
<p class="caption"><span class="caption-text">Xây dựng DataMart</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="p04-11-xay-dung-database.html">1. Xây dựng Data warehouse &amp; Data Mart</a></li>
</ul>
<p class="caption"><span class="caption-text">Tài liệu tham khảo:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="p09-79-tai-lieu-tham-khao.html">Tài liệu tham khảo</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Khai thác dữ liệu với SQL</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>2. R &amp; SQL Server</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/p03-07-r-va-sql.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="r-sql-server">
<h1>2. R &amp; SQL Server<a class="headerlink" href="#r-sql-server" title="Permalink to this headline">¶</a></h1>
<div class="section" id="cach-1-su-dung-rodbc">
<h2>2.1. Cách 1: Sử dụng RODBC<a class="headerlink" href="#cach-1-su-dung-rodbc" title="Permalink to this headline">¶</a></h2>
<p>Cách này khá đơn giản tuy nhiên chỉ hỗ trợ các câu lệnh truy vấn và lưu
cả bảng và database mà không cho phép thực hiện các câu lệnh phức tạp
hơn như Update, Delete. Cách thức thực hiện như sau.</p>
<ul class="simple">
<li><strong>Bước 1</strong>: Vào Control Panel &gt;&gt; Administrative Tool &gt;&gt; ODBC Data
Source &gt;&gt; Add &gt;&gt; Chọn Server &gt;&gt; Lựa chọn login vào Server &gt;&gt; Test
Data &gt;&gt; Test Data Source</li>
<li><strong>Bước 2</strong>: Khởi tạo connection với SQL từ R</li>
</ul>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1">#Cài đặt connection với SQLServer</span>
<span class="nf">library</span><span class="p">(</span><span class="n">RODBC</span><span class="p">)</span>
<span class="n">ch</span> <span class="o">&lt;-</span> <span class="nf">odbcConnect</span><span class="p">(</span><span class="s">&quot;sql&quot;</span><span class="p">,</span> <span class="n">uid</span> <span class="o">=</span> <span class="s">&quot;sa&quot;</span><span class="p">,</span> <span class="n">pwd</span> <span class="o">=</span> <span class="s">&quot;123&quot;</span><span class="p">)</span>
<span class="c1">#Kết nối SQL với R</span>
<span class="n">df</span> <span class="o">&lt;-</span> <span class="nf">sqlQuery</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="s">&quot;</span>
<span class="s">         SELECT top 100 * from learnsql.dbo.account&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="cach-2-su-dung-dbi-odbc">
<h2>2.2. Cách 2: Sử dụng DBI, odbc<a class="headerlink" href="#cach-2-su-dung-dbi-odbc" title="Permalink to this headline">¶</a></h2>
<p>Cách sử dụng với <code class="docutils literal notranslate"><span class="pre">DBI</span></code> và <code class="docutils literal notranslate"><span class="pre">odbc</span></code> ưu việt hơn so với sử dụng
<code class="docutils literal notranslate"><span class="pre">RODBC</span></code>. Cách tiếp cận này thậm chí cho phép <code class="docutils literal notranslate"><span class="pre">translate</span></code> từ
<code class="docutils literal notranslate"><span class="pre">dplyr</span></code> sang <code class="docutils literal notranslate"><span class="pre">SQL</span></code></p>
<div class="section" id="cac-cau-lenh-truy-van">
<h3>2.2.1. Các câu lệnh truy vấn<a class="headerlink" href="#cac-cau-lenh-truy-van" title="Permalink to this headline">¶</a></h3>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="n">dbplyr</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">DBI</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">odbc</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">RSQLServer</span><span class="p">)</span>
<span class="nf">sessionInfo</span><span class="p">()</span>
<span class="c1"># Step 1: Tạo connection với odbc</span>

<span class="n">con</span> <span class="o">&lt;-</span> <span class="nf">dbConnect</span><span class="p">(</span><span class="n">odbc</span><span class="o">::</span><span class="nf">odbc</span><span class="p">(),</span>
                 <span class="n">Driver</span>    <span class="o">=</span> <span class="s">&quot;SQL Server&quot;</span><span class="p">,</span>
                 <span class="n">Server</span>    <span class="o">=</span> <span class="s">&quot;localhost&quot;</span><span class="p">,</span>
                 <span class="n">Database</span>  <span class="o">=</span> <span class="s">&quot;learningsql&quot;</span><span class="p">,</span>
                 <span class="n">UID</span>       <span class="o">=</span> <span class="s">&quot;sa&quot;</span><span class="p">,</span>
                 <span class="n">PWD</span>       <span class="o">=</span> <span class="m">123456</span><span class="p">,</span>
                 <span class="n">Port</span>      <span class="o">=</span> <span class="m">1433</span><span class="p">)</span>

<span class="c1">#Xem danh sách các bảng trong DB</span>

<span class="nf">dbListTables</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">schema_name</span> <span class="o">=</span> <span class="s">&quot;dbo&quot;</span><span class="p">)</span>

<span class="c1">#Xem danh sách các cột trong 1 bảng</span>

<span class="nf">dbListFields</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="s">&quot;CUSTOMER_PRODUCT_HOLDING&quot;</span><span class="p">)</span>

<span class="c1">#Preview 1 bảng</span>
<span class="n">con</span> <span class="o">%&gt;%</span> <span class="nf">tbl</span><span class="p">(</span><span class="s">&quot;KPI_2017&quot;</span><span class="p">)</span>

<span class="c1">#Đếm số dòng với tally</span>

<span class="n">con</span> <span class="o">%&gt;%</span> <span class="nf">tbl</span><span class="p">(</span><span class="s">&quot;KPI_2017&quot;</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="n">tally</span>

<span class="c1">#Convert sang SQL Query</span>

<span class="n">con</span> <span class="o">%&gt;%</span> <span class="nf">tbl</span><span class="p">(</span><span class="s">&quot;KPI_2017&quot;</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="n">tally</span> <span class="o">%&gt;%</span> <span class="nf">show_query</span><span class="p">()</span>

<span class="n">con</span> <span class="o">%&gt;%</span> <span class="nf">tbl</span><span class="p">(</span><span class="s">&quot;KPI_2017&quot;</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="nf">group_by</span><span class="p">(</span><span class="n">SEGMENT</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="nf">summarise</span><span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="nf">n</span><span class="p">())</span> <span class="o">%&gt;%</span>
  <span class="nf">show_query</span><span class="p">()</span>

<span class="n">con</span> <span class="o">%&gt;%</span> <span class="nf">tbl</span><span class="p">(</span><span class="s">&quot;KPI_2017&quot;</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="nf">group_by</span><span class="p">(</span><span class="n">SEGMENT</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="nf">mutate</span><span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="nf">dense_rank</span><span class="p">(</span><span class="n">Volumn</span><span class="p">))</span> <span class="o">%&gt;%</span>
  <span class="nf">show_query</span><span class="p">()</span>

<span class="nf">tbl</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="s">&quot;KPI_2017&quot;</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="nf">left_join</span><span class="p">(</span><span class="nf">tbl</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="s">&quot;DimDate&quot;</span><span class="p">),</span> <span class="n">by</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;Date&quot;</span> <span class="o">=</span> <span class="s">&quot;DateKey&quot;</span><span class="p">))</span>  <span class="o">-&gt;</span> <span class="n">df</span>

<span class="c1"># Write dataframe vào bảng</span>
<span class="n">con</span> <span class="o">%&gt;%</span> <span class="nf">tbl</span><span class="p">(</span><span class="s">&quot;CUSTOMER_PRODUCT_HOLDING&quot;</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="nf">select</span><span class="p">(</span><span class="n">CIF</span><span class="p">,</span> <span class="m">12</span><span class="o">:</span><span class="m">28</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="nf">head</span><span class="p">(</span><span class="m">100</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">df</span>

<span class="c1"># Collect dữ liệu về dataframe</span>
<span class="n">df</span> <span class="o">%&gt;%</span> <span class="n">collect</span> <span class="o">%&gt;%</span> <span class="nf">gather</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">-</span><span class="n">CIF</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">df2</span>

<span class="nf">dbWriteTable</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="s">&quot;customer_ph_melt&quot;</span><span class="p">,</span> <span class="n">df2</span><span class="p">)</span>

<span class="nf">dbSendQuery</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="s">&quot;select top 10 * from [TRANGTQ2].[DBS_DAILY].[dbo].[CARD_20170621]&quot;</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="nf">dbFetch</span><span class="p">()</span>

<span class="nf">dbGetQuery</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="s">&quot;select top 10 * from [TRANGTQ2].[DBS_DAILY].[dbo].[CARD_20170621]&quot;</span><span class="p">)</span>  <span class="o">%&gt;%</span>
  <span class="n">tbl</span>
</pre></div>
</div>
</div>
<div class="section" id="cac-cau-lenh-bien-doi-du-lieu">
<h3>2.2.2. Các câu lệnh biến đổi dữ liệu<a class="headerlink" href="#cac-cau-lenh-bien-doi-du-lieu" title="Permalink to this headline">¶</a></h3>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">&lt;-</span> <span class="s">&quot;</span>
<span class="s">update analytics.dbo.iris</span>
<span class="s">set y = 5</span>

<span class="s">delete from analytics.dbo.iris</span>
<span class="s">where cut = &#39;Ideal&#39;</span>
<span class="s">&quot;</span>

<span class="nf">dbSendQuery</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>

<span class="nf">tbl</span><span class="p">(</span><span class="n">con</span><span class="p">,</span> <span class="s">&quot;iris&quot;</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="nf">select</span><span class="p">(</span><span class="n">cut</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="n">collect</span> <span class="o">%&gt;%</span>
  <span class="nf">mutate</span><span class="p">(</span><span class="n">cut</span> <span class="o">=</span> <span class="nf">as.factor</span><span class="p">(</span><span class="n">cut</span><span class="p">))</span> <span class="o">%&gt;%</span> <span class="n">summary</span>
</pre></div>
</div>
<p><strong>Lưu ý</strong>:</p>
<ul class="simple">
<li>Khi tạo string query trong, nên dùng dâu <code class="docutils literal notranslate"><span class="pre">&quot;&quot;</span></code></li>
<li>Dâu ’’ trong SQL có thể dùng trong dấu <code class="docutils literal notranslate"><span class="pre">&quot;&quot;</span></code> mà không gặp vấn đề gì</li>
</ul>
</div>
<div class="section" id="cac-ung-dung-nang-cao">
<h3>2.2.3. Các ứng dụng nâng cao<a class="headerlink" href="#cac-ung-dung-nang-cao" title="Permalink to this headline">¶</a></h3>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1">#Hỗ trợ hiển thị nhiều lần query trong cùng 1 bảng</span>
<span class="n">con</span> <span class="o">%&gt;%</span> <span class="nf">tbl</span><span class="p">(</span><span class="s">&quot;CUSTOMER&quot;</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="nf">group_by</span><span class="p">(</span><span class="n">CITY</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="nf">mutate</span><span class="p">(</span><span class="n">no</span> <span class="o">=</span> <span class="nf">paste0</span><span class="p">(</span><span class="n">STATE</span><span class="p">,</span> <span class="s">&quot;_new&quot;</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">df</span>
<span class="n">df</span> <span class="o">%&gt;%</span> <span class="nf">filter</span><span class="p">(</span><span class="n">no</span> <span class="o">==</span> <span class="s">&quot;HA&quot;</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="nf">head</span><span class="p">(</span><span class="m">10</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="nf">show_query</span><span class="p">()</span>
<span class="c1">#Lần 1</span>
<span class="n">df1</span> <span class="o">&lt;-</span> <span class="nf">head</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>  <span class="o">%&gt;%</span> <span class="n">ungroup</span>
<span class="c1">#Lần 2</span>
<span class="n">df</span> <span class="o">%&gt;%</span>
  <span class="n">ungroup</span> <span class="o">%&gt;%</span>
  <span class="nf">filter</span><span class="p">(</span><span class="n">CUST_ID</span> <span class="o">%in%</span> <span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">))</span> <span class="o">%&gt;%</span>
  <span class="nf">show_query</span><span class="p">()</span>

<span class="c1">#Khi biến đổi trên nhiều bảng,</span>
<span class="c1">#chưa cho phép biến đổi linh hoạt như R</span>

<span class="n">df</span> <span class="o">%&gt;%</span> <span class="nf">filter</span><span class="p">(</span><span class="n">CUST_ID</span> <span class="o">%in%</span> <span class="p">(</span><span class="n">df1</span> <span class="o">%&gt;%</span> <span class="n">collect</span><span class="p">)</span><span class="o">$</span><span class="n">CUST_ID</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="nf">show_query</span><span class="p">()</span>


<span class="n">df1.data</span><span class="o">$</span><span class="n">CUST_ID</span>
</pre></div>
</div>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># Tạo hàm cho connection</span>

<span class="n">vp_dbConnect</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">database</span> <span class="o">=</span> <span class="s">&quot;master&quot;</span><span class="p">,</span>
                         <span class="n">UID</span> <span class="o">=</span> <span class="s">&quot;sa&quot;</span><span class="p">,</span>
                         <span class="n">PWD</span> <span class="o">=</span> <span class="s">&quot;123456&quot;</span><span class="p">,</span>
                         <span class="n">Server</span> <span class="o">=</span> <span class="s">&quot;localhost&quot;</span><span class="p">){</span>
  <span class="n">connect</span> <span class="o">&lt;-</span> <span class="nf">dbConnect</span><span class="p">(</span><span class="n">odbc</span><span class="o">::</span><span class="nf">odbc</span><span class="p">(),</span>
                       <span class="n">Driver</span>    <span class="o">=</span> <span class="s">&quot;SQL Server&quot;</span><span class="p">,</span>
                       <span class="n">Server</span>    <span class="o">=</span> <span class="s">&quot;localhost&quot;</span><span class="p">,</span>
                       <span class="n">Database</span>  <span class="o">=</span> <span class="n">database</span><span class="p">,</span>
                       <span class="n">UID</span>       <span class="o">=</span> <span class="n">UID</span><span class="p">,</span>
                       <span class="n">PWD</span>       <span class="o">=</span> <span class="n">PWD</span><span class="p">,</span>
                       <span class="n">Port</span>      <span class="o">=</span> <span class="m">1433</span><span class="p">)</span>
  <span class="nf">return</span><span class="p">(</span><span class="n">connect</span><span class="p">)</span>
<span class="p">}</span>


<span class="n">daily_connect</span> <span class="o">&lt;-</span> <span class="nf">vp_dbConnect</span><span class="p">(</span><span class="n">database</span> <span class="o">=</span> <span class="s">&quot;DATA&quot;</span><span class="p">)</span>

<span class="nf">vp_dbConnect</span><span class="p">(</span><span class="s">&quot;DATA&quot;</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="nf">tbl</span><span class="p">(</span><span class="s">&quot;TBL_LIMIT_ORG&quot;</span><span class="p">)</span>

<span class="nf">vp_dbConnect</span><span class="p">(</span><span class="s">&quot;DBS_BI&quot;</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="nf">tbl</span><span class="p">(</span><span class="s">&quot;CUSTOMER_PRODUCT_HOLDING&quot;</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="n">collect</span>

<span class="c1">#connect với H2O</span>
<span class="nf">library</span><span class="p">(</span><span class="n">h2o</span><span class="p">)</span>
<span class="nf">h2o.init</span><span class="p">()</span>
<span class="nf">vp_dbConnect</span><span class="p">(</span><span class="s">&quot;DATA&quot;</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="nf">tbl</span><span class="p">(</span><span class="s">&quot;TBL_LIMIT_ORG&quot;</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="n">as.h2o</span> <span class="o">-&gt;</span> <span class="n">df.h2o</span>
<span class="n">df.h2o</span> <span class="o">%&gt;%</span> <span class="n">h2o.summary</span>

<span class="c1">#Connect với Spark</span>
<span class="nf">library</span><span class="p">(</span><span class="n">sparklyr</span><span class="p">)</span>
<span class="nf">spark_install</span><span class="p">(</span><span class="n">version</span> <span class="o">=</span> <span class="s">&quot;2.1.0&quot;</span><span class="p">)</span>
<span class="n">sc</span> <span class="o">&lt;-</span> <span class="nf">spark_connect</span><span class="p">(</span><span class="n">master</span> <span class="o">=</span> <span class="s">&quot;local&quot;</span><span class="p">,</span> <span class="n">version</span> <span class="o">=</span> <span class="s">&quot;2.1.0&quot;</span><span class="p">)</span>

<span class="c1">#Cách 1: Copy từ data frame</span>
<span class="nf">vp_dbConnect</span><span class="p">(</span><span class="s">&quot;DATA&quot;</span><span class="p">)</span> <span class="o">%&gt;%</span>
          <span class="nf">tbl</span><span class="p">(</span><span class="s">&quot;TBL_LIMIT_ORG&quot;</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="n">collect</span> <span class="o">-&gt;</span> <span class="n">df</span>
<span class="nf">copy_to</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">overwrite</span> <span class="o">=</span> <span class="bp">T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tbl_new</span>

<span class="c1">#Cách 2: Copy trực tiếp từ tbl_sql</span>
<span class="nf">vp_dbConnect</span><span class="p">(</span><span class="s">&quot;DATA&quot;</span><span class="p">)</span> <span class="o">%&gt;%</span>
          <span class="nf">tbl</span><span class="p">(</span><span class="s">&quot;TBL_LIMIT_ORG&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tbl_sql</span>
<span class="nf">copy_to</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">tbl_sql</span><span class="p">,</span> <span class="n">overwrite</span> <span class="o">=</span> <span class="bp">T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tbl_new2</span>

<span class="c1">#So sánh</span>
<span class="n">df</span> <span class="o">%&gt;%</span> <span class="nf">object.size</span><span class="p">()</span>
<span class="n">tbl_new2</span> <span class="o">%&gt;%</span> <span class="nf">object.size</span><span class="p">()</span>
<span class="n">tbl_new</span> <span class="o">%&gt;%</span> <span class="nf">object.size</span><span class="p">()</span>

<span class="n">tbl_new</span> <span class="o">%&gt;%</span>
  <span class="nf">group_by</span><span class="p">(</span><span class="n">ACCOUNT</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="nf">summarise</span><span class="p">(</span><span class="n">no</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="n">INTERNAL_AMOUNT</span><span class="p">))</span> <span class="o">%&gt;%</span>
  <span class="nf">filter</span><span class="p">(</span><span class="n">no</span> <span class="o">&gt;</span> <span class="m">1000000</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="nf">arrange</span><span class="p">(</span><span class="n">no</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="nf">mutate</span><span class="p">(</span><span class="n">no</span> <span class="o">=</span> <span class="n">no</span> <span class="o">%&gt;%</span> <span class="nf">as.numeric</span><span class="p">())</span> <span class="o">%&gt;%</span>
  <span class="n">collect</span> <span class="o">%&gt;%</span>
  <span class="n">summary</span>

<span class="n">tbl_sql</span> <span class="o">%&gt;%</span>
  <span class="nf">group_by</span><span class="p">(</span><span class="n">ACCOUNT</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="nf">summarise</span><span class="p">(</span><span class="n">no</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="n">INTERNAL_AMOUNT</span><span class="p">))</span> <span class="o">%&gt;%</span>
  <span class="nf">filter</span><span class="p">(</span><span class="n">no</span> <span class="o">&gt;</span> <span class="m">1000000</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="nf">arrange</span><span class="p">(</span><span class="n">no</span><span class="p">)</span> <span class="o">%&gt;%</span>
  <span class="nf">show_query</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="p03-08-r-server.html" class="btn btn-neutral float-right" title="3. SQL RServer" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="p03-06-sql-va-excel.html" class="btn btn-neutral float-left" title="1. Kết nối SQL với Excel phục vụ báo cáo tự động" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Anh Hoang Duc

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>