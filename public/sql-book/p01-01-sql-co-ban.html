

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="vi" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="vi" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>1. Giới thiệu về SQL &mdash; Tài liệu Khai thác dữ liệu với SQL 2019</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'./',
              VERSION:'2019',
              LANGUAGE:'vi',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
        <script type="text/javascript" src="_static/copybutton.js"></script>
        <script type="text/javascript" src="_static/translations.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/copybutton.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Tìm Kiếm" href="search.html" />
    <link rel="next" title="11. Tricks khi dùng với SQL" href="p01-02-tricks-sql.html" />
    <link rel="prev" title="SQL cơ bản" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Khai thác dữ liệu với SQL
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">SQL cơ bản</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">1. Giới thiệu về SQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="#cac-nhom-cau-lenh-truy-van-tong-hop">2. Các nhóm câu lệnh truy vấn, tổng hợp</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#cach-viet-comment">2.1. Cách viêt comment</a></li>
<li class="toctree-l2"><a class="reference internal" href="#khai-quat-cac-cau-lenh-truy-van-trong-sql">2.2. Khái quát các câu lệnh truy vấn trong SQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ham-select">2.3. Hàm SELECT</a></li>
<li class="toctree-l2"><a class="reference internal" href="#cau-lenh-where">2.4. Câu lệnh where</a></li>
<li class="toctree-l2"><a class="reference internal" href="#xu-ly-null">2.5. Xử lý null</a></li>
<li class="toctree-l2"><a class="reference internal" href="#case-when">2.6. CASE WHEN</a></li>
<li class="toctree-l2"><a class="reference internal" href="#having">2.7. Having</a></li>
<li class="toctree-l2"><a class="reference internal" href="#union">2.8. Union</a></li>
<li class="toctree-l2"><a class="reference internal" href="#window-function">2.9. Window function</a></li>
<li class="toctree-l2"><a class="reference internal" href="#cac-nhom-cau-lenh-tinh-toan">2.10. Các nhóm câu lệnh tính toán</a></li>
<li class="toctree-l2"><a class="reference internal" href="#join-cac-bang">2.11. Join các bảng</a></li>
<li class="toctree-l2"><a class="reference internal" href="#lam-viec-voi-string">2.12. Làm việc với string</a></li>
<li class="toctree-l2"><a class="reference internal" href="#lam-viec-voi-date">2.13. Làm việc với date</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#datediff">2.13.1. Datediff</a></li>
<li class="toctree-l3"><a class="reference internal" href="#dateadd">2.13.2. Dateadd</a></li>
<li class="toctree-l3"><a class="reference internal" href="#tricks-voi-du-lieu-thoi-gian">2.13.3. Tricks với dữ liệu thời gian</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#cac-nhom-cau-lenh-thay-doi-du-lieu-trong-csdl">3. Các nhóm câu lệnh thay đổi dữ liệu trong CSDL</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#tao-bang-moi">3.1. Tạo bảng mới</a></li>
<li class="toctree-l2"><a class="reference internal" href="#xoa-bang-drop-table">3.2. Xóa bảng Drop Table</a></li>
<li class="toctree-l2"><a class="reference internal" href="#insert-into">3.3. INSERT INTO</a></li>
<li class="toctree-l2"><a class="reference internal" href="#update">3.4. Update</a></li>
<li class="toctree-l2"><a class="reference internal" href="#delete-from">3.5. Delete from</a></li>
<li class="toctree-l2"><a class="reference internal" href="#alter-table">3.6. Alter table</a></li>
<li class="toctree-l2"><a class="reference internal" href="#doi-ten-bang-ten-cot">3.7. Đổi tên bảng, tên cột</a></li>
<li class="toctree-l2"><a class="reference internal" href="#truncate">3.8. Truncate</a></li>
<li class="toctree-l2"><a class="reference internal" href="#alter-thay-doi-dinh-dang-du-lieu-cua-cot">3.9. ALTER - Thay đổi định dạng dữ liệu của cột</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#sub-query">4. Sub Query</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#sub-query-co-ban">4.1. Sub Query cơ bản</a></li>
<li class="toctree-l2"><a class="reference internal" href="#su-dung-with-thay-the-subquery">4.2. Sử dụng WITH thay thế subquery</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#cac-nhom-cau-lenh-co-ban-khac">5. Các nhóm câu lệnh cơ bản khác</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#exists">5.1. Exists</a></li>
<li class="toctree-l2"><a class="reference internal" href="#any-vs-all">5.2. Any vs.&nbsp;All</a></li>
<li class="toctree-l2"><a class="reference internal" href="#view">5.3. View</a></li>
<li class="toctree-l2"><a class="reference internal" href="#index">5.4. Index</a></li>
<li class="toctree-l2"><a class="reference internal" href="#bang-tam">5.5. Bảng tạm</a></li>
<li class="toctree-l2"><a class="reference internal" href="#kiem-tra-kieu-du-lieu-trong-bang">5.6. Kiểm tra kiểu dữ liệu trong bảng</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#sql-dong-voi-exec">6. SQL động với Exec</a></li>
<li class="toctree-l1"><a class="reference internal" href="#ham-va-thu-tuc">7. Hàm và thủ tục</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#procedure">7.1. Procedure</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#hien-thi-tat-ca-cac-procedure-dang-luu-trong-he-thong">7.1.1. Hiển thị tất cả các procedure đang lưu trong hệ thống</a></li>
<li class="toctree-l3"><a class="reference internal" href="#tao-procedure">7.1.2. Tạo procedure</a></li>
<li class="toctree-l3"><a class="reference internal" href="#gan-ket-qua-1-procedure-vao-bien">7.1.3. Gán kết quả 1 procedure vào biến</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#ham-function">7.2. Hàm (function)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#cac-nhom-cau-lenh-nang-cao">8. Các nhóm câu lệnh nâng cao</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#if-else">8.1. If…Else</a></li>
<li class="toctree-l2"><a class="reference internal" href="#check-dieu-kien-de-thuc-thi-tiep">8.2. Check điều kiện để thực thi tiếp</a></li>
<li class="toctree-l2"><a class="reference internal" href="#vong-lap-voi-bang">8.3. Vòng lặp với bảng</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#dat-job-trong-sql">9. Đặt job trong SQL</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#buoc-1-active-email-tu-dong">9.1. Bước 1: Active email tự động</a></li>
<li class="toctree-l2"><a class="reference internal" href="#buoc-2-dang-ki-email-trong-database-mail">9.2. Bước 2: Đăng kí email trong Database mail</a></li>
<li class="toctree-l2"><a class="reference internal" href="#buoc-3-active-sql-server-agent">9.3. Bước 3: Active SQL Server Agent</a></li>
<li class="toctree-l2"><a class="reference internal" href="#buoc-4-dat-job">9.4. Bước 4: Đặt Job</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#cac-nhom-cau-lenh-quan-tri">10. Các nhóm câu lệnh quản trị</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#tim-kiem-cac-query-dang-chay">10.1. Tìm kiếm các query đang chạy</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="p01-02-tricks-sql.html">11. Tricks khi dùng với SQL</a></li>
</ul>
<p class="caption"><span class="caption-text">SQL nâng cao</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="p02-03-sql-nang-cao.html">1. Pivot - Unpivot</a></li>
<li class="toctree-l1"><a class="reference internal" href="p02-03-sql-nang-cao.html#chia-mot-cot-thanh-nhieu-cot">2. Chia một cột thành nhiều cột</a></li>
<li class="toctree-l1"><a class="reference internal" href="p02-04-sqlcmd.html">3. SQLCMD</a></li>
<li class="toctree-l1"><a class="reference internal" href="p02-05-sql-project.html">4. SQL prọject</a></li>
</ul>
<p class="caption"><span class="caption-text">SQL &amp; Analytics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="p03-06-sql-va-excel.html">1. Kết nối SQL với Excel phục vụ báo cáo tự động</a></li>
<li class="toctree-l1"><a class="reference internal" href="p03-07-r-va-sql.html">2. R &amp; SQL Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="p03-08-r-server.html">3. SQL RServer</a></li>
</ul>
<p class="caption"><span class="caption-text">Xây dựng DataMart</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="p04-11-xay-dung-database.html">1. Xây dựng Data warehouse &amp; Data Mart</a></li>
</ul>
<p class="caption"><span class="caption-text">Tài liệu tham khảo:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="p09-79-tai-lieu-tham-khao.html">Tài liệu tham khảo</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Khai thác dữ liệu với SQL</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>1. Giới thiệu về SQL</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/p01-01-sql-co-ban.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast,
.nboutput.nblast {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast + .nbinput {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="gioi-thieu-ve-sql">
<h1>1. Giới thiệu về SQL<a class="headerlink" href="#gioi-thieu-ve-sql" title="Permalink to this headline">¶</a></h1>
<p>SQL là viết tắt của <em>Structured Language Query</em>, là một ngôn ngữ truy
vấn, xử lý và làm việc với database.</p>
<p>SQL được cấu thành từ 3 nhóm câu lệnh lớn:</p>
<ul class="simple">
<li>Data Manipulation Language (DML): Select, Insert, Update, Delete</li>
<li>Data Definition Language (DDL): Create, Alter, Drop</li>
<li>Data Control Language (DCL): Grant, Revoke &amp; Deny</li>
</ul>
<p>Tuy nhiên, nếu chia theo các câu lệnh để ứng dụng trong phân tích dữ
liệu, có 3 nhóm sau.</p>
<ul class="simple">
<li>Nhóm câu lệnh truy vấn, tổng hợp dữ liệu: Cho phép truy vấn, tổng hợp
dữ liệu nhưng không làm thay đổi dữ liệu đang có trong database. Các
nhóm này gồm:<ul>
<li>Nhóm truy vấn: Select, Where, Join</li>
<li>Nhóm tổng hợp: Yêu cầu cần có hàm tổng hợp dữ liệu (aggregate
functions) và nhóm hàm <code class="docutils literal notranslate"><span class="pre">group</span> <span class="pre">by</span></code></li>
</ul>
</li>
<li>Nhóm câu lệnh làm thay đổi cơ sở dữ liệu: Cho phép thay đổi, điều
chỉnh dữ liệu đang có trong database.<ul>
<li>Alter</li>
<li>Update</li>
<li>Insert</li>
<li>Delete</li>
</ul>
</li>
<li>Các nhóm câu lệnh kiểm tra, phân quyền người dùng: Grant, Revoke,
Deny</li>
</ul>
<p>Ngoài ra, SQL còn rất mạnh trong việc đặt <code class="docutils literal notranslate"><span class="pre">job</span></code>, xây dựng các câu lệnh
tự động với <code class="docutils literal notranslate"><span class="pre">exec</span></code>, xây dựng các hàm (functions) và thủ tục
(procedure) trong hệ thống.</p>
<p>Để học và ứng dụng tốt SQL, nên đi theo lộ trình sau.</p>
<ul class="simple">
<li>Các nhóm câu lệnh truy vấn: Select, Join, Where, Group By, Pivot,
Unpivot,</li>
<li>Sub Query</li>
<li>Nhóm câu lệnh biến đồi: Alter, Update, Insert, Delete</li>
<li>Các nhóm câu lệnh làm việc với chuỗi (string), thời gian (date)</li>
<li>SQL động</li>
<li>Vòng lặp</li>
<li>Đặt job</li>
</ul>
<p>Ngoài ra, khi làm việc với các ngôn ngữ phân tích dữ liệu như R hoặc
Python, cần nắm vững cách thức truy vấn dữ liệu từ SQL sang các công cụ
phân tích.</p>
</div>
<div class="section" id="cac-nhom-cau-lenh-truy-van-tong-hop">
<h1>2. Các nhóm câu lệnh truy vấn, tổng hợp<a class="headerlink" href="#cac-nhom-cau-lenh-truy-van-tong-hop" title="Permalink to this headline">¶</a></h1>
<div class="section" id="cach-viet-comment">
<h2>2.1. Cách viêt comment<a class="headerlink" href="#cach-viet-comment" title="Permalink to this headline">¶</a></h2>
<p>Sử dụng dấu <code class="docutils literal notranslate"><span class="pre">--</span></code> hoặc trong block <code class="docutils literal notranslate"><span class="pre">/*.....*/</span></code></p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm">Cách 1: This is</span>
<span class="cm">my block of comment</span>
<span class="cm">*/</span>

<span class="c1">--Cách 2</span>
<span class="c1">--Khó dùng hơn</span>
</pre></div>
</div>
</div>
<div class="section" id="khai-quat-cac-cau-lenh-truy-van-trong-sql">
<h2>2.2. Khái quát các câu lệnh truy vấn trong SQL<a class="headerlink" href="#khai-quat-cac-cau-lenh-truy-van-trong-sql" title="Permalink to this headline">¶</a></h2>
<p>Các câu lệnh SQL diễn ra theo thứ tự sau:</p>
<p>SELECT &gt;&gt; FROM &gt;&gt; WHERE &gt;&gt; GROUP BY &gt;&gt; HAVING &gt;&gt; ORDER BY</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span>
<span class="p">[</span><span class="k">DISTINCT</span><span class="p">][</span><span class="n">TOP</span> <span class="p">(</span><span class="n">n</span><span class="p">)]</span> <span class="o">*</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="k">or</span> <span class="n">expressions</span>
<span class="p">[</span><span class="k">FROM</span> <span class="k">data</span> <span class="k">source</span><span class="p">(</span><span class="n">s</span><span class="p">)]</span>
<span class="p">[</span><span class="k">JOIN</span> <span class="k">data</span> <span class="k">source</span>
<span class="k">ON</span> <span class="n">condition</span><span class="p">](</span><span class="n">may</span> <span class="n">include</span> <span class="n">multiple</span> <span class="n">joins</span><span class="p">)</span>
<span class="p">[</span><span class="k">WHERE</span> <span class="n">conditions</span><span class="p">]</span>
<span class="p">[</span><span class="k">GROUP</span> <span class="k">BY</span> <span class="n">columns</span><span class="p">]</span>
<span class="p">[</span><span class="k">HAVING</span> <span class="n">conditions</span><span class="p">]</span>
<span class="p">[</span><span class="k">ORDER</span> <span class="k">BY</span> <span class="n">Columns</span><span class="p">];</span>
</pre></div>
</div>
</div>
<div class="section" id="ham-select">
<h2>2.3. Hàm SELECT<a class="headerlink" href="#ham-select" title="Permalink to this headline">¶</a></h2>
<p><strong>Lưu ý</strong>: Các bảng thường bắt đầu bằng <strong>.dbo</strong>, gọi là <em>schema</em>. Thông
thường, schema này là default. Tuy nhiên, nếu DB admin đổi schema, ta
cần phải đổi câu lệnh</p>
<ul class="simple">
<li>Lấy tất cả các biến</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">---Cách 1</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">AdventureWorksDW2012</span><span class="p">.</span><span class="n">dbo</span><span class="p">.</span><span class="n">DimCustomer</span>

<span class="c1">---Cách 2</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">AdventureWorksDW2012</span><span class="p">..</span><span class="n">DimCustomer</span>

<span class="c1">---Cách 3: Khai báo DB với use</span>
<span class="n">use</span> <span class="n">AdventureWorksDW2012</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">DimCustomer</span>
</pre></div>
</div>
<ul class="simple">
<li>Lấy top n dòng đầu tiên hoặc n phần trăm đầu tiên</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span> <span class="n">top</span> <span class="mi">5</span> <span class="o">*</span> <span class="k">from</span> <span class="n">learnsql</span><span class="p">.</span><span class="n">dbo</span><span class="p">.</span><span class="n">product</span>
<span class="k">select</span> <span class="n">top</span> <span class="mi">50</span> <span class="n">percent</span> <span class="o">*</span> <span class="k">from</span> <span class="n">learnsql</span><span class="p">.</span><span class="n">dbo</span><span class="p">.</span><span class="n">product</span>
</pre></div>
</div>
<ul class="simple">
<li>Lấy một vài biến</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">--Cách 1</span>
<span class="k">select</span> <span class="n">Product_CD</span><span class="p">,</span> <span class="n">Date_offered</span> <span class="k">from</span> <span class="n">learnsql</span><span class="p">.</span><span class="n">dbo</span><span class="p">.</span><span class="n">product</span>

<span class="c1">-- Cách 2</span>
<span class="k">select</span> <span class="n">A</span><span class="p">.</span><span class="n">Product_CD</span><span class="p">,</span> <span class="n">A</span><span class="p">.</span><span class="n">Date_offered</span>
        <span class="k">from</span> <span class="n">learnsql</span><span class="p">.</span><span class="n">dbo</span><span class="p">.</span><span class="n">product</span> <span class="n">A</span>

<span class="c1">-- Cách 3: Dùng Aliases</span>
<span class="k">select</span> <span class="n">Product_CD</span> <span class="k">as</span> <span class="p">[</span><span class="n">Product</span> <span class="k">new</span> <span class="n">CD</span><span class="p">]</span> <span class="k">from</span> <span class="n">learnsql</span><span class="p">.</span><span class="n">dbo</span><span class="p">.</span><span class="n">product</span>
</pre></div>
</div>
<p><strong>Lưu ý</strong>: Đặt tên bảng là A trong cách thứ 2 giúp ích khi lấy dữ liệu
và nhóm các giá trị từ nhiều bảng</p>
<ul class="simple">
<li>Ghép kết quả</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">--- TH1: Cùng kiểu dữ liệu nvarchar</span>
<span class="k">select</span> <span class="n">firstname</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="n">lastname</span> <span class="k">as</span> <span class="p">[</span><span class="n">FULL_NAME</span><span class="p">]</span> <span class="k">from</span> <span class="n">dimcustomer</span>

<span class="c1">--- TH2: nvarchar với numeric</span>
<span class="c1">--- Dùng cast</span>

<span class="k">select</span> <span class="n">lastname</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="k">cast</span><span class="p">(</span><span class="n">customerkey</span> <span class="k">as</span> <span class="n">nvarchar</span><span class="p">)</span> <span class="k">as</span> <span class="p">[</span><span class="n">Name</span> <span class="n">ID</span><span class="p">]</span>
<span class="k">from</span> <span class="n">dimcustomer</span>

<span class="c1">--- Dùng convert</span>
<span class="k">select</span> <span class="n">lastname</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="k">convert</span><span class="p">(</span><span class="n">nvarchar</span><span class="p">,</span> <span class="n">customerkey</span><span class="p">)</span> <span class="k">as</span> <span class="p">[</span><span class="n">Name</span> <span class="n">ID</span><span class="p">]</span>
<span class="k">from</span> <span class="n">DimCustomer</span>
</pre></div>
</div>
<ul class="simple">
<li>Lấy các giá trị không trùng lặp: dùng hàm distinct</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span> <span class="k">distinct</span> <span class="n">Pro</span><span class="p">.</span><span class="n">Product_Type_Cd</span> <span class="k">from</span> <span class="n">db</span><span class="p">.</span><span class="n">Product</span> <span class="n">Pro</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="cau-lenh-where">
<h2>2.4. Câu lệnh where<a class="headerlink" href="#cau-lenh-where" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><strong>Where</strong>: Tìm điều kiện theo dòng</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">Select</span> <span class="o">*</span> <span class="k">From</span>
      <span class="n">learnsql</span><span class="p">.</span><span class="n">dbo</span><span class="p">.</span><span class="n">Product</span> <span class="n">Pro</span>
      <span class="k">Where</span> <span class="n">Pro</span><span class="p">.</span><span class="n">Product_Type_Cd</span> <span class="o">=</span> <span class="s1">&#39;LOAN&#39;</span>

<span class="c1">--- Dấu khác</span>
<span class="k">Select</span> <span class="o">*</span> <span class="k">From</span>
      <span class="n">learnsql</span><span class="p">.</span><span class="n">dbo</span><span class="p">.</span><span class="n">Product</span> <span class="n">Pro</span>
      <span class="k">Where</span> <span class="n">Pro</span><span class="p">.</span><span class="n">Product_Type_Cd</span> <span class="o">&lt;&gt;</span> <span class="s1">&#39;LOAN&#39;</span>
</pre></div>
</div>
<ul class="simple">
<li>IN</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">--Lựa chọn nhiều điều kiện</span>
<span class="k">Select</span> <span class="n">Emp</span><span class="p">.</span><span class="n">Emp_Id</span>
     <span class="p">,</span><span class="n">Emp</span><span class="p">.</span><span class="n">First_Name</span>
     <span class="p">,</span><span class="n">Emp</span><span class="p">.</span><span class="n">Last_Name</span>
     <span class="p">,</span><span class="n">Emp</span><span class="p">.</span><span class="n">Dept_Id</span>
    <span class="k">From</span>  <span class="n">learnsql</span><span class="p">.</span><span class="n">dbo</span><span class="p">.</span><span class="n">Employee</span> <span class="n">Emp</span>
    <span class="k">Where</span>  <span class="n">Emp</span><span class="p">.</span><span class="n">First_Name</span> <span class="k">In</span> <span class="p">(</span><span class="s1">&#39;Susan&#39;</span><span class="p">,</span><span class="s1">&#39;Paula&#39;</span><span class="p">)</span> <span class="k">OR</span>
           <span class="p">(</span><span class="n">Emp</span><span class="p">.</span><span class="n">Last_Name</span> <span class="k">not</span> <span class="k">In</span> <span class="p">(</span><span class="s1">&#39;Fleming&#39;</span><span class="p">,</span> <span class="s1">&#39;Roberts&#39;</span><span class="p">)</span> <span class="k">AND</span>
           <span class="n">Emp</span><span class="p">.</span><span class="n">Emp_Id</span> <span class="o">=</span> <span class="s1">&#39;6&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Lưu ý</strong>: Toán tử IN trong SQL tương tự như %in% trong R</p>
<ul class="simple">
<li>Kết hợp toán tử AND, OR</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">Select</span> <span class="o">*</span> <span class="k">From</span>
      <span class="n">learnsql</span><span class="p">.</span><span class="n">dbo</span><span class="p">.</span><span class="n">Product</span> <span class="n">Pro</span>
      <span class="k">Where</span> <span class="p">(</span><span class="n">Pro</span><span class="p">.</span><span class="n">Product_Type_Cd</span> <span class="o">=</span> <span class="s1">&#39;LOAN&#39;</span> <span class="k">AND</span>
      <span class="n">Pro</span><span class="p">.</span><span class="n">Product_CD</span> <span class="o">=</span> <span class="s1">&#39;AUT&#39;</span><span class="p">)</span> <span class="k">OR</span>
      <span class="p">(</span><span class="n">Pro</span><span class="p">.</span><span class="n">NAME</span> <span class="k">like</span> <span class="s1">&#39;%dep%&#39;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li>Truy vấn đồng thời tính toán trong SQL</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">--Lưu ý: Để phép toán cần tính trong dấu ngoặc đơn</span>
<span class="c1">--DUC_ANH là tên biến mới sau khi biến đổi</span>
<span class="k">SELECT</span> <span class="n">top</span> <span class="mi">10</span> <span class="p">[</span><span class="n">BUSINESS_DATE</span><span class="p">]</span>
      <span class="p">,[</span><span class="n">ACNT_CONTRACT_ID</span><span class="p">]</span>
      <span class="p">,[</span><span class="n">CARD_STATUS</span><span class="p">]</span>
      <span class="p">,([</span><span class="n">CARD_LIMIT</span><span class="p">]</span> <span class="o">+</span> <span class="mi">10000</span><span class="p">)</span><span class="o">/</span><span class="mi">30</span> <span class="k">as</span> <span class="n">DUC_ANH</span>
      <span class="p">,[</span><span class="n">BALANCE</span><span class="p">]</span>
      <span class="p">,[</span><span class="n">T24_CIF</span><span class="p">]</span>
      <span class="p">,[</span><span class="n">CUSTOMER_NAME</span><span class="p">]</span>
  <span class="k">FROM</span> <span class="p">[</span><span class="n">SERVER74</span><span class="p">].[</span><span class="n">BICDATA</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">CARD_HIS</span><span class="p">]</span>
  <span class="k">where</span> <span class="n">customer_name</span> <span class="k">like</span> <span class="s1">&#39;%ANH&#39;</span>
</pre></div>
</div>
<p><strong>Lưu ý</strong>:</p>
<ul class="simple">
<li>Để phân biệt tên của các cột trong bảng với các điều kiện có thể bị
trùng. VD: Tên bảng là <strong>OR</strong> dễ bị trùng với điều kiện OR, ta đặt
tên bảng, tên DB trong dấu ngoặc vuông</li>
<li>Các phép toán thường gặp =,&lt;, &gt;, &gt;=, &lt;=, IN, &lt;&gt;, is not null</li>
<li>Các toán tử với <strong>Wild Card</strong>: LIKE, NOT LIKE<ul>
<li>Ký tự <strong>%ANH</strong>: tìm các character bắt đầu bằng bất cứ thứ gì nhưng
sau đó đi kèm chuỗi ký tự ANH</li>
<li>Ký tự **_** (underscore): tìm các ký tự đơn.</li>
</ul>
</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">top</span> <span class="mi">10</span> <span class="p">[</span><span class="n">BUSINESS_DATE</span><span class="p">]</span>
      <span class="p">,[</span><span class="n">CUSTOMER_NAME</span><span class="p">]</span>
  <span class="k">FROM</span> <span class="p">[</span><span class="n">SERVER74</span><span class="p">].[</span><span class="n">BICDATA</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">CARD_HIS</span><span class="p">]</span>
  <span class="k">where</span> <span class="n">customer_name</span> <span class="k">like</span> <span class="s1">&#39;%ANH&#39;</span> <span class="k">OR</span>
  <span class="n">customer_name</span> <span class="k">like</span> <span class="s1">&#39;A_H&#39;</span> <span class="k">and</span>
  <span class="n">card_status</span> <span class="k">is</span> <span class="k">not</span> <span class="k">null</span>
</pre></div>
</div>
</div>
<div class="section" id="xu-ly-null">
<h2>2.5. Xử lý null<a class="headerlink" href="#xu-ly-null" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Khi ghép 2 string, 1 string là NULL, SQL sẽ trả ra kết quả NULL
(không như R, tự động loại NA)</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">--- Dữ liệu gốc</span>
<span class="k">select</span> <span class="n">firstname</span><span class="p">,</span> <span class="n">middlename</span><span class="p">,</span> <span class="n">lastname</span> <span class="k">from</span> <span class="n">DimCustomer</span>

<span class="c1">--- Giá trị NULL</span>
<span class="k">select</span> <span class="n">firstname</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">middlename</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">lastname</span> <span class="k">as</span> <span class="p">[</span><span class="k">Full</span> <span class="n">Name</span><span class="p">]</span>
<span class="k">from</span> <span class="n">dimcustomer</span>

<span class="c1">--- Xử lý cách 1: Dùng ISNULL</span>
<span class="k">select</span> <span class="n">firstname</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="k">isnull</span><span class="p">(</span><span class="n">middlename</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">lastname</span>
<span class="k">as</span> <span class="p">[</span><span class="k">Full</span> <span class="n">Name</span><span class="p">]</span> <span class="k">from</span> <span class="n">dimcustomer</span>

<span class="c1">--- Xử lý cách 2: Dùng CASE WHEN</span>
<span class="k">select</span> <span class="n">firstname</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span>
<span class="k">case</span>
<span class="k">when</span> <span class="n">middlename</span> <span class="k">is</span> <span class="k">null</span> <span class="k">then</span> <span class="s1">&#39;&#39;</span>
<span class="k">else</span> <span class="n">middlename</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
<span class="k">end</span>
<span class="o">+</span> <span class="n">lastname</span> <span class="k">as</span> <span class="p">[</span><span class="k">Full</span> <span class="n">Name</span><span class="p">]</span> <span class="k">from</span> <span class="n">dimcustomer</span>

<span class="c1">-- Xử lý cách 3: Dùng Coalesce</span>
<span class="k">select</span> <span class="n">coalesce</span><span class="p">(</span><span class="n">firstname</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">middlename</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span><span class="n">lastname</span><span class="p">,</span>
<span class="n">firstname</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span><span class="n">lastname</span><span class="p">)</span> <span class="k">as</span> <span class="p">[</span><span class="k">Full</span> <span class="n">Name</span><span class="p">]</span> <span class="k">from</span> <span class="n">dimcustomer</span>
</pre></div>
</div>
</div>
<div class="section" id="case-when">
<h2>2.6. CASE WHEN<a class="headerlink" href="#case-when" title="Permalink to this headline">¶</a></h2>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span> <span class="n">AVAIL_BALANCE</span><span class="p">,</span>
<span class="p">(</span><span class="k">CASE</span>  <span class="k">when</span> <span class="n">AVAIL_BALANCE</span> <span class="o">&lt;</span> <span class="mi">5000</span> <span class="k">then</span> <span class="n">N</span><span class="s1">&#39;small&#39;</span>
      <span class="k">when</span> <span class="n">AVAIL_BALANCE</span> <span class="o">&gt;=</span> <span class="mi">5000</span> <span class="k">AND</span> <span class="n">AVAIL_BALANCE</span> <span class="o">&lt;=</span> <span class="mi">10000</span> <span class="k">then</span> <span class="n">N</span><span class="s1">&#39;medium&#39;</span>
      <span class="k">else</span> <span class="n">N</span><span class="s1">&#39;high&#39;</span>
      <span class="k">END</span><span class="p">)</span> <span class="k">as</span> <span class="n">category</span>
<span class="k">from</span> <span class="n">account</span>
</pre></div>
</div>
<p><strong>Lưu ý</strong>:</p>
<ul class="simple">
<li>N trong câu lệnh trên viết tắt của NVARCHAR để khai báo dạng lệnh</li>
</ul>
</div>
<div class="section" id="having">
<h2>2.7. Having<a class="headerlink" href="#having" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><strong>Having</strong>: Tìm điều kiện sau khi có kết quả. Lưu ý: Câu lệnh Having
không hoạt động với ALIAS, phải hiển thị điều kiện từ bảng gốc</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span>
 <span class="n">OPEN_BRANCH_ID</span>
<span class="p">,</span><span class="k">sum</span><span class="p">(</span><span class="n">AVAIL_BALANCE</span><span class="p">)</span> <span class="k">as</span> <span class="k">new</span>
<span class="k">from</span> <span class="n">account</span>
<span class="k">group</span> <span class="k">by</span> <span class="n">OPEN_BRANCH_ID</span>
<span class="k">having</span> <span class="k">sum</span><span class="p">(</span><span class="n">AVAIL_BALANCE</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">500000</span>

<span class="c1">-- Câu lệnh sau sẽ không chạy với where</span>

<span class="k">select</span>
 <span class="n">OPEN_BRANCH_ID</span>
<span class="p">,</span><span class="k">sum</span><span class="p">(</span><span class="n">AVAIL_BALANCE</span><span class="p">)</span> <span class="k">as</span> <span class="k">new</span>
<span class="k">where</span> <span class="k">sum</span><span class="p">(</span><span class="n">AVAIL_BALANCE</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">500000</span>
<span class="k">from</span> <span class="n">account</span>
<span class="k">group</span> <span class="k">by</span> <span class="n">OPEN_BRANCH_ID</span>
</pre></div>
</div>
<p><strong>Lưu ý</strong>: Ký tự trong SQL cần đặt trong 1 dấu nháy đơn ’’</p>
<ul class="simple">
<li>Có thể sử dụng các phép toán đơn giản trong WHERE</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">ACCOUNT</span>
<span class="k">where</span> <span class="n">AVAIL_BALANCE</span> <span class="o">+</span> <span class="mi">30</span> <span class="o">&lt;=</span> <span class="mi">6000</span>
</pre></div>
</div>
</div>
<div class="section" id="union">
<h2>2.8. Union<a class="headerlink" href="#union" title="Permalink to this headline">¶</a></h2>
<p>Nhóm câu lệnh Union có 2 câu lệnh chính:</p>
<ul class="simple">
<li>UNION: Loại bỏ các giá trị trùng của các dòng</li>
<li>UNION ALL: Hiển thị tất cả các giá trị</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="k">SELECT</span> <span class="n">top</span> <span class="mi">10</span>
<span class="p">[</span><span class="n">CUSTOMER_NAME</span><span class="p">]</span>
<span class="k">FROM</span> <span class="p">[</span><span class="n">SERVER74</span><span class="p">].[</span><span class="n">BICDATA</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">CARD_HIS</span><span class="p">]</span>
<span class="k">where</span> <span class="p">[</span><span class="n">CUSTOMER_NAME</span><span class="p">]</span> <span class="k">like</span> <span class="s1">&#39;%HƯƠNG&#39;</span><span class="p">)</span>
<span class="k">UNION</span> <span class="k">ALL</span>
<span class="k">SELECT</span> <span class="n">top</span> <span class="mi">10</span>
<span class="p">[</span><span class="n">CUSTOMER_NAME</span><span class="p">]</span>
<span class="k">FROM</span> <span class="p">[</span><span class="n">SERVER74</span><span class="p">].[</span><span class="n">BICDATA</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">BALANCE_HIS</span><span class="p">]</span>
<span class="k">where</span> <span class="p">[</span><span class="n">CUSTOMER_NAME</span><span class="p">]</span> <span class="k">like</span> <span class="s1">&#39;%HƯƠNG&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="window-function">
<h2>2.9. Window function<a class="headerlink" href="#window-function" title="Permalink to this headline">¶</a></h2>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span> <span class="n">CUST_ID</span><span class="p">,</span>
        <span class="n">AVAIL_BALANCE</span><span class="p">,</span>
        <span class="n">ROW_NUMBER</span><span class="p">()</span> <span class="n">over</span><span class="p">(</span><span class="n">partition</span> <span class="k">by</span> <span class="n">cust_id</span> <span class="k">order</span> <span class="k">by</span> <span class="n">AVAIL_BALANCE</span><span class="p">)</span> <span class="k">as</span> <span class="p">[</span><span class="k">ORDER</span><span class="p">],</span>
        <span class="k">avg</span><span class="p">(</span><span class="n">AVAIL_BALANCE</span><span class="p">)</span> <span class="n">over</span><span class="p">(</span><span class="n">partition</span> <span class="k">by</span> <span class="n">cust_id</span><span class="p">)</span> <span class="k">as</span> <span class="n">AVG_BALANCE_ID</span>
<span class="k">from</span> <span class="n">ACCOUNT</span>
</pre></div>
</div>
<p><strong>Giải thich</strong>:</p>
<ul class="simple">
<li>Nhóm cust_id</li>
<li>Tính giá trị trung bình, row_number, trả ra kết quả</li>
<li>Hàm <code class="docutils literal notranslate"><span class="pre">OVER</span> <span class="pre">PARTITION</span> <span class="pre">BY</span></code> ứng với <code class="docutils literal notranslate"><span class="pre">group_by</span> <span class="pre">%&gt;%</span> <span class="pre">mutate</span></code> trong R</li>
</ul>
<p><strong>Ứng dụng nâng cao</strong>: Ngoài ra, window function có thể partition theo
dòng</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Trường hợp 1: Mặc định</span>
<span class="k">select</span> <span class="k">max</span><span class="p">(</span><span class="n">start_time</span><span class="p">)</span> <span class="n">over</span> <span class="p">(</span><span class="n">partition</span> <span class="k">by</span> <span class="n">cusid</span> <span class="k">order</span> <span class="k">by</span> <span class="n">start_t</span>
          <span class="k">rows</span> <span class="n">unbounded</span> <span class="n">preceding</span><span class="p">)</span> <span class="c1">-- Tìm max start_time đến dòng hiện tại theo cusid</span>
<span class="c1">-- Trường hợp 2: Nâng cao</span>
<span class="k">select</span> <span class="k">max</span><span class="p">(</span><span class="n">start_time</span><span class="p">)</span> <span class="n">over</span> <span class="p">(</span><span class="n">partition</span> <span class="k">by</span> <span class="n">cusid</span> <span class="k">order</span> <span class="k">by</span> <span class="n">start_t</span>
          <span class="k">rows</span> <span class="k">between</span> <span class="n">unbounded</span> <span class="n">preceding</span> <span class="mi">1</span> <span class="n">preceding</span><span class="p">)</span> <span class="c1">-- Tìm max start_time đến dòng phía trên dòng hiện tại theo cusid</span>
</pre></div>
</div>
<p><strong>Ứng dụng</strong>: Khách hàng đi grab không cho phép booking khi chưa hết
chuyến. Grab thí điểm sử dụng multiple booking. Xác định các chuyến nào
là multiple booking</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">drop</span> <span class="k">table</span> <span class="k">if</span> <span class="k">exists</span> <span class="n">gap</span>
<span class="k">GO</span>

<span class="k">create</span> <span class="k">table</span> <span class="n">gap</span>
<span class="p">(</span><span class="n">cusid</span> <span class="nb">int</span><span class="p">,</span> <span class="n">booking_id</span> <span class="nb">int</span><span class="p">,</span> <span class="n">start_time</span> <span class="nb">int</span><span class="p">,</span> <span class="n">end_time</span> <span class="nb">int</span><span class="p">)</span>


<span class="k">insert</span> <span class="k">into</span> <span class="n">gap</span> <span class="p">(</span><span class="n">cusid</span><span class="p">,</span> <span class="n">booking_id</span><span class="p">,</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span>
<span class="k">values</span>
<span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span>
<span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span>
<span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>
<span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>
<span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span>
<span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span>
<span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">23</span><span class="p">),</span>
<span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>
<span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span>
<span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
<span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span>
<span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">19</span><span class="p">),</span>
<span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>
<span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">21</span><span class="p">),</span>
<span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">23</span><span class="p">)</span>


<span class="k">drop</span> <span class="k">table</span> <span class="k">if</span> <span class="k">exists</span> <span class="o">#</span><span class="n">final_results</span><span class="p">,</span> <span class="o">#</span><span class="n">t1</span><span class="p">,</span> <span class="o">#</span><span class="n">t2</span>

<span class="k">SELECT</span>  <span class="o">*</span><span class="p">,</span>
    <span class="k">MAX</span><span class="p">(</span><span class="n">end_time</span><span class="p">)</span> <span class="n">OVER</span><span class="p">(</span><span class="n">PARTITION</span> <span class="k">BY</span> <span class="n">cusid</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span>
    <span class="k">ROWS</span> <span class="k">BETWEEN</span> <span class="n">UNBOUNDED</span> <span class="n">PRECEDING</span> <span class="k">AND</span> <span class="mi">1</span> <span class="n">PRECEDING</span><span class="p">)</span> <span class="k">AS</span> <span class="n">prev_end</span>
<span class="k">into</span> <span class="o">#</span><span class="n">t1</span>
<span class="k">FROM</span> <span class="n">GAP</span>


<span class="k">select</span>
    <span class="o">*</span><span class="p">,</span> <span class="k">sum</span><span class="p">(</span><span class="n">is_start</span><span class="p">)</span> <span class="n">over</span><span class="p">(</span><span class="n">partition</span> <span class="k">by</span> <span class="n">cusid</span> <span class="k">order</span> <span class="k">by</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">)</span> <span class="k">as</span> <span class="p">[</span><span class="k">group</span><span class="p">]</span>
<span class="k">into</span> <span class="o">#</span><span class="n">t2</span>
<span class="k">from</span>
    <span class="p">(</span><span class="k">select</span> <span class="o">*</span><span class="p">,</span>
        <span class="k">case</span> <span class="k">when</span> <span class="n">Start_time</span> <span class="o">&lt;=</span> <span class="n">prev_end</span> <span class="k">then</span> <span class="k">null</span> <span class="k">else</span> <span class="mi">1</span> <span class="k">end</span> <span class="k">as</span> <span class="n">is_start</span>
    <span class="k">from</span> <span class="o">#</span><span class="n">t1</span>
    <span class="p">)</span> <span class="n">a</span> <span class="p">;</span>

<span class="k">with</span> <span class="n">T3</span> <span class="k">AS</span>
    <span class="p">(</span><span class="k">selecT</span> <span class="n">CUSID</span><span class="p">,</span> <span class="p">[</span><span class="k">group</span><span class="p">]</span>
    <span class="k">from</span> <span class="o">#</span><span class="n">t2</span> <span class="n">A</span>
    <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">Cusid</span><span class="p">,</span> <span class="p">[</span><span class="k">group</span><span class="p">]</span>
    <span class="k">HAVING</span> <span class="k">COUNT</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
    <span class="p">)</span>
<span class="k">SELECT</span> <span class="o">#</span><span class="n">t2</span><span class="p">.</span><span class="o">*</span> <span class="p">,</span>
    <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">T3</span><span class="p">.[</span><span class="k">group</span><span class="p">]</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">THEN</span> <span class="s1">&#39;Multi booking&#39;</span> <span class="k">ELSE</span> <span class="s1">&#39;Single Booking&#39;</span> <span class="k">END</span> <span class="k">AS</span> <span class="n">BOOKING_TYPE</span>
<span class="k">INTO</span> <span class="o">#</span><span class="n">final_results</span>
<span class="k">FROM</span> <span class="o">#</span><span class="n">t2</span>
    <span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">T3</span>
        <span class="k">ON</span> <span class="o">#</span><span class="n">t2</span><span class="p">.</span><span class="n">CUSID</span> <span class="o">=</span> <span class="n">T3</span><span class="p">.</span><span class="n">CUSID</span> <span class="k">AND</span> <span class="o">#</span><span class="n">t2</span><span class="p">.[</span><span class="k">group</span><span class="p">]</span> <span class="o">=</span> <span class="n">T3</span><span class="p">.[</span><span class="k">group</span><span class="p">]</span>

<span class="k">select</span> <span class="o">*</span>
<span class="k">from</span> <span class="o">#</span><span class="n">final_results</span>
</pre></div>
</div>
</div>
<div class="section" id="cac-nhom-cau-lenh-tinh-toan">
<h2>2.10. Các nhóm câu lệnh tính toán<a class="headerlink" href="#cac-nhom-cau-lenh-tinh-toan" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Các phép tính toán cơ bản: COUNT, AGV, MIN, MAX, VARIANCE, STDDEV</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span> <span class="k">count</span><span class="p">(</span><span class="n">AMOUNT</span><span class="p">)</span> <span class="k">as</span> <span class="n">n</span>
<span class="p">,</span> <span class="k">max</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span> <span class="k">as</span> <span class="k">max</span>
<span class="p">,</span> <span class="k">min</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span> <span class="k">as</span> <span class="k">min</span>
<span class="p">,</span> <span class="k">sum</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span> <span class="k">as</span> <span class="k">sum</span>
<span class="p">,</span> <span class="n">var</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span> <span class="k">as</span> <span class="n">var</span>
<span class="p">,</span> <span class="n">STDEV</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span> <span class="k">as</span> <span class="n">std_dev</span>
<span class="k">from</span> <span class="p">[</span><span class="n">learnsql</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">ACC_TRANSACTION</span><span class="p">]</span>
</pre></div>
</div>
<p><strong>Các phép tính hay dùng khác</strong>:</p>
<ul class="simple">
<li>FLOOR: Trả số nguyên lớn nhất nhỏ hơn số đã có</li>
<li>CEILING: trả số nguyên nhỏ nhất lớn hơn số đã có</li>
<li>ABS: Trả giá trị tuyệt đối</li>
<li>Các hàm khác: LN, LOG, EXP, POWER</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span> <span class="n">CEILING</span><span class="p">(</span><span class="mi">5</span><span class="p">.</span><span class="mi">3</span><span class="p">)</span>
<span class="k">select</span> <span class="n">floor</span><span class="p">(</span><span class="mi">5</span><span class="p">.</span><span class="mi">3</span><span class="p">)</span>
<span class="k">select</span> <span class="k">abs</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">.</span><span class="mi">3</span><span class="p">)</span>
<span class="k">select</span> <span class="n">power</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="join-cac-bang">
<h2>2.11. Join các bảng<a class="headerlink" href="#join-cac-bang" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><strong>Trường hợp 1 - Select tất cả các dòng không theo điều kiện</strong>: SQL
sẽ nối mỗi dòng ở bảng 1 với mỗi dòng ở bảng 2. Tổng số dòng trong
bảng mới sẽ là m*n dòng (m dòng ở bảng 1 và n dòng ở bảng 2)</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">--Trường hợp 1: Không có where</span>
<span class="k">select</span>
<span class="n">A</span><span class="p">.</span><span class="n">ACCOUNT_ID</span><span class="p">,</span> <span class="n">A</span><span class="p">.</span><span class="n">AVAIL_BALANCE</span><span class="p">,</span>
<span class="n">B</span><span class="p">.</span><span class="n">ADDRESS</span><span class="p">,</span> <span class="n">B</span><span class="p">.</span><span class="n">CITY</span>
<span class="k">from</span>
<span class="p">[</span><span class="n">learnsql</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">ACCOUNT</span><span class="p">]</span> <span class="n">A</span><span class="p">,</span> <span class="p">[</span><span class="n">learnsql</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">CUSTOMER</span><span class="p">]</span> <span class="n">B</span>
<span class="k">order</span> <span class="k">by</span> <span class="n">B</span><span class="p">.</span><span class="n">CITY</span>

<span class="c1">--Trường hợp 2: Sử dụng where</span>
<span class="k">select</span>
<span class="n">A</span><span class="p">.</span><span class="n">ACCOUNT_ID</span><span class="p">,</span> <span class="n">A</span><span class="p">.</span><span class="n">AVAIL_BALANCE</span><span class="p">,</span>
<span class="n">B</span><span class="p">.</span><span class="n">ADDRESS</span><span class="p">,</span> <span class="n">B</span><span class="p">.</span><span class="n">CITY</span>
<span class="k">from</span>
<span class="p">[</span><span class="n">learnsql</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">ACCOUNT</span><span class="p">]</span> <span class="n">A</span><span class="p">,</span> <span class="p">[</span><span class="n">learnsql</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">CUSTOMER</span><span class="p">]</span> <span class="n">B</span>
<span class="k">where</span> <span class="n">A</span><span class="p">.</span><span class="n">ACCOUNT_ID</span> <span class="o">&gt;</span> <span class="n">B</span><span class="p">.</span><span class="n">CUST_ID</span> <span class="k">and</span> <span class="n">city</span> <span class="o">=</span> <span class="s1">&#39;Woburn&#39;</span>
<span class="k">order</span> <span class="k">by</span> <span class="n">AVAIL_BALANCE</span>
</pre></div>
</div>
<ul class="simple">
<li><strong>Trường hợp 2 - Left join, right join</strong>: Các cột từ các bảng khác
nhau thì cần phải xác định alias</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span>
<span class="n">B</span><span class="p">.</span><span class="n">BRANCH_ID</span><span class="p">,</span> <span class="n">B</span><span class="p">.</span><span class="n">ADDRESS</span><span class="p">,</span> <span class="n">B</span><span class="p">.</span><span class="n">CITY</span><span class="p">,</span> <span class="n">B</span><span class="p">.</span><span class="n">NAME</span><span class="p">,</span>
<span class="n">A</span><span class="p">.</span><span class="n">ACCOUNT_ID</span><span class="p">,</span> <span class="n">A</span><span class="p">.</span><span class="n">AVAIL_BALANCE</span>
<span class="k">from</span> <span class="n">branch</span> <span class="n">B</span>
<span class="k">left</span> <span class="k">outer</span> <span class="k">join</span> <span class="n">account</span> <span class="n">A</span>
<span class="k">on</span> <span class="n">B</span><span class="p">.</span><span class="n">BRANCH_ID</span> <span class="o">=</span> <span class="n">A</span><span class="p">.</span><span class="n">OPEN_BRANCH_ID</span>
<span class="k">where</span> <span class="n">BRANCH_ID</span> <span class="o">=</span> <span class="s1">&#39;2&#39;</span>
</pre></div>
</div>
<ul class="simple">
<li>Lưu ý: Khi câu lệnh bị lỗi Ambiguity, nguyên nhân có thể là do key
nối các bảng lại bị trùng với cột khi truy vấn</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">---Trường hợp 1: Không hoạt động</span>
<span class="k">select</span> <span class="n">EnglishProductName</span><span class="p">,</span> <span class="n">EnglishProductSubcategoryName</span><span class="p">,</span>
<span class="n">ProductSubcategoryKey</span> <span class="k">from</span> <span class="n">DimProduct</span> <span class="k">as</span> <span class="n">P</span> <span class="k">inner</span> <span class="k">join</span>
<span class="n">DimProductSubcategory</span> <span class="k">as</span> <span class="n">S</span>
<span class="k">on</span> <span class="n">P</span><span class="p">.</span><span class="n">ProductSubcategoryKey</span> <span class="o">=</span> <span class="n">S</span><span class="p">.</span><span class="n">ProductSubcategoryKey</span>

<span class="c1">---Trường hợp 2: Hoạt động, sau khi đưa alias</span>
<span class="k">select</span> <span class="n">EnglishProductName</span><span class="p">,</span> <span class="n">EnglishProductSubcategoryName</span><span class="p">,</span>
<span class="n">S</span><span class="p">.</span><span class="n">ProductSubcategoryKey</span> <span class="k">from</span> <span class="n">DimProduct</span> <span class="k">as</span> <span class="n">P</span> <span class="k">inner</span> <span class="k">join</span>
<span class="n">DimProductSubcategory</span> <span class="k">as</span> <span class="n">S</span>
<span class="k">on</span> <span class="n">P</span><span class="p">.</span><span class="n">ProductSubcategoryKey</span> <span class="o">=</span> <span class="n">S</span><span class="p">.</span><span class="n">ProductSubcategoryKey</span>
</pre></div>
</div>
<ul class="simple">
<li><strong>Trường hợp 3: Inner join</strong></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span> <span class="n">EnglishProductName</span><span class="p">,</span>
  <span class="n">EnglishProductSubcategoryName</span>
  <span class="p">,</span><span class="n">EnglishProductCategoryName</span>
<span class="k">from</span> <span class="n">DimProduct</span> <span class="k">as</span> <span class="n">P</span> <span class="k">inner</span> <span class="k">join</span>
  <span class="n">DimProductSubcategory</span> <span class="k">as</span> <span class="n">S</span>
  <span class="k">on</span> <span class="n">P</span><span class="p">.</span><span class="n">ProductSubcategoryKey</span> <span class="o">=</span> <span class="n">S</span><span class="p">.</span><span class="n">ProductSubcategoryKey</span>
<span class="k">inner</span> <span class="k">join</span> <span class="n">DimProductCategory</span> <span class="k">as</span> <span class="k">C</span>
  <span class="k">on</span> <span class="n">S</span><span class="p">.</span><span class="n">ProductCategoryKey</span> <span class="o">=</span> <span class="k">C</span><span class="p">.</span><span class="n">ProductCategoryKey</span>
<span class="k">where</span> <span class="n">EnglishProductName</span> <span class="k">like</span> <span class="s1">&#39;%HL%&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="lam-viec-voi-string">
<h2>2.12. Làm việc với string<a class="headerlink" href="#lam-viec-voi-string" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>CONCAT: Nối các string, tương tự như <strong>paste0</strong> trong R</li>
<li>LOWER, UPPER: Viết hoa, viết thường các biến</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">top</span> <span class="mi">10</span>
      <span class="p">[</span><span class="n">ID</span><span class="p">]</span>
 <span class="p">,[</span><span class="n">BUSINESS_DATE</span><span class="p">]</span>
 <span class="p">,</span><span class="k">LOWER</span><span class="p">([</span><span class="n">CUSTOMER_NAME</span><span class="p">])</span>
   <span class="p">,</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">CUSTOMER_NAME</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">ID</span><span class="p">)</span> <span class="k">as</span> <span class="n">new_var</span>
<span class="k">FROM</span> <span class="p">[</span><span class="n">SERVER74</span><span class="p">].[</span><span class="n">BICDATA</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">BALANCE_HIS</span><span class="p">]</span>
<span class="k">where</span> <span class="n">customer_name</span> <span class="k">is</span> <span class="k">not</span> <span class="k">null</span>
</pre></div>
</div>
<ul class="simple">
<li>REPLACE: Thay thế các ký tự trong biến</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">top</span> <span class="mi">10</span>
     <span class="p">[</span><span class="n">ID</span><span class="p">]</span>
  <span class="p">,[</span><span class="n">CUSTOMER_NAME</span><span class="p">]</span>
    <span class="p">,</span><span class="k">REPLACE</span><span class="p">(</span><span class="n">CUSTOMER_NAME</span><span class="p">,</span> <span class="s1">&#39;THI&#39;</span><span class="p">,</span> <span class="s1">&#39;***&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">new_name</span>
<span class="k">FROM</span> <span class="p">[</span><span class="n">SERVER74</span><span class="p">].[</span><span class="n">BICDATA</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">BALANCE_HIS</span><span class="p">]</span>
<span class="k">where</span> <span class="n">customer_name</span> <span class="k">is</span> <span class="k">not</span> <span class="k">null</span>
</pre></div>
</div>
<ul class="simple">
<li>SUBSTRING(var, a, b): Hiển thị b ký tự từ ký tự thứ a của var</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span> <span class="k">SELECT</span> <span class="n">top</span> <span class="mi">10</span>
    <span class="n">CUSTOMER_NAME</span>
    <span class="p">,</span><span class="k">substring</span><span class="p">(</span><span class="n">CUSTOMER_NAME</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="k">FROM</span> <span class="p">[</span><span class="n">SERVER74</span><span class="p">].[</span><span class="n">BICDATA</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">BALANCE_HIS</span><span class="p">]</span>
  <span class="k">where</span> <span class="n">customer_name</span> <span class="k">is</span> <span class="k">not</span> <span class="k">null</span>
</pre></div>
</div>
</div>
<div class="section" id="lam-viec-voi-date">
<h2>2.13. Làm việc với date<a class="headerlink" href="#lam-viec-voi-date" title="Permalink to this headline">¶</a></h2>
<p>Dữ liệu date là dữ liệu rất quan trọng cần nắm vững khi làm việc với dữ
liệu. Dữ liệu thời gian có các định dạng thường dùng:</p>
<ul class="simple">
<li>101 (mm/dd/yyyy)</li>
<li>102 (mm/dd/yy)</li>
<li>103 (dd/mm/yyyy)</li>
<li>112 (yyyymmdd): Đây là định dạng hay dùng nhất</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Lấy ngày hiện tại</span>

<span class="k">select</span> <span class="k">convert</span><span class="p">(</span><span class="nb">varchar</span><span class="p">,</span><span class="n">birthdate</span><span class="p">,</span><span class="mi">101</span><span class="p">)</span> <span class="k">as</span> <span class="n">Date1</span><span class="p">,</span>
       <span class="k">convert</span><span class="p">(</span><span class="nb">varchar</span><span class="p">,</span> <span class="n">BirthDate</span><span class="p">,</span> <span class="mi">102</span><span class="p">)</span> <span class="k">as</span> <span class="n">Date2</span><span class="p">,</span>
       <span class="k">convert</span><span class="p">(</span><span class="nb">varchar</span><span class="p">,</span> <span class="n">birthdate</span><span class="p">,</span> <span class="mi">103</span><span class="p">)</span> <span class="k">as</span> <span class="n">Date3</span>


<span class="k">select</span> <span class="k">convert</span><span class="p">(</span><span class="nb">varchar</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="n">getdate</span><span class="p">(),</span><span class="mi">101</span><span class="p">)</span> <span class="k">as</span> <span class="n">Date1</span><span class="p">,</span>
       <span class="k">convert</span><span class="p">(</span><span class="nb">varchar</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="n">getdate</span><span class="p">(),</span> <span class="mi">102</span><span class="p">)</span> <span class="k">as</span> <span class="n">Date2</span><span class="p">,</span>
       <span class="k">convert</span><span class="p">(</span><span class="nb">varchar</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="n">getdate</span><span class="p">(),</span> <span class="mi">103</span><span class="p">)</span> <span class="k">as</span> <span class="n">Date3</span><span class="p">,</span>
       <span class="k">convert</span><span class="p">(</span><span class="nb">varchar</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="n">getdate</span><span class="p">(),</span> <span class="mi">112</span><span class="p">)</span> <span class="k">as</span> <span class="n">Date4</span>
</pre></div>
</div>
<div class="section" id="datediff">
<h3>2.13.1. Datediff<a class="headerlink" href="#datediff" title="Permalink to this headline">¶</a></h3>
<p>Dùng để tính toán khoảng thời gian giữa hai điểm</p>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">DATEDIFF</span><span class="p">(</span><span class="n">interval</span><span class="p">,</span> <span class="n">date1</span><span class="p">,</span> <span class="n">date2</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">interval</span></code> có các giá trị sau:</p>
<ul class="simple">
<li>year, yyyy, yy = Year</li>
<li>quarter, qq, q = Quarter</li>
<li>month, mm, m = month</li>
<li>dayofyear = Day of the year</li>
<li>day, dy, y = Day</li>
<li>week, ww, wk = Week</li>
<li>weekday, dw, w = Weekday</li>
<li>hour, hh = hour</li>
<li>minute, mi, n = Minute</li>
<li>second, ss, s = Second</li>
<li>millisecond, ms = Millisecond</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span> <span class="n">datediff</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">getdate</span><span class="p">(),</span> <span class="s1">&#39;20200101&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="k">day</span><span class="p">,</span>
        <span class="n">datediff</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">getdate</span><span class="p">(),</span> <span class="s1">&#39;20160101&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="k">month</span><span class="p">,</span>
        <span class="n">datediff</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span> <span class="n">getdate</span><span class="p">(),</span> <span class="s1">&#39;20160101&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="k">year</span>
</pre></div>
</div>
</div>
<div class="section" id="dateadd">
<h3>2.13.2. Dateadd<a class="headerlink" href="#dateadd" title="Permalink to this headline">¶</a></h3>
<p>Dùng để cộng ngày</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">DATEADD</span><span class="p">(</span><span class="nb">interval</span><span class="p">,</span> <span class="n">number_to_add</span><span class="p">,</span> <span class="n">start_date</span><span class="p">)</span>

<span class="k">select</span> <span class="n">dateadd</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">getdate</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="section" id="tricks-voi-du-lieu-thoi-gian">
<h3>2.13.3. Tricks với dữ liệu thời gian<a class="headerlink" href="#tricks-voi-du-lieu-thoi-gian" title="Permalink to this headline">¶</a></h3>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Ngày đầu trong thaáng</span>
<span class="k">select</span> <span class="k">convert</span><span class="p">(</span><span class="nb">varchar</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="n">dateadd</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">datediff</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">getdate</span><span class="p">()),</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">112</span><span class="p">)</span>

<span class="c1">-- Ngày đầu tháng này</span>
<span class="k">select</span> <span class="k">convert</span><span class="p">(</span><span class="nb">varchar</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span>
<span class="n">dateadd</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">datediff</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">getdate</span><span class="p">()),</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">112</span><span class="p">)</span>

<span class="c1">-- Ngày đầu tháng trước</span>
<span class="k">select</span> <span class="k">convert</span><span class="p">(</span><span class="nb">varchar</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span>
<span class="n">dateadd</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">datediff</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">getdate</span><span class="p">())</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">112</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="cac-nhom-cau-lenh-thay-doi-du-lieu-trong-csdl">
<h1>3. Các nhóm câu lệnh thay đổi dữ liệu trong CSDL<a class="headerlink" href="#cac-nhom-cau-lenh-thay-doi-du-lieu-trong-csdl" title="Permalink to this headline">¶</a></h1>
<div class="section" id="tao-bang-moi">
<h2>3.1. Tạo bảng mới<a class="headerlink" href="#tao-bang-moi" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><strong>Create table</strong>: Tạo bảng mới</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">Create</span> <span class="k">table</span> <span class="p">[</span><span class="k">TABLE_NAME</span><span class="p">](</span>
<span class="n">VAR_1</span> <span class="k">TYPE</span> <span class="n">CONDITION</span><span class="p">,</span>
<span class="n">VAR_2</span> <span class="k">TYPE</span> <span class="n">CONDITION</span><span class="p">,</span>
<span class="p">...</span>
<span class="n">VAR_N</span> <span class="k">TYPE</span> <span class="n">CONDITION</span><span class="p">,</span>
<span class="p">)</span>
<span class="c1">--Ví dụ</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">BILLS</span> <span class="p">(</span>
<span class="n">NAME</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
<span class="n">AMOUNT</span> <span class="nb">int</span><span class="p">,</span>
<span class="n">ACCOUNT_ID</span> <span class="nb">int</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="xoa-bang-drop-table">
<h2>3.2. Xóa bảng Drop Table<a class="headerlink" href="#xoa-bang-drop-table" title="Permalink to this headline">¶</a></h2>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">drop</span> <span class="k">table</span> <span class="k">TABLE_NAME</span>
</pre></div>
</div>
<ul class="simple">
<li>Kiểm tra điều kiện giá trị</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Tạo Bảng</span>
<span class="k">create</span> <span class="k">table</span> <span class="n">test2</span>
<span class="p">(</span><span class="n">id</span> <span class="nb">int</span> <span class="k">Not</span> <span class="k">Null</span><span class="p">,</span>
 <span class="n">gender</span> <span class="n">nvarchar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">check</span> <span class="p">(</span><span class="n">gender</span> <span class="k">in</span> <span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">)))</span>

<span class="c1">-- Kiểm tra điều kiện khi insert</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">test2</span> <span class="k">values</span>
 <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;M&#39;</span><span class="p">)</span>
 <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">)</span>

<span class="c1">-- Alter điều kiện check</span>
<span class="k">alter</span> <span class="k">table</span> <span class="n">test2</span>
<span class="k">add</span> <span class="k">check</span> <span class="p">(</span><span class="n">gender</span> <span class="k">in</span> <span class="p">(</span><span class="s1">&#39;M&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;MF&#39;</span><span class="p">,</span> <span class="s1">&#39;MF2&#39;</span><span class="p">))</span>

<span class="c1">-- Drop điều kiện check</span>
<span class="k">alter</span> <span class="k">table</span> <span class="n">test2</span>
<span class="k">drop</span> <span class="k">constraint</span> <span class="n">CK__test2__gender__078C1F06</span>
</pre></div>
</div>
</div>
<div class="section" id="insert-into">
<h2>3.3. INSERT INTO<a class="headerlink" href="#insert-into" title="Permalink to this headline">¶</a></h2>
<p><strong>Chức năng</strong>: Chèn dòng vào dữ liệu</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">insert</span> <span class="k">into</span> <span class="p">[</span><span class="k">table</span><span class="p">]</span>
<span class="p">(</span><span class="n">Column_1</span><span class="p">,</span> <span class="n">Column_2</span><span class="p">,...,</span> <span class="n">Column_n</span><span class="p">)</span>
<span class="k">values</span><span class="p">(</span><span class="n">Value_1</span><span class="p">,...,</span> <span class="n">Value_n</span><span class="p">)</span>

<span class="c1">-- Ví dụ</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">BILLS</span>
<span class="p">(</span><span class="n">NAME</span><span class="p">,</span> <span class="n">AMOUNT</span><span class="p">,</span> <span class="n">ACCOUNT_ID</span><span class="p">,</span> <span class="k">comment</span><span class="p">)</span>
<span class="k">values</span> <span class="p">(</span><span class="s1">&#39;ANH&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;OLA&#39;</span><span class="p">)</span>

<span class="c1">--Thêm tất cả các giá trị 1 bảng vào 1 bảng khác</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">new_2</span> <span class="p">(</span><span class="n">name</span> <span class="k">of</span> <span class="k">all</span> <span class="n">columns</span><span class="p">)</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">bills</span>

<span class="c1">--Thêm một số giá trị của 1 bảng vào một bảng khác</span>
<span class="k">insert</span> <span class="k">into</span> <span class="n">new_2</span> <span class="p">(</span><span class="n">NAME</span><span class="p">,</span> <span class="k">comment</span><span class="p">)</span>
<span class="k">select</span> <span class="k">comment</span><span class="p">,</span> <span class="k">comment</span> <span class="k">from</span> <span class="n">bills</span>
</pre></div>
</div>
<p><strong>Lưu ý</strong>:</p>
<ul class="simple">
<li>Khi insert into, để copy nhanh tên các bảng, ta có thể copy ra
notepad</li>
<li>Khi viết tiếng Việt hoặc chèn ký tự tiếng Việt của Database cần có N
ở phía trước. <code class="docutils literal notranslate"><span class="pre">N</span></code> cho phép SQL hiểu là <code class="docutils literal notranslate"><span class="pre">NVARCHAR</span></code>, cho phép nhóm
ký tự UTF8</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">r2test</span> <span class="p">(</span> <span class="p">[</span><span class="n">mychar</span><span class="p">]</span> <span class="p">[</span><span class="n">NVARCHAR</span><span class="p">](</span><span class="mi">16</span><span class="p">),</span> <span class="p">[</span><span class="n">mynum</span><span class="p">]</span> <span class="p">[</span><span class="nb">FLOAT</span><span class="p">])</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">r2test</span> <span class="p">(</span><span class="n">mychar</span><span class="p">,</span><span class="n">mynum</span><span class="p">)</span> <span class="k">VALUES</span>
  <span class="p">(</span><span class="n">N</span><span class="s1">&#39;Đức Việt&#39;</span><span class="p">,</span><span class="mi">3</span><span class="p">.</span><span class="mi">141593</span><span class="p">)</span> <span class="c1">--Không lỗi</span>
  <span class="p">,(</span><span class="s1">&#39;Đức Việt&#39;</span><span class="p">,</span><span class="mi">6</span><span class="p">.</span><span class="mi">283185</span><span class="p">)</span> <span class="c1">--Lỗi font</span>

  <span class="n">Hải</span> <span class="n">Hoàng</span>
</pre></div>
</div>
</div>
<div class="section" id="update">
<h2>3.4. Update<a class="headerlink" href="#update" title="Permalink to this headline">¶</a></h2>
<p><strong>Chức năng</strong>: Thay đổi giá trị trong bảng</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">update</span> <span class="k">TABLE</span>
<span class="k">set</span> <span class="n">CONDITION_1</span>
<span class="k">where</span> <span class="n">CONDTION_2</span>

<span class="c1">--Ví dụ</span>
  <span class="k">update</span> <span class="p">[</span><span class="n">learnsql</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">ACC_TRANSACTION</span><span class="p">]</span>
  <span class="k">set</span> <span class="n">amount</span> <span class="o">=</span> <span class="mi">9999</span> <span class="k">where</span> <span class="n">TXN_ID</span> <span class="o">=</span> <span class="mi">4</span>
</pre></div>
</div>
</div>
<div class="section" id="delete-from">
<h2>3.5. Delete from<a class="headerlink" href="#delete-from" title="Permalink to this headline">¶</a></h2>
<p><strong>Chức năng</strong>: Xóa giá trị</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">DELETE</span> <span class="k">from</span> <span class="k">TABLE</span>
<span class="k">where</span> <span class="n">CONDITION</span>

<span class="c1">--Ví dụ</span>
  <span class="k">delete</span> <span class="k">from</span> <span class="p">[</span><span class="n">learnsql</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">ACC_TRANSACTION</span><span class="p">]</span>
  <span class="k">where</span>  <span class="n">amount</span> <span class="o">=</span> <span class="mi">9999</span>
</pre></div>
</div>
</div>
<div class="section" id="alter-table">
<h2>3.6. Alter table<a class="headerlink" href="#alter-table" title="Permalink to this headline">¶</a></h2>
<p><strong>Chức năng</strong>: Thêm xóa thêm cột mới</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">alter</span> <span class="k">table</span> <span class="n">BILLS</span>
<span class="k">add</span><span class="o">/</span><span class="k">drop</span> <span class="n">NEW_VAR</span> <span class="k">TYPE</span>

<span class="c1">-- Thêm cột</span>
<span class="k">alter</span> <span class="k">table</span> <span class="n">BILLS</span>
<span class="k">add</span> <span class="k">comment</span> <span class="nb">char</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>

<span class="c1">-- Xóa cột</span>
<span class="k">alter</span> <span class="k">table</span> <span class="n">BILLS</span>
<span class="k">drop</span> <span class="k">column</span> <span class="k">COLUMN_NAME</span>

<span class="c1">-- ALTER nhiều điều kiện</span>
<span class="k">UPDATE</span> <span class="n">TABLE1</span>
<span class="k">set</span> <span class="n">column_in_TABLE1</span> <span class="o">=</span> <span class="n">B</span><span class="p">.</span><span class="k">column</span>
<span class="k">from</span> <span class="n">table1</span> <span class="n">A</span>
  <span class="k">inner</span> <span class="k">join</span> <span class="n">table2</span> <span class="n">B</span>
  <span class="k">on</span> <span class="n">A</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">B</span><span class="p">.</span><span class="n">id</span>

<span class="c1">-- Ví dụ</span>

<span class="k">UPDATE</span> <span class="n">AVG_CASA_BAL_BY_CIF_2018_201902</span>
<span class="k">set</span> <span class="n">BI_CHANNEL</span> <span class="o">=</span> <span class="n">B</span><span class="p">.</span><span class="n">BI_CHANNEL</span>
    <span class="k">from</span> <span class="n">AVG_CASA_BAL_BY_CIF_2018_201902</span> <span class="n">A</span> <span class="k">INNER</span> <span class="k">JOIN</span> <span class="o">##</span><span class="n">B</span> <span class="n">B</span>
    <span class="k">ON</span> <span class="n">A</span><span class="p">.</span><span class="n">CIF</span> <span class="o">=</span> <span class="n">B</span><span class="p">.</span><span class="n">RECID</span>
</pre></div>
</div>
</div>
<div class="section" id="doi-ten-bang-ten-cot">
<h2>3.7. Đổi tên bảng, tên cột<a class="headerlink" href="#doi-ten-bang-ten-cot" title="Permalink to this headline">¶</a></h2>
<p>SQL không hỗ trợ trực tiếp rename bằng các hàm thông thường, phải dùng
sp_rename</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Rename tên bảng</span>
<span class="n">sp_rename</span> <span class="s1">&#39;old_table&#39;</span><span class="p">,</span> <span class="s1">&#39;new_table&#39;</span>

<span class="c1">-- Rename tên cột trong bảng</span>
<span class="n">sp_rename</span> <span class="s1">&#39;table.old_column&#39;</span><span class="p">,</span> <span class="s1">&#39;new_column&#39;</span><span class="p">,</span> <span class="s1">&#39;column&#39;</span>
<span class="n">sp_rename</span> <span class="s1">&#39;my_table.var1&#39;</span><span class="p">,</span> <span class="s1">&#39;variable1&#39;</span><span class="p">,</span> <span class="s1">&#39;column&#39;</span>

<span class="c1">-- Rename tên cột trong bảng tạm</span>
<span class="n">tempdb</span><span class="p">.</span><span class="n">sys</span><span class="p">.</span><span class="n">sp_rename</span> <span class="s1">&#39;##a.var2&#39;</span><span class="p">,</span> <span class="s1">&#39;variable2&#39;</span><span class="p">,</span> <span class="s1">&#39;column&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="truncate">
<h2>3.8. Truncate<a class="headerlink" href="#truncate" title="Permalink to this headline">¶</a></h2>
<p><strong>Chức năng</strong>: Xóa toàn bộ dữ liệu trong bảng, dữ nguyên bảng</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">TRUNCATE</span> <span class="k">table</span> <span class="o">##</span><span class="n">A</span>
</pre></div>
</div>
</div>
<div class="section" id="alter-thay-doi-dinh-dang-du-lieu-cua-cot">
<h2>3.9. ALTER - Thay đổi định dạng dữ liệu của cột<a class="headerlink" href="#alter-thay-doi-dinh-dang-du-lieu-cua-cot" title="Permalink to this headline">¶</a></h2>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">CARD_LIVE_NEW</span>
<span class="k">ALTER</span> <span class="k">COLUMN</span> <span class="n">BUSINESS_DATE</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="sub-query">
<h1>4. Sub Query<a class="headerlink" href="#sub-query" title="Permalink to this headline">¶</a></h1>
<div class="section" id="sub-query-co-ban">
<h2>4.1. Sub Query cơ bản<a class="headerlink" href="#sub-query-co-ban" title="Permalink to this headline">¶</a></h2>
<p>Sub query thường được sử dụng sau điều kiện WHERE khi lọc điều kiện giữa
nhiều bảng. Phần sub-queries được gọi là inner query. Xem lưu đồ dưới
đây:</p>
<p><img alt="image0" src="Images/Plot1.gif" /></p>
<ul class="simple">
<li><strong>Trưởng hợp 1</strong>: Subquery sau WHERE</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">--Biến thể 1</span>
  <span class="k">select</span> <span class="n">a</span><span class="p">.</span><span class="n">TXN_ID</span><span class="p">,</span> <span class="n">a</span><span class="p">.</span><span class="n">AMOUNT</span> <span class="p">,</span> <span class="n">b</span><span class="p">.</span><span class="n">AVAIL_BALANCE</span>
  <span class="k">from</span> <span class="p">[</span><span class="n">learnsql</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">ACC_TRANSACTION</span><span class="p">]</span> <span class="n">a</span><span class="p">,</span>
        <span class="p">[</span><span class="n">learnsql</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">ACCOUNT</span><span class="p">]</span> <span class="n">b</span>
  <span class="k">where</span> <span class="n">a</span><span class="p">.</span><span class="n">TXN_ID</span> <span class="o">&gt;=</span>
  <span class="p">(</span><span class="k">select</span> <span class="p">(</span><span class="k">max</span><span class="p">(</span><span class="n">ACCOUNT_ID</span><span class="p">)</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="mi">5</span> <span class="k">from</span> <span class="p">[</span><span class="n">learnsql</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">ACCOUNT</span><span class="p">])</span>

<span class="c1">--Biến thể 2</span>
  <span class="k">select</span> <span class="n">a</span><span class="p">.</span><span class="n">TXN_ID</span><span class="p">,</span> <span class="n">a</span><span class="p">.</span><span class="n">AMOUNT</span> <span class="p">,</span> <span class="n">b</span><span class="p">.</span><span class="n">AVAIL_BALANCE</span>
  <span class="k">from</span> <span class="p">[</span><span class="n">learnsql</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">ACC_TRANSACTION</span><span class="p">]</span> <span class="n">a</span><span class="p">,</span>
        <span class="p">[</span><span class="n">learnsql</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">ACCOUNT</span><span class="p">]</span> <span class="n">b</span>
  <span class="k">where</span> <span class="n">a</span><span class="p">.</span><span class="n">TXN_ID</span> <span class="k">in</span>
 <span class="p">(</span><span class="k">select</span> <span class="n">ACCOUNT_ID</span> <span class="k">from</span> <span class="p">[</span><span class="n">learnsql</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">ACCOUNT</span><span class="p">])</span>
</pre></div>
</div>
<ul class="simple">
<li><strong>Trường hợp 2</strong>: Subquery sau from</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span> <span class="k">min</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">amount</span><span class="p">)</span> <span class="k">as</span> <span class="k">min</span>
    <span class="p">,</span> <span class="k">max</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">amount</span><span class="p">)</span> <span class="k">as</span> <span class="k">max</span>
<span class="k">from</span> <span class="p">(</span><span class="k">select</span> <span class="n">top</span> <span class="mi">10</span> <span class="o">*</span> <span class="k">from</span> <span class="n">acc_transaction</span><span class="p">)</span> <span class="n">a</span>
</pre></div>
</div>
<ul class="simple">
<li><strong>Trường hợp 3</strong>: Subquery trong select</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">Select</span> <span class="n">Cus</span><span class="p">.</span><span class="n">Cust_Id</span>
     <span class="p">,</span><span class="n">Cus</span><span class="p">.</span><span class="n">Address</span>
     <span class="p">,</span><span class="n">Cus</span><span class="p">.</span><span class="n">Fed_Id</span>
     <span class="p">,(</span><span class="k">Select</span> <span class="k">Sum</span><span class="p">(</span><span class="n">Acc</span><span class="p">.</span><span class="n">Avail_Balance</span><span class="p">)</span>
       <span class="k">From</span>   <span class="n">Account</span> <span class="n">Acc</span>
       <span class="k">Where</span>  <span class="n">Acc</span><span class="p">.</span><span class="n">Cust_Id</span> <span class="o">=</span> <span class="n">Cus</span><span class="p">.</span><span class="n">Cust_Id</span><span class="p">)</span> <span class="k">As</span> <span class="n">Sum_Avail_Balance</span>
<span class="k">From</span> <span class="n">Customer</span> <span class="n">Cus</span><span class="p">;</span>
</pre></div>
</div>
<p><strong>Lưu ý</strong>: Trong inner query/sub query, có 2 lưu ý sau:</p>
<ul class="simple">
<li>Phải liệt kê tất cả các bảng nếu các câu truy vấn có chứa biến từ
bảng đó.</li>
<li>Các vị trí thường có trong subquery<ul>
<li>Subquery sau FROM: Kết quả của subquery cần được đặt tên</li>
<li>Subquery sau WHERE: Kết quả có thể không cần đặt tên</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="su-dung-with-thay-the-subquery">
<h2>4.2. Sử dụng WITH thay thế subquery<a class="headerlink" href="#su-dung-with-thay-the-subquery" title="Permalink to this headline">¶</a></h2>
<p>Ta có thể dùng with để thay thế cho việc tạo bảng tạm sub query</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Khi dùng subquery</span>
<span class="k">select</span> <span class="o">#</span><span class="n">t2</span><span class="p">.</span><span class="o">*</span><span class="p">,</span>
    <span class="k">case</span> <span class="k">when</span> <span class="n">t3</span><span class="p">.[</span><span class="k">group</span><span class="p">]</span> <span class="k">is</span> <span class="k">not</span> <span class="k">null</span> <span class="k">then</span> <span class="s1">&#39;Multi Booking&#39;</span> <span class="k">else</span> <span class="s1">&#39;Single Booking&#39;</span> <span class="k">end</span> <span class="k">as</span> <span class="n">booking_type</span>
<span class="k">from</span> <span class="o">#</span><span class="n">t2</span>
    <span class="k">left</span> <span class="k">join</span> <span class="p">(</span><span class="k">select</span> <span class="n">cusid</span><span class="p">,</span> <span class="p">[</span><span class="k">group</span><span class="p">]</span>
                <span class="k">from</span> <span class="o">#</span><span class="n">t2</span> <span class="n">A</span>
                <span class="k">group</span> <span class="k">by</span> <span class="n">cusid</span><span class="p">,</span> <span class="p">[</span><span class="k">group</span><span class="p">]</span>
                <span class="k">having</span> <span class="k">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="n">t3</span>
        <span class="k">on</span> <span class="o">#</span><span class="n">t2</span><span class="p">.</span><span class="n">cusid</span> <span class="o">=</span> <span class="n">T3</span><span class="p">.</span><span class="n">cusid</span> <span class="k">and</span> <span class="o">#</span><span class="n">t2</span><span class="p">.[</span><span class="k">group</span><span class="p">]</span> <span class="o">=</span> <span class="n">t3</span><span class="p">.[</span><span class="k">group</span><span class="p">]</span>

<span class="c1">-- Khi dùng with</span>
<span class="k">with</span> <span class="n">T3</span> <span class="k">AS</span>
    <span class="p">(</span><span class="k">selecT</span> <span class="n">CUSID</span><span class="p">,</span> <span class="p">[</span><span class="k">group</span><span class="p">]</span>
    <span class="k">from</span> <span class="o">#</span><span class="n">t2</span> <span class="n">A</span>
    <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">Cusid</span><span class="p">,</span> <span class="p">[</span><span class="k">group</span><span class="p">]</span>
    <span class="k">HAVING</span> <span class="k">COUNT</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
    <span class="p">)</span>
<span class="k">SELECT</span> <span class="o">#</span><span class="n">t2</span><span class="p">.</span><span class="o">*</span> <span class="p">,</span>
    <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">T3</span><span class="p">.[</span><span class="k">group</span><span class="p">]</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">THEN</span> <span class="s1">&#39;Multi booking&#39;</span> <span class="k">ELSE</span> <span class="s1">&#39;Single Booking&#39;</span> <span class="k">END</span> <span class="k">AS</span> <span class="n">BOOKING_TYPE</span>
<span class="c1">--INTO #final_results</span>
<span class="k">FROM</span> <span class="o">#</span><span class="n">t2</span>
    <span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">T3</span>
        <span class="k">ON</span> <span class="o">#</span><span class="n">t2</span><span class="p">.</span><span class="n">CUSID</span> <span class="o">=</span> <span class="n">T3</span><span class="p">.</span><span class="n">CUSID</span> <span class="k">AND</span> <span class="o">#</span><span class="n">t2</span><span class="p">.[</span><span class="k">group</span><span class="p">]</span> <span class="o">=</span> <span class="n">T3</span><span class="p">.[</span><span class="k">group</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="cac-nhom-cau-lenh-co-ban-khac">
<h1>5. Các nhóm câu lệnh cơ bản khác<a class="headerlink" href="#cac-nhom-cau-lenh-co-ban-khac" title="Permalink to this headline">¶</a></h1>
<div class="section" id="exists">
<h2>5.1. Exists<a class="headerlink" href="#exists" title="Permalink to this headline">¶</a></h2>
<p><strong>Chức năng</strong>: Kiểm tra điều kiện tồn tại</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">---Exist</span>
<span class="k">select</span> <span class="n">FirstName</span><span class="p">,</span>
           <span class="n">LastName</span>
<span class="k">from</span> <span class="n">DimEmployee</span>
<span class="k">where</span> <span class="k">exists</span> <span class="p">(</span><span class="k">select</span> <span class="n">LastName</span> <span class="k">from</span> <span class="n">DimCustomer</span> <span class="k">where</span> <span class="n">LastName</span> <span class="o">=</span>
<span class="s1">&#39;Zimmerman&#39;</span><span class="p">)</span>

<span class="c1">---Not exist</span>
<span class="k">select</span> <span class="n">FirstName</span><span class="p">,</span>
        <span class="n">LastName</span>
<span class="k">from</span> <span class="n">DimEmployee</span>
<span class="k">where</span> <span class="k">not</span> <span class="k">exists</span> <span class="p">(</span><span class="k">select</span> <span class="n">LastName</span> <span class="k">from</span> <span class="n">DimCustomer</span> <span class="k">where</span> <span class="n">LastName</span> <span class="o">=</span>
<span class="s1">&#39;Anh&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="any-vs-all">
<h2>5.2. Any vs.&nbsp;All<a class="headerlink" href="#any-vs-all" title="Permalink to this headline">¶</a></h2>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">---TH1: ANY</span>
<span class="k">select</span> <span class="n">EnglishProductName</span><span class="p">,</span> <span class="n">ListPrice</span> <span class="k">from</span> <span class="n">DimProduct</span>
<span class="k">where</span> <span class="n">ListPrice</span> <span class="o">&gt;</span> <span class="k">all</span><span class="p">(</span><span class="k">select</span> <span class="k">any</span><span class="p">(</span><span class="n">ListPrice</span><span class="p">)</span> <span class="k">from</span> <span class="n">DimProduct</span>
<span class="k">group</span> <span class="k">by</span> <span class="n">ProductSubcategoryKey</span><span class="p">)</span>
<span class="k">order</span> <span class="k">by</span> <span class="n">ListPrice</span> <span class="k">asc</span>

<span class="c1">--TH2: ALL without having</span>
<span class="k">select</span> <span class="n">EnglishProductName</span><span class="p">,</span> <span class="n">ListPrice</span> <span class="k">from</span> <span class="n">DimProduct</span>
<span class="k">where</span> <span class="n">ListPrice</span> <span class="o">&gt;</span> <span class="k">all</span><span class="p">(</span><span class="k">select</span> <span class="k">avg</span><span class="p">(</span><span class="n">ListPrice</span><span class="p">)</span> <span class="k">from</span> <span class="n">DimProduct</span>
<span class="k">group</span> <span class="k">by</span> <span class="n">ProductSubcategoryKey</span><span class="p">)</span>
<span class="k">order</span> <span class="k">by</span> <span class="n">ListPrice</span> <span class="k">asc</span>

<span class="c1">--TH3: ALL with having</span>
<span class="k">select</span> <span class="n">EnglishProductName</span><span class="p">,</span> <span class="n">ListPrice</span> <span class="k">from</span> <span class="n">DimProduct</span>
<span class="k">where</span> <span class="n">ListPrice</span> <span class="o">&gt;</span> <span class="k">all</span><span class="p">(</span><span class="k">select</span> <span class="k">avg</span><span class="p">(</span><span class="n">ListPrice</span><span class="p">)</span> <span class="k">from</span> <span class="n">DimProduct</span>
<span class="k">group</span> <span class="k">by</span> <span class="n">ProductSubcategoryKey</span>
<span class="k">having</span> <span class="k">avg</span><span class="p">(</span><span class="n">ListPrice</span><span class="p">)</span> <span class="k">is</span> <span class="k">not</span> <span class="k">null</span><span class="p">)</span>
<span class="k">order</span> <span class="k">by</span> <span class="n">ListPrice</span> <span class="k">asc</span>
</pre></div>
</div>
<p><strong>Lưu ý</strong>:</p>
<ul class="simple">
<li>Với TH1, truy vấn sẽ tìm tất cả các giá trị lớn hơn min của
avg(ListPrice)</li>
<li>Với TH2, vì có 1 dòng trong inner query bị NULL, do đó toàn bộ câu
lệnh sẽ không ra kết quả do KHÔNG CHẮC CHẮN điều kiện lọc lớn hơn TẤT
CẢ các giá trị trong inner query</li>
<li>Với TH3, sử dụng having giúp loại đi điều kiện NULL</li>
</ul>
</div>
<div class="section" id="view">
<h2>5.3. View<a class="headerlink" href="#view" title="Permalink to this headline">¶</a></h2>
<p>View là hình thức tạo một bảng cho phép hiển thị, không tốn bộ nhớ thật
của máy tính</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">Create</span> <span class="k">View</span> <span class="p">(</span><span class="n">COL_1</span><span class="p">,</span> <span class="n">COL_2</span><span class="p">...)</span> <span class="k">as</span>
<span class="k">select</span> <span class="n">COL_1</span><span class="p">,</span><span class="n">COL_2</span><span class="p">...</span> <span class="k">from</span> <span class="k">TABLE</span>

<span class="c1">--Ví dụ</span>
<span class="k">create</span> <span class="k">view</span> <span class="n">ducanh4</span> <span class="p">(</span><span class="n">CUS_ID</span><span class="p">,</span> <span class="n">MAIL</span><span class="p">)</span> <span class="k">as</span>
<span class="k">select</span> <span class="n">CUST_ID</span><span class="p">,</span> <span class="n">ADDRESS</span> <span class="o">+</span> <span class="s1">&#39; ,&#39;</span> <span class="o">+</span> <span class="n">CITY</span> <span class="k">from</span> <span class="n">customer</span>

<span class="c1">--Lưu ý: Khi update trong View, ta sẽ update luôn thông tin từ bảng gốc</span>
<span class="k">create</span> <span class="k">view</span> <span class="n">ducanh5</span> <span class="k">as</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">account</span>
<span class="k">update</span> <span class="n">ducanh5</span>
<span class="k">set</span> <span class="n">AVAIL_BALANCE</span> <span class="o">=</span> <span class="n">AVAIL_BALANCE</span> <span class="o">*</span> <span class="mi">10</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">account</span>

<span class="c1">--DROP VIEW TABLE</span>
<span class="k">drop</span> <span class="k">view</span> <span class="n">ducanh5</span>
</pre></div>
</div>
</div>
<div class="section" id="index">
<h2>5.4. Index<a class="headerlink" href="#index" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Để tăng performance của query, ta có thể sử dụng Index. Index áp dụng
B-Tree để tìm kiếm dữ liệu. Khi được đánh index, bảng sẽ là một bảng
có cấu trúc, VD - theo thứ tự ABC. Nếu không đánh index, bảng sẽ được
gọi là HEAP (nonsequential).</li>
<li>Khi đặt điều kiện unique key hoặc primary key, bảng sẽ tự động tạo
index.</li>
<li>Khi tạo index, tốc độ truy vấn sẽ nhanh hơn tuy nhiên sẽ tốn dung
lượng của ổ cứng lưu trữ</li>
</ul>
<p><img alt="image1" src="Images/btree.png" /></p>
<p><strong>Cơ chế hoạt động</strong>:</p>
<ul class="simple">
<li>Nếu cột customer_name được sử dụng làm index, sẽ chia làm 3 nhóm A,
Q, T. Nếu tên khách hàng bắt đầu là R, sẽ nhảy luôn đến nhóm index Q
&gt;&gt; R &gt;&gt; Tìm tên</li>
<li>Nếu không có index, sẽ phải scan từng dòng trong cả bảng để tìm</li>
<li>Trong SQL có 2 loại index: Clustered Index và Non-cluster index. Với
cluster index, leaf - node cuối trong Btree, chứa toàn bộ thông tin
của dòng dữ liệu. Với Non-cluster index, leaf trong Btree chỉ chứa
index.</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Clustered index</span>
<span class="k">create</span> <span class="k">index</span> <span class="n">new_2</span> <span class="k">on</span> <span class="n">test2</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">gender</span><span class="p">)</span>

<span class="c1">--Non clustered index</span>
<span class="k">create</span> <span class="n">nonclustered</span> <span class="k">index</span> <span class="n">test_id</span>
<span class="k">on</span> <span class="n">test</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>

<span class="c1">-- Drop index</span>
<span class="k">drop</span> <span class="k">index</span> <span class="n">new_2</span> <span class="k">on</span> <span class="n">test2</span>
</pre></div>
</div>
<ul class="simple">
<li>Bảng có index sẽ hoạt động nhanh hơn bảng thường do cơ chế sau:<ul>
<li>Không có index: Scan từng dòng trong bảng và tìm điều kiện</li>
<li>Có index: Tìm theo khu vực index. VD: ID = 5<ul>
<li>Nếu không có index, sẽ tìm từng dòng và trả về kết quả với ID =
5.</li>
<li>Nếu có index, sẽ tìm với thuật toán chia đôi</li>
</ul>
</li>
</ul>
</li>
<li>Các loại index:<ul>
<li>Clustered: Sắp xếp lại cách lưu trữ dữ liệu trong DB</li>
<li>Nonclustered: Không sắp xếp</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="bang-tam">
<h2>5.5. Bảng tạm<a class="headerlink" href="#bang-tam" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Bảng tạm là bảng chỉ tồn tại trong 1 session của SQL. Sau khi log out
hoặc khởi động lại, bảng này sẽ tự động biến mấ.</li>
<li>Bảng tạm bắt đầu bằng dấu #</li>
<li>Bảng tạm với 1 dấu # gọi là bảng tạm local - sẽ tự xóa khi đóng query
editor. Bạng tạm với ## gọi là bảng tạm global - chỉ xóa khi thoát
khỏi SQL</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">--Chỉ tạo bảng</span>
<span class="k">create</span> <span class="k">table</span> <span class="o">#</span><span class="n">da</span> <span class="p">(</span><span class="n">VAr1</span> <span class="nb">int</span><span class="p">,</span> <span class="n">var2</span> <span class="nb">char</span><span class="p">(</span><span class="mi">30</span><span class="p">))</span>

<span class="c1">--Vừa tạo bảng vừa insert</span>
<span class="k">select</span> <span class="o">*</span>
<span class="k">into</span> <span class="o">#</span><span class="n">ducanh</span>
<span class="k">from</span> <span class="n">account</span>
</pre></div>
</div>
</div>
<div class="section" id="kiem-tra-kieu-du-lieu-trong-bang">
<h2>5.6. Kiểm tra kiểu dữ liệu trong bảng<a class="headerlink" href="#kiem-tra-kieu-du-lieu-trong-bang" title="Permalink to this headline">¶</a></h2>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="k">COLUMN_NAME</span><span class="p">,</span> <span class="n">DATA_TYPE</span>
<span class="k">FROM</span> <span class="n">INFORMATION_SCHEMA</span><span class="p">.</span><span class="n">COLUMNS</span>
<span class="k">WHERE</span> <span class="k">TABLE_NAME</span> <span class="o">=</span> <span class="s1">&#39;ACCOUNT&#39;</span> <span class="c1">-- Điền tên bảng</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="sql-dong-voi-exec">
<h1>6. SQL động với Exec<a class="headerlink" href="#sql-dong-voi-exec" title="Permalink to this headline">¶</a></h1>
<p>SQL động là nhóm sử dụng nâng cao của SQL, cho phép người dùng tự động
hóa các script. Sử dụng SQL động cho phép tùy biến các câu lệnh khi truy
vấn và xử lý dữ liệu. Khi sử dụng SQL động, ta cần dùng <code class="docutils literal notranslate"><span class="pre">EXEC</span></code></p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Cách 1</span>
<span class="k">declare</span> <span class="o">@</span><span class="n">id</span> <span class="nb">int</span>
<span class="k">set</span> <span class="o">@</span><span class="n">id</span> <span class="o">=</span> <span class="s1">&#39;4&#39;</span>
<span class="k">exec</span><span class="p">(</span><span class="s1">&#39;select * from ACCOUNT where ACCOUNT_ID = &#39;</span> <span class="o">+</span> <span class="o">@</span><span class="n">id</span><span class="p">)</span>

<span class="c1">-- Cách 2</span>
<span class="k">declare</span> <span class="o">@</span><span class="n">id</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="k">set</span> <span class="o">@</span><span class="n">id</span> <span class="o">=</span> <span class="s1">&#39;4&#39;</span>
<span class="k">declare</span> <span class="o">@</span><span class="k">sql</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
<span class="k">set</span> <span class="o">@</span><span class="k">sql</span> <span class="o">=</span> <span class="s1">&#39;select * from ACCOUNT where account_id = &#39;</span> <span class="o">+</span> <span class="o">@</span><span class="n">id</span>
<span class="n">print</span> <span class="o">@</span><span class="k">sql</span> <span class="c1">-- Đảm bảo câu lệnh thực hiện đúng</span>
<span class="k">exec</span><span class="p">(</span><span class="o">@</span><span class="k">sql</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Lưu ý khi sử dụng SQL động</strong></p>
<ul class="simple">
<li>Lưu ý dấu cách</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">EXEC</span><span class="p">(</span><span class="s1">&#39; SELECT col1, col2, col3 &#39;</span> <span class="o">+</span>
     <span class="s1">&#39; FROM &#39;</span> <span class="o">+</span> <span class="o">@</span><span class="n">tblname</span> <span class="o">+</span>
     <span class="s1">&#39; WHERE keycol = &#39;&#39;&#39;</span> <span class="o">+</span> <span class="o">@</span><span class="k">key</span> <span class="o">+</span> <span class="s1">&#39;&#39;&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li>Luôn dùng print để đảm bảo viết đúng câu lệnh trước khi sử dụng exec</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">declare</span> <span class="o">@</span><span class="k">month</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="k">select</span> <span class="k">max</span><span class="p">(</span><span class="nb">date</span><span class="p">)</span> <span class="k">from</span> <span class="o">##</span><span class="n">A</span><span class="p">)</span>
<span class="n">print</span><span class="p">(</span><span class="s1">&#39;select * from ##B where month = &#39;</span> <span class="o">+</span> <span class="o">@</span><span class="k">month</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="ham-va-thu-tuc">
<h1>7. Hàm và thủ tục<a class="headerlink" href="#ham-va-thu-tuc" title="Permalink to this headline">¶</a></h1>
<div class="section" id="procedure">
<h2>7.1. Procedure<a class="headerlink" href="#procedure" title="Permalink to this headline">¶</a></h2>
<div class="section" id="hien-thi-tat-ca-cac-procedure-dang-luu-trong-he-thong">
<h3>7.1.1. Hiển thị tất cả các procedure đang lưu trong hệ thống<a class="headerlink" href="#hien-thi-tat-ca-cac-procedure-dang-luu-trong-he-thong" title="Permalink to this headline">¶</a></h3>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Tất cả các procedure</span>
<span class="k">SELECT</span> <span class="n">name</span><span class="p">,</span>
       <span class="k">type</span>
<span class="k">FROM</span> <span class="n">dbo</span><span class="p">.</span><span class="n">sysobjects</span>
<span class="k">WHERE</span> <span class="p">(</span><span class="k">type</span> <span class="o">=</span> <span class="s1">&#39;P&#39;</span><span class="p">)</span>

<span class="c1">-- Các procedure do người dùng tạo</span>
  <span class="k">select</span> <span class="o">*</span>
  <span class="k">from</span> <span class="n">master</span><span class="p">.</span><span class="n">information_schema</span><span class="p">.</span><span class="n">routines</span>
  <span class="k">where</span> <span class="n">routine_type</span> <span class="o">=</span> <span class="s1">&#39;PROCEDURE&#39;</span>
        <span class="k">and</span> <span class="k">Left</span><span class="p">(</span><span class="k">Routine_Name</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">IN</span> <span class="p">(</span><span class="s1">&#39;sp_&#39;</span><span class="p">,</span> <span class="s1">&#39;xp_&#39;</span><span class="p">,</span> <span class="s1">&#39;ms_&#39;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><strong>Xóa procedure</strong></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">drop</span> <span class="k">procedure</span> <span class="n">cast_data</span>
</pre></div>
</div>
</div>
<div class="section" id="tao-procedure">
<h3>7.1.2. Tạo procedure<a class="headerlink" href="#tao-procedure" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Procedure không có biến</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Tạo procedure</span>
<span class="k">create</span> <span class="k">procedure</span> <span class="n">getID_normal</span>
<span class="k">as</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">ACCOUNT</span>
<span class="c1">-- Chạy procedure</span>
<span class="k">execute</span> <span class="n">getID_normal</span>
</pre></div>
</div>
<ul class="simple">
<li>Procedure nhiều biến</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">--Tạo procedure</span>
<span class="k">create</span> <span class="k">procedure</span> <span class="n">PROD_CD</span>
  <span class="o">@</span><span class="n">prod</span> <span class="n">nvarchar</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span> <span class="o">=</span> <span class="k">NULL</span><span class="p">,</span>
  <span class="o">@</span><span class="n">AVAIL_BALANCE</span> <span class="nb">float</span>
<span class="k">as</span>
  <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">ACCOUNT</span>
  <span class="k">where</span> <span class="n">PRODUCT_CD</span> <span class="o">=</span> <span class="o">@</span><span class="n">prod</span> <span class="k">and</span>
  <span class="n">AVAIL_BALANCE</span> <span class="o">&gt;=</span> <span class="o">@</span><span class="n">AVAIL_BALANCE</span>
<span class="k">GO</span>

<span class="c1">--Chạy procedure</span>
<span class="n">PROD_CD</span> <span class="o">@</span><span class="n">prod</span> <span class="o">=</span> <span class="s1">&#39;CHK&#39;</span><span class="p">,</span> <span class="o">@</span><span class="n">AVAIL_BALANCE</span> <span class="o">=</span> <span class="mi">10000</span>
</pre></div>
</div>
<p><strong>Lưu ý</strong>: Trong SQL có 2 loại biến:</p>
<ul class="simple">
<li>User defined variable: Bắt đầu bằng dấu <a class="reference external" href="mailto:**&#37;&#52;&#48;**">**<span>&#64;</span>**</a></li>
<li>System variable: Bắt đầu bằng dấu **&#64;&#64;** - loại này chỉ xuất hiện
sau khi đã thực hiện xong 1 số câu lệnh</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="p">[</span><span class="n">DimCustomer</span><span class="p">]</span>
<span class="k">select</span> <span class="o">@@</span><span class="n">ROWCOUNT</span>
</pre></div>
</div>
</div>
<div class="section" id="gan-ket-qua-1-procedure-vao-bien">
<h3>7.1.3. Gán kết quả 1 procedure vào biến<a class="headerlink" href="#gan-ket-qua-1-procedure-vao-bien" title="Permalink to this headline">¶</a></h3>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">drop</span> <span class="k">procedure</span> <span class="k">if</span> <span class="k">exists</span> <span class="n">return_date</span>
<span class="k">create</span> <span class="k">procedure</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">return_date</span><span class="p">]</span> <span class="p">(</span><span class="o">@</span><span class="n">no_date</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">@</span><span class="n">no_date2</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="o">@</span><span class="k">result</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="k">output</span><span class="p">)</span>
<span class="k">as</span>
<span class="k">begin</span>
<span class="k">set</span> <span class="o">@</span><span class="k">result</span> <span class="o">=</span> <span class="p">(</span><span class="k">select</span> <span class="k">convert</span><span class="p">(</span><span class="nb">varchar</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="n">getdate</span><span class="p">()</span> <span class="o">-</span> <span class="o">@</span><span class="n">no_date</span> <span class="o">+</span> <span class="o">@</span><span class="n">no_date2</span><span class="p">,</span> <span class="mi">112</span><span class="p">))</span>
<span class="k">end</span>

<span class="k">declare</span> <span class="o">@</span><span class="k">result</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<span class="k">execute</span> <span class="n">return_date</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">@</span><span class="k">result</span> <span class="k">output</span>
<span class="n">print</span> <span class="o">@</span><span class="k">result</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="ham-function">
<h2>7.2. Hàm (function)<a class="headerlink" href="#ham-function" title="Permalink to this headline">¶</a></h2>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">DROP</span> <span class="k">FUNCTION</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="n">fn_return_date</span>

<span class="k">CREATE</span> <span class="k">FUNCTION</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">fn_return_date</span><span class="p">]</span> <span class="p">(</span><span class="o">@</span><span class="n">no_date</span> <span class="nb">INT</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
<span class="k">RETURNS</span> <span class="nb">INT</span>
<span class="k">AS</span>
<span class="k">BEGIN</span>
    <span class="k">RETURN</span> <span class="p">(</span>
            <span class="k">SELECT</span> <span class="k">cast</span><span class="p">(</span><span class="k">convert</span><span class="p">(</span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="n">getdate</span><span class="p">()</span> <span class="o">-</span> <span class="o">@</span><span class="n">no_date</span><span class="p">,</span> <span class="mi">112</span><span class="p">)</span> <span class="k">AS</span> <span class="nb">INT</span><span class="p">)</span>
            <span class="p">)</span>
<span class="k">END</span><span class="p">;</span>

<span class="c1">-- Cách 1</span>
<span class="k">declare</span> <span class="o">@</span><span class="k">result</span> <span class="nb">int</span>
<span class="k">select</span> <span class="o">@</span><span class="k">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">fn_return_date</span><span class="p">](</span><span class="mi">4</span><span class="p">)</span>
<span class="n">print</span> <span class="o">@</span><span class="k">result</span>

<span class="c1">-- Cách 2</span>
<span class="k">declare</span> <span class="o">@</span><span class="k">result</span> <span class="nb">int</span>
<span class="k">set</span> <span class="o">@</span><span class="k">result</span> <span class="o">=</span> <span class="p">([</span><span class="n">dbo</span><span class="p">].[</span><span class="n">fn_return_date</span><span class="p">](</span><span class="mi">4</span><span class="p">))</span>
<span class="n">print</span> <span class="o">@</span><span class="k">result</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="cac-nhom-cau-lenh-nang-cao">
<h1>8. Các nhóm câu lệnh nâng cao<a class="headerlink" href="#cac-nhom-cau-lenh-nang-cao" title="Permalink to this headline">¶</a></h1>
<div class="section" id="if-else">
<h2>8.1. If…Else<a class="headerlink" href="#if-else" title="Permalink to this headline">¶</a></h2>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="mi">1</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">begin</span>
<span class="n">print</span> <span class="s1">&#39;wrong&#39;</span>
<span class="n">print</span> <span class="s1">&#39;not sure&#39;</span>
<span class="k">end</span>
<span class="k">else</span>
<span class="k">begin</span>
<span class="n">print</span> <span class="s1">&#39;right&#39;</span>
<span class="n">print</span> <span class="s1">&#39;absolutely right&#39;</span>
</pre></div>
</div>
<p><strong>Lưu ý</strong>: Sau mệnh đề else, if, nếu có nhiều câu lệnh cùng thực hiện,
cần khai báo begin…end</p>
</div>
<div class="section" id="check-dieu-kien-de-thuc-thi-tiep">
<h2>8.2. Check điều kiện để thực thi tiếp<a class="headerlink" href="#check-dieu-kien-de-thuc-thi-tiep" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Kiểm tra điều kiện tồn tại của bảng</li>
<li>Nếu tồn tại, chạy tiếp</li>
<li>Nếu không tồn tại, skip các câu lệnh tiếp theo</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">--SQL CMD</span>
<span class="p">:</span><span class="k">on</span> <span class="n">error</span> <span class="n">exit</span>

<span class="k">declare</span> <span class="o">@</span><span class="n">tbl</span> <span class="n">sysname</span>
<span class="k">set</span> <span class="o">@</span><span class="n">tbl</span> <span class="o">=</span> <span class="s1">&#39;TBL_I2B_USERS_F0_20180502&#39;</span>

<span class="k">IF</span> <span class="k">NOT</span> <span class="k">EXISTS</span> <span class="p">(</span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">ANHNT67</span><span class="p">.</span><span class="n">DBS_DAILY</span><span class="p">.</span><span class="n">DBO</span><span class="p">.</span><span class="n">SYSOBJECTS</span>
                <span class="k">WHERE</span> <span class="n">NAME</span> <span class="o">=</span> <span class="o">@</span><span class="n">tbl</span><span class="p">)</span>
<span class="k">BEGIN</span>
<span class="n">raiserror</span><span class="p">(</span><span class="s1">&#39;Table does not exist&#39;</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">print</span><span class="p">(</span><span class="o">@</span><span class="n">tbl</span><span class="p">)</span>
<span class="k">return</span>
<span class="k">END</span>

<span class="k">EXEC</span><span class="p">(</span><span class="s1">&#39;select top 10 * FROM ANHNT67.DBS_DAILY.DBO.&#39;</span> <span class="o">+</span> <span class="o">@</span><span class="n">tbl</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="vong-lap-voi-bang">
<h2>8.3. Vòng lặp với bảng<a class="headerlink" href="#vong-lap-voi-bang" title="Permalink to this headline">¶</a></h2>
<p>SQL chỉ chạy được vòng lặp <code class="docutils literal notranslate"><span class="pre">WHILE</span></code></p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">DROP</span> <span class="k">FUNCTION</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="n">fn_return_date</span>

<span class="k">CREATE</span> <span class="k">FUNCTION</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">fn_return_date</span><span class="p">]</span> <span class="p">(</span><span class="o">@</span><span class="n">no_date</span> <span class="nb">INT</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
<span class="k">RETURNS</span> <span class="nb">INT</span>
<span class="k">AS</span>
<span class="k">BEGIN</span>
    <span class="k">RETURN</span> <span class="p">(</span>
            <span class="k">SELECT</span> <span class="k">cast</span><span class="p">(</span><span class="k">convert</span><span class="p">(</span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="n">getdate</span><span class="p">()</span> <span class="o">-</span> <span class="o">@</span><span class="n">no_date</span><span class="p">,</span> <span class="mi">112</span><span class="p">)</span> <span class="k">AS</span> <span class="nb">INT</span><span class="p">)</span>
            <span class="p">)</span>
<span class="k">END</span><span class="p">;</span>

<span class="k">declare</span> <span class="o">@</span><span class="k">result</span> <span class="nb">int</span>
<span class="k">select</span> <span class="o">@</span><span class="k">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">fn_return_date</span><span class="p">](</span><span class="mi">4</span><span class="p">)</span>
<span class="n">print</span> <span class="o">@</span><span class="k">result</span>

<span class="k">drop</span> <span class="k">table</span> <span class="k">if</span> <span class="k">exists</span> <span class="o">#</span><span class="n">temp</span>
<span class="k">create</span> <span class="k">table</span> <span class="o">#</span><span class="n">temp</span> <span class="p">(</span><span class="nb">date</span> <span class="nb">int</span><span class="p">)</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="o">#</span><span class="n">temp</span>

<span class="k">insert</span> <span class="k">into</span> <span class="o">#</span><span class="n">temp</span> <span class="p">(</span><span class="nb">date</span><span class="p">)</span>
<span class="k">select</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">fn_return_date</span><span class="p">](</span><span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="nb">date</span>
<span class="k">insert</span> <span class="k">into</span> <span class="o">#</span><span class="n">temp</span> <span class="p">(</span><span class="nb">date</span><span class="p">)</span>
<span class="k">select</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">fn_return_date</span><span class="p">](</span><span class="mi">2</span><span class="p">)</span> <span class="k">as</span> <span class="nb">date</span>
<span class="k">insert</span> <span class="k">into</span> <span class="o">#</span><span class="n">temp</span> <span class="p">(</span><span class="nb">date</span><span class="p">)</span>
<span class="k">select</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">fn_return_date</span><span class="p">](</span><span class="mi">3</span><span class="p">)</span> <span class="k">as</span> <span class="nb">date</span>

<span class="k">drop</span> <span class="k">table</span> <span class="k">if</span> <span class="k">exists</span> <span class="o">#</span><span class="n">temp2</span>
<span class="k">select</span> <span class="o">*</span>
<span class="k">into</span> <span class="o">#</span><span class="n">temp2</span>
<span class="k">from</span> <span class="o">#</span><span class="n">temp</span>

<span class="k">alter</span> <span class="k">table</span> <span class="o">#</span><span class="n">temp2</span>
<span class="k">add</span> <span class="k">new</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>

<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="o">#</span><span class="n">temp2</span>

<span class="k">update</span> <span class="o">#</span><span class="n">temp2</span>
<span class="k">set</span> <span class="k">new</span> <span class="o">=</span> <span class="k">cast</span><span class="p">(</span><span class="nb">date</span> <span class="k">as</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;abc&#39;</span>


<span class="c1">--Reference</span>
<span class="k">drop</span> <span class="k">table</span> <span class="k">if</span> <span class="k">exists</span> <span class="o">#</span><span class="k">ref</span>

<span class="k">create</span> <span class="k">table</span> <span class="o">#</span><span class="k">ref</span> <span class="p">(</span>
<span class="p">[</span><span class="k">index</span><span class="p">]</span> <span class="nb">int</span> <span class="k">identity</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>
<span class="p">[</span><span class="nb">date</span><span class="p">]</span> <span class="nb">int</span>
<span class="p">)</span>

<span class="k">insert</span> <span class="k">into</span> <span class="o">#</span><span class="k">ref</span> <span class="p">(</span><span class="nb">date</span><span class="p">)</span>
<span class="k">select</span> <span class="p">[</span><span class="nb">date</span><span class="p">]</span> <span class="k">from</span> <span class="o">#</span><span class="n">temp</span> <span class="k">order</span> <span class="k">by</span> <span class="p">[</span><span class="nb">date</span><span class="p">]</span>

<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="o">#</span><span class="k">ref</span>

<span class="c1">-- VERSION 1: DOES NOT WORK</span>

<span class="k">declare</span> <span class="o">@</span><span class="n">loopcounter</span> <span class="nb">int</span><span class="p">,</span> <span class="o">@</span><span class="n">maxcounter</span> <span class="nb">int</span>
<span class="k">set</span> <span class="o">@</span><span class="n">loopcounter</span> <span class="o">=</span> <span class="p">(</span><span class="k">select</span> <span class="k">min</span><span class="p">(</span><span class="nb">date</span><span class="p">)</span> <span class="k">from</span> <span class="o">#</span><span class="n">temp2</span><span class="p">)</span>
<span class="k">set</span> <span class="o">@</span><span class="n">maxcounter</span> <span class="o">=</span> <span class="p">(</span><span class="k">select</span> <span class="k">max</span><span class="p">(</span><span class="nb">date</span><span class="p">)</span> <span class="k">from</span> <span class="o">#</span><span class="n">temp2</span><span class="p">)</span>

<span class="n">while</span> <span class="p">(</span><span class="o">@</span><span class="n">loopcounter</span> <span class="o">&lt;=</span> <span class="o">@</span><span class="n">maxcounter</span><span class="p">)</span>
<span class="k">begin</span>
    <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="o">#</span><span class="n">temp2</span> <span class="k">where</span>
    <span class="nb">date</span> <span class="o">=</span> <span class="o">@</span><span class="n">loopcounter</span>
    <span class="k">set</span> <span class="o">@</span><span class="n">loopcounter</span> <span class="o">=</span> <span class="o">@</span><span class="n">loopcounter</span> <span class="o">+</span> <span class="mi">1</span>
<span class="k">end</span>


<span class="c1">-- VERSION 2: WORK WELL</span>
<span class="k">drop</span> <span class="k">table</span> <span class="k">if</span> <span class="k">exists</span> <span class="o">#</span><span class="k">result</span>
<span class="k">create</span> <span class="k">table</span> <span class="o">#</span><span class="k">result</span> <span class="p">(</span><span class="nb">date</span> <span class="nb">int</span><span class="p">,</span> <span class="k">new</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>
<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="o">#</span><span class="k">result</span>

<span class="k">declare</span> <span class="o">@</span><span class="n">loopcounter</span> <span class="nb">int</span><span class="p">,</span> <span class="o">@</span><span class="n">maxcounter</span> <span class="nb">int</span>
<span class="k">set</span> <span class="o">@</span><span class="n">loopcounter</span> <span class="o">=</span> <span class="p">(</span><span class="k">select</span> <span class="k">min</span><span class="p">([</span><span class="k">index</span><span class="p">])</span> <span class="k">from</span> <span class="o">#</span><span class="k">ref</span><span class="p">)</span>
<span class="k">set</span> <span class="o">@</span><span class="n">maxcounter</span> <span class="o">=</span> <span class="p">(</span><span class="k">select</span> <span class="k">max</span><span class="p">([</span><span class="k">index</span><span class="p">])</span> <span class="k">from</span> <span class="o">#</span><span class="k">ref</span><span class="p">)</span>

<span class="n">while</span> <span class="p">(</span><span class="o">@</span><span class="n">loopcounter</span> <span class="o">&lt;=</span> <span class="o">@</span><span class="n">maxcounter</span><span class="p">)</span>
<span class="k">begin</span>
    <span class="k">declare</span> <span class="o">@</span><span class="nb">date</span> <span class="nb">int</span>
    <span class="k">set</span> <span class="o">@</span><span class="nb">date</span> <span class="o">=</span> <span class="p">(</span><span class="k">select</span> <span class="p">[</span><span class="nb">date</span><span class="p">]</span> <span class="k">from</span> <span class="o">#</span><span class="k">ref</span> <span class="k">where</span> <span class="p">[</span><span class="k">index</span><span class="p">]</span> <span class="o">=</span> <span class="o">@</span><span class="n">loopcounter</span><span class="p">)</span>

    <span class="k">insert</span> <span class="k">into</span> <span class="o">#</span><span class="k">result</span> <span class="p">([</span><span class="nb">date</span><span class="p">],</span> <span class="k">new</span><span class="p">)</span>
    <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="o">#</span><span class="n">temp2</span> <span class="k">where</span>
    <span class="p">[</span><span class="nb">date</span><span class="p">]</span> <span class="o">=</span> <span class="o">@</span><span class="nb">date</span>
    <span class="k">set</span> <span class="o">@</span><span class="n">loopcounter</span> <span class="o">=</span> <span class="o">@</span><span class="n">loopcounter</span> <span class="o">+</span> <span class="mi">1</span>
<span class="k">end</span>

<span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="o">#</span><span class="k">result</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="dat-job-trong-sql">
<h1>9. Đặt job trong SQL<a class="headerlink" href="#dat-job-trong-sql" title="Permalink to this headline">¶</a></h1>
<p>Khi làm việc với SQL, một trong những yêu cầu rất quan trọng là phải tự
động hóa code SQL theo thơi gian. Yêu cầu này có thể được xử lý bằng
cách đặt job thông qua các bước lớn sau.</p>
<ul class="simple">
<li>Active email tự động</li>
<li>Đăng ký email</li>
<li>Active SQL Server Agent</li>
<li>Đặt job</li>
</ul>
<div class="section" id="buoc-1-active-email-tu-dong">
<h2>9.1. Bước 1: Active email tự động<a class="headerlink" href="#buoc-1-active-email-tu-dong" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Thực hiện câu lệnh sau trên SQL để active gửi Database Mail. Do khi
cài SQL, mặc định Database mail chưa được active nên khi sử dụng ta
cần active database này</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">sp_configure</span> <span class="s1">&#39;show advanced options&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">GO</span>
<span class="n">RECONFIGURE</span><span class="p">;</span>
<span class="k">GO</span>
<span class="n">sp_configure</span> <span class="s1">&#39;Database Mail XPs&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">GO</span>
<span class="n">RECONFIGURE</span>
<span class="k">GO</span>
</pre></div>
</div>
</div>
<div class="section" id="buoc-2-dang-ki-email-trong-database-mail">
<h2>9.2. Bước 2: Đăng kí email trong Database mail<a class="headerlink" href="#buoc-2-dang-ki-email-trong-database-mail" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Tại màn hình SQL &gt;&gt; Object Explore &gt;&gt; Management &gt;&gt; Database Mail &gt;&gt;
Tick vào Set up database Mail by performing the following tasks &gt;&gt;
Next &gt;&gt; Profile name điền tên id của mình muốn &gt;&gt; Add &gt;&gt; Điền đẩy đủ
thông tin như hình bên dưới với thông tin email &gt;&gt; Next</li>
<li>Mục đích của bước này là sau khi hoàn thành Job ta sẽ có 1 email
thông báo Job đã thành công hoặc gửi thẳng cho client là dữ liệu đã
sẵn sàng để có thể sử dụng</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">ID</span><span class="p">:</span> <span class="n">biccdatamartteam</span><span class="o">@</span><span class="n">hotmail</span><span class="p">.</span><span class="n">com</span>
<span class="n">Pass</span><span class="p">:</span> <span class="n">MrLeo2017</span><span class="o">*</span>
</pre></div>
</div>
<center><p><img alt="Template" src="Images/job_5.png" /></p>
</center><hr class="docutils" />
<center><p><img alt="Template" src="Images/job_5.png" /></p>
</center></div>
<hr class="docutils" />
<div class="section" id="buoc-3-active-sql-server-agent">
<h2>9.3. Bước 3: Active SQL Server Agent<a class="headerlink" href="#buoc-3-active-sql-server-agent" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Tại Object Explore &gt;&gt; Click chuột phải vào SQL Server Agent &gt;&gt; Start</li>
</ul>
</div>
<div class="section" id="buoc-4-dat-job">
<h2>9.4. Bước 4: Đặt Job<a class="headerlink" href="#buoc-4-dat-job" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Chuột phải vào SQL Server Agent &gt;&gt; New &gt;&gt; Điền Name vào mục General
&gt;&gt; Qua mục Steps &gt;&gt; Tạo các bước của Job tại New &gt;&gt; Điền Step Name &gt;&gt;
Paste code automate vào phần Command. Ví dụ có thể sử dụng tại code
bên dưới</li>
</ul>
<center><p><img alt="Template" src="Images/job_5.png" /></p>
</center><hr class="docutils" />
<center><p><img alt="Template" src="Images/job_5.png" /></p>
</center><hr class="docutils" />
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">IF</span> <span class="k">EXISTS</span> <span class="p">(</span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="p">[</span><span class="n">BA</span><span class="p">].[</span><span class="n">INFORMATION_SCHEMA</span><span class="p">].[</span><span class="n">TABLES</span><span class="p">]</span> <span class="k">WHERE</span> <span class="p">[</span><span class="k">TABLE_NAME</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;CREDIT_CARD_TRANSACTION_SUCCESSFUL_MASTER&#39;</span><span class="p">)</span>
<span class="k">DROP</span> <span class="k">TABLE</span> <span class="p">[</span><span class="n">BA</span><span class="p">].[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">CREDIT_CARD_TRANSACTION_SUCCESSFUL_MASTER</span><span class="p">]</span>

<span class="k">EXEC</span><span class="p">(</span><span class="s1">&#39;</span>
<span class="s1">SELECT  ID,</span>
<span class="s1">        YEARMONTH,</span>
<span class="s1">        TARGET_ID,</span>
<span class="s1">        TRANS_DATE,</span>
<span class="s1">        TRANS_CURR,</span>
<span class="s1">        TRANS_AMOUNT_QD,</span>
<span class="s1">        TRANS_DETAILS,</span>
<span class="s1">        MERCHANT_ID,</span>
<span class="s1">        TRANS_CITY,</span>
<span class="s1">        TRANS_COUNTRY,</span>
<span class="s1">        BI_TRANS_TYPE,</span>
<span class="s1">        SIC_CODE,</span>
<span class="s1">        CIF,</span>
<span class="s1">        PRODUCT_DETAIL</span>
<span class="s1">INTO [BA].[dbo].[CREDIT_CARD_TRANSACTION_SUCCESSFUL_MASTER]</span>
<span class="s1">FROM [BA].[dbo].[CREDIT_CARD_TRANSACTION_SUCCESSFUL_2018]</span>
<span class="s1">UNION ALL</span>
<span class="s1">SELECT  ID,</span>
<span class="s1">        YEARMONTH,</span>
<span class="s1">        TARGET_ID,</span>
<span class="s1">        TRANS_DATE,</span>
<span class="s1">        TRANS_CURR,</span>
<span class="s1">        TRANS_AMOUNT_QD,</span>
<span class="s1">        TRANS_DETAILS,</span>
<span class="s1">        MERCHANT_ID,</span>
<span class="s1">        TRANS_CITY,</span>
<span class="s1">        TRANS_COUNTRY,</span>
<span class="s1">        BI_TRANS_TYPE,</span>
<span class="s1">        SIC_CODE,</span>
<span class="s1">        CIF,</span>
<span class="s1">        PRODUCT_DETAIL</span>
<span class="s1">FROM [BA].[dbo].[CREDIT_CARD_TRANSACTION_SUCCESSFUL_2017]</span>
<span class="s1">&#39;</span><span class="p">)</span>

<span class="k">EXEC</span><span class="p">(</span><span class="s1">&#39;</span>
<span class="s1">ALTER TABLE [BA].[dbo].[CREDIT_CARD_TRANSACTION_SUCCESSFUL_MASTER]</span>
<span class="s1">ADD SIC_ID VARCHAR(MAX), MCC_CATEGORY VARCHAR(MAX), MCC_CATEGORY_AIA VARCHAR(MAX)</span>
<span class="s1">&#39;</span><span class="p">)</span>

<span class="k">EXEC</span><span class="p">(</span><span class="s1">&#39;</span>
<span class="s1">UPDATE [BA].[dbo].[CREDIT_CARD_TRANSACTION_SUCCESSFUL_MASTER]</span>
<span class="s1">SET SIC_ID = A.SIC_CODE collate database_default,</span>
<span class="s1">    MCC_CATEGORY = A.CATEGORIES</span>
<span class="s1">FROM [BA].[dbo].[MCC_CATEGORY_20170808] A</span>
<span class="s1">WHERE [BA].[dbo].[CREDIT_CARD_TRANSACTION_SUCCESSFUL_MASTER].SIC_CODE = A.SIC_ID</span>

<span class="s1">UPDATE [BA].[dbo].[CREDIT_CARD_TRANSACTION_SUCCESSFUL_MASTER]</span>
<span class="s1">SET MCC_CATEGORY_AIA = A.MCC_CATEGORY</span>
<span class="s1">FROM [BA].[dbo].[MCC_CATEGORY_AIA_20180307] A</span>
<span class="s1">WHERE [BA].[dbo].[CREDIT_CARD_TRANSACTION_SUCCESSFUL_MASTER].SIC_CODE = A.SIC_ID</span>
<span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li>Tạo bước gửi email đến Client &gt;&gt; Đặt tên là SUCCESSFUL JOB &gt;&gt; ta làm
tương tự các bước như trên với code trong mục command như sau.</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">USE</span> <span class="p">[</span><span class="n">msdb</span><span class="p">]</span>
<span class="k">DECLARE</span> <span class="o">@</span><span class="n">REPORT_DATE</span> <span class="nb">DATE</span> <span class="o">=</span> <span class="p">(</span><span class="k">select</span> <span class="k">MAX</span><span class="p">(</span><span class="n">TRANS_DATE</span><span class="p">)</span> <span class="k">from</span>  <span class="n">BA</span><span class="p">..</span><span class="n">CREDIT_CARD_TRANSACTION_SUCCESSFUL_MASTER</span><span class="p">);</span>
<span class="k">DECLARE</span> <span class="o">@</span><span class="n">SUBJECT</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">250</span><span class="p">)</span> <span class="o">=</span> <span class="s1">&#39;[JOB DONE] - CREDIT CARD TRANSACTION - &#39;</span><span class="o">+</span><span class="k">convert</span><span class="p">(</span><span class="nb">varchar</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="o">@</span><span class="n">REPORT_DATE</span><span class="p">,</span><span class="mi">112</span><span class="p">);</span>
<span class="k">EXEC</span>
<span class="n">sp_send_dbmail</span>
<span class="o">@</span><span class="n">profile_name</span> <span class="o">=</span><span class="s1">&#39;thanh&#39;</span><span class="p">,</span>
<span class="o">@</span><span class="n">recipients</span> <span class="o">=</span><span class="s1">&#39;thanhnm3@vpbank.com.vn; truongnh3@vpbank.com.vn; lambt1@vpbank.com.vn&#39;</span><span class="p">,</span>
<span class="o">@</span><span class="n">subject</span> <span class="o">=</span> <span class="o">@</span><span class="n">SUBJECT</span><span class="p">,</span>
<span class="o">@</span><span class="n">body</span> <span class="o">=</span><span class="n">N</span><span class="s1">&#39;CREDIT CARD TRANSACTION IS AVAILABLE&#39;</span><span class="p">,</span>
<span class="o">@</span><span class="n">execute_query_database</span> <span class="o">=</span><span class="s1">&#39;msdb&#39;</span>
</pre></div>
</div>
<ul class="simple">
<li>Tạo bước gửi email đến chính mình khi JOB bị failed &gt;&gt; Đặt tên là
FAILED JOB &gt;&gt; ta làm tương tự các bước như trên với code trong mục
command như sau.</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">USE</span> <span class="p">[</span><span class="n">msdb</span><span class="p">]</span>
<span class="k">DECLARE</span> <span class="o">@</span><span class="n">REPORT_DATE</span> <span class="nb">DATE</span> <span class="o">=</span> <span class="p">(</span><span class="k">select</span> <span class="k">MAX</span><span class="p">(</span><span class="n">TRANS_DATE</span><span class="p">)</span> <span class="k">from</span>  <span class="n">BA</span><span class="p">..</span><span class="n">CREDIT_CARD_TRANSACTION_SUCCESSFUL_MASTER</span><span class="p">);</span>
<span class="k">DECLARE</span> <span class="o">@</span><span class="n">SUBJECT</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">250</span><span class="p">)</span> <span class="o">=</span> <span class="s1">&#39;[JOB DONE] - CREDIT CARD TRANSACTION - &#39;</span><span class="o">+</span><span class="k">convert</span><span class="p">(</span><span class="nb">varchar</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="o">@</span><span class="n">REPORT_DATE</span><span class="p">,</span><span class="mi">112</span><span class="p">);</span>
<span class="k">EXEC</span>
<span class="n">sp_send_dbmail</span>
<span class="o">@</span><span class="n">profile_name</span> <span class="o">=</span><span class="s1">&#39;thanh&#39;</span><span class="p">,</span>
<span class="o">@</span><span class="n">recipients</span> <span class="o">=</span><span class="s1">&#39;thanhnm3@vpbank.com.vn&#39;</span><span class="p">,</span>
<span class="o">@</span><span class="n">subject</span> <span class="o">=</span> <span class="o">@</span><span class="n">SUBJECT</span><span class="p">,</span>
<span class="o">@</span><span class="n">body</span> <span class="o">=</span><span class="n">N</span><span class="s1">&#39;CREDIT CARD TRANSACTION HAS BEEN FAILED&#39;</span><span class="p">,</span>
<span class="o">@</span><span class="n">execute_query_database</span> <span class="o">=</span><span class="s1">&#39;msdb&#39;</span>
</pre></div>
</div>
<ul class="simple">
<li>Sửa lại cách thức chạy code của các bước &gt;&gt; Double Click vào step 1
&gt;&gt; Chọn Advanced &gt;&gt; Tại On failure action &gt;&gt; Chọn go to FAILED JOB
(step đặt mail báo failed)</li>
</ul>
<center><p><img alt="Template" src="Images/job_5.png" /></p>
</center><hr class="docutils" />
<p><strong>Lưu ý</strong></p>
<ul class="simple">
<li>Code SQL được đưa vào trong JOB cần là code tự động</li>
</ul>
</div>
</div>
<div class="section" id="cac-nhom-cau-lenh-quan-tri">
<h1>10. Các nhóm câu lệnh quản trị<a class="headerlink" href="#cac-nhom-cau-lenh-quan-tri" title="Permalink to this headline">¶</a></h1>
<div class="section" id="tim-kiem-cac-query-dang-chay">
<h2>10.1. Tìm kiếm các query đang chạy<a class="headerlink" href="#tim-kiem-cac-query-dang-chay" title="Permalink to this headline">¶</a></h2>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- Cách 1</span>
<span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">sys</span><span class="p">.</span><span class="n">dm_exec_requests</span>
<span class="k">where</span> <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;running&#39;</span>

<span class="c1">-- Cách 2</span>
<span class="k">exec</span> <span class="n">sp_who</span>
<span class="k">exec</span> <span class="n">sp_who2</span>
<span class="k">exec</span> <span class="n">sp_who3</span>

<span class="c1">-- Cách 3</span>
<span class="k">SELECT</span> <span class="n">sqltext</span><span class="p">.</span><span class="nb">TEXT</span><span class="p">,</span>
<span class="n">req</span><span class="p">.</span><span class="n">session_id</span><span class="p">,</span>
<span class="n">req</span><span class="p">.</span><span class="n">status</span><span class="p">,</span>
<span class="n">req</span><span class="p">.</span><span class="n">start_time</span><span class="p">,</span>
<span class="n">req</span><span class="p">.</span><span class="n">command</span><span class="p">,</span>
<span class="n">req</span><span class="p">.</span><span class="n">cpu_time</span><span class="p">,</span>
<span class="n">req</span><span class="p">.</span><span class="n">total_elapsed_time</span>
<span class="k">FROM</span> <span class="n">sys</span><span class="p">.</span><span class="n">dm_exec_requests</span> <span class="n">req</span>
<span class="k">CROSS</span> <span class="n">APPLY</span> <span class="n">sys</span><span class="p">.</span><span class="n">dm_exec_sql_text</span><span class="p">(</span><span class="n">sql_handle</span><span class="p">)</span> <span class="k">AS</span> <span class="n">sqltext</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="p01-02-tricks-sql.html" class="btn btn-neutral float-right" title="11. Tricks khi dùng với SQL" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral float-left" title="SQL cơ bản" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Anh Hoang Duc

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>