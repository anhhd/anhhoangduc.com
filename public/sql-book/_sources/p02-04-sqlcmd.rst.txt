SQLCMD
======

-  Bật SQLCMD Mode: ``SQL Script >> Query >> SQLCMD Mode``

-  Bật SQLCMD Mode default: Tools >> Options >> Query Execution >>
   SQLCMD Mode

**Chạy script từ script**

.. code:: sql

   :setvar path "F:\OneDrive - VPBank\1. Personal projects\SQL in R\sqlcmd example"

   :r $(path)"\test\test_1.sql"

-  Chạy SQL từ bat

.. code:: sql

   sqlcmd -S HON-BICC-PC0035 -U sa -P 123 -i master.sql -o out.log

-  Đặt job với SQLCMD option

.. code:: sql

   sqlcmd -i "F:/OneDrive - VPBank/1. Personal projects/SQL in R/sqlcmd example/master.sql"

|image0|

SQLCMD là gì?
-------------

CMD
---

CMD (Command Prompt) là một ứng dụng dùng để thực thi các lệnh có sẵn
trong Windows. Những lệnh này được sử dụng trên một giao diện nhập lệnh
thay vì thao tác trực tiếp trên giao diện Windows.

.. figure:: Images/cmd.png
   :alt: GIAO DIỆN CMD

   GIAO DIỆN CMD

.. _sqlcmd-1:

SQLCMD
------

SQLCMD là một công cụ đi kèm với SQL Server, cho phép ta thực hiện :

-  Các câu lệnh truy vấn

-  Stored Procedure

-  Chạy các file SQL Script có sẵn

bằng cách sử dụng các dòng lệnh của ứng dụng CMD.

**Khởi động SQLCMD trong SQL Server :**

|image1|

Các bước :

-  Query

-  SQLCMD Mode

**Sự khác nhau giữa trước và sau khi khởi động SQLCMD trong SQL Server
:**

|image2|

Các dòng lệnh SQLCMD sẽ được bôi nền xám

Các lệnh trong SQLCMD
---------------------

Các lệnh trên nền SQLQuery
~~~~~~~~~~~~~~~~~~~~~~~~~~

:r
^^

**:r** <*filename*>

Mục đích : chạy các file SQL scrip có sẵn

Ví dụ :

|image3|

Lưu ý :

-  Các bảng tạm ở mỗi SQL scrip sẽ được giữ lại trong suốt quá trình
   chạy các SQL scrip

|image4|

:setvar
^^^^^^^

Gồm 2 bước :

-  Tạo biến **:setvar** <*varname*> <*“value”*>

-  Gọi biến **:r $**\ (<*varname*>)

Mục đích :

Ví dụ :

|image5|

:connect
^^^^^^^^

**:connect** <*server_name*> <*[-l timeout]*> <*[-U user_name -P
password]*>

Trong đó :

-  server_name : tên server muốn truy cập

-  l : thời gian để kết nối với server, tính theo (giây), thời gian mặc
   định : 8s

-  U : user name

-  P : password

Mục đích : với những câu lệnh nặng phải query toàn bộ trên 1 server
khác, nên đăng nhập server đó để query vào 1 bảng tạm –> sau đó kéo về
server của mình.

Ví dụ :

|image6|

Lưu ý :

-  Bảng tạm trên server khác cần kéo về có dạng **##**

-  Khi chuyển data về server của mình, không được đóng tab chứa query
   của bảng tạm

Các lệnh trên CmdExec
~~~~~~~~~~~~~~~~~~~~~

Các bước đặt job sử dụng CmdExec
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

|image7|

|image8|

-  B0: Thực hiện đặt job như thông thường tới bước tạo các Step

-  B1: Chọn Type : Operating system (CmdExec)

-  B2: chọn Run as : SQL Server Agent service Account

-  B3: Viết câu lệnh sqlcmd

.. _các-lệnh-trên-cmdexec-1:

Các lệnh trên CmdExec
^^^^^^^^^^^^^^^^^^^^^

Cấu trúc

.. code:: bat

   sqlcmd <[-S server_name]> <[-l timeout]> <[-U user -P password]> <[-d database_name]> <-i "input_file"> <"file"> <[-t query_timeout]> <[-o output_file]>

Trong đó:

``-S`` server name (default : server hiện tại của máy)

``-l`` login timeout (default = 8s)

``-U`` user login

``-P`` password login (-U và -P là 1 cặp đi cùng nhau)

``-d`` use database name (default = master)

``-i`` input file (nếu đường dẫn có khoảng trống thì cần đặt trong "")

``-t`` query timeout (default = n, nếu gán giá trị thì trong khoảng 1 -
65534s)

``-o`` output file, được xuất ra thư mục chứa **input file**, gồm các
định dạng: .log, .doc, .xls

Ví dụ :

|image9|

Tìm hiểu thêm về các lệnh : Trên màn hình cmd, nhập lệnh **sqlcmd -?**

|image10|

Tạo file bat
------------

Mục đích : Có thể nhanh chóng query câu lệnh và xuất dữ liệu

Các bước :

-  Bước 1: Tạo 1 file Text

|image11|

-  Bước 2 : Copy toàn bộ câu lệnh trong CmdExec vào file Text

|image12|

-  Bước 3 : Save as file –> thêm đuôi **.bat** vào tên file

|image13|

-  Bước 4: Double click vào file .bat vừa tạo để chạy câu lệnh

|image14|

.. |image0| image:: Images/job_sqlcmd.png
.. |image1| image:: Images/sqlcmd.png
.. |image2| image:: Images/sqlcmd1.png
.. |image3| image:: Images/1_r.png
.. |image4| image:: Images/1_r2.png
.. |image5| image:: Images/2_setvar.png
.. |image6| image:: Images/3_connect1.png
.. |image7| image:: Images/4_job1.png
.. |image8| image:: Images/4_job2.png
.. |image9| image:: Images/4_job3.png
.. |image10| image:: Images/4_bonus.png
.. |image11| image:: Images/5_bat1.png
.. |image12| image:: Images/5_bat2.png
.. |image13| image:: Images/5_bat3.png
.. |image14| image:: Images/5_bat4.png

